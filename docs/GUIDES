# æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥ä¿®å¤ - å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜ç°è±¡

Stackéƒ¨ç½²åï¼Œæ³¨å†Œç”¨æˆ·æ—¶å‡ºé”™ï¼š
```
æ³¨å†Œç”¨æˆ·æ—¶å‡ºé”™: relation "purchase_orders.users" does not exist
LINE 1: SELECT id FROM purchase_orders.users WHERE email = 'kevin.sh...'
                       ^
```

## ğŸ” æ ¹æœ¬åŸå› 

1. **åˆå§‹åŒ–è„šæœ¬æ²¡æœ‰è¢«æ­£ç¡®æ‰§è¡Œ** - Portainer Stackéƒ¨ç½²æ—¶ï¼Œdocker-entrypoint.shæ²¡æœ‰è¢«æ‰§è¡Œ
2. **æ•°æ®åº“è¿æ¥å»¶è¿Ÿ** - Backendå®¹å™¨åœ¨PostgreSQLå®Œå…¨å°±ç»ªå‰å°±å°è¯•åˆå§‹åŒ–
3. **å¯åŠ¨é¡ºåºé—®é¢˜** - å³ä½¿æœ‰`depends_on`ï¼Œä¹Ÿä¸èƒ½ä¿è¯Databaseå®Œå…¨å°±ç»ª

## âœ… å·²ä¿®å¤çš„å†…å®¹

### 1ï¸âƒ£ åˆ›å»ºç‹¬ç«‹çš„å¯åŠ¨è„šæœ¬ (`docker-entrypoint.sh`)

```bash
#!/bin/bash
set -e

# ç¬¬1æ­¥: æ£€æŸ¥æ•°æ®åº“è¿æ¥
# ç¬¬2æ­¥: ä½¿ç”¨pg_isreadyç­‰å¾…æ•°æ®åº“å°±ç»ªï¼ˆæœ€å¤š60ç§’ï¼‰
# ç¬¬3æ­¥: æ‰§è¡Œinit_db.pyåˆå§‹åŒ–æ•°æ®åº“
# ç¬¬4æ­¥: å¯åŠ¨Flaskåº”ç”¨
```

**ä¼˜ç‚¹**ï¼š
- âœ… è„šæœ¬å¯ä»¥åœ¨ä»»ä½•ç¯å¢ƒè¿è¡Œ
- âœ… è‡ªåŠ¨é‡è¿æ•°æ®åº“
- âœ… æ¸…æ™°çš„å¯åŠ¨æ—¥å¿—

### 2ï¸âƒ£ æ”¹è¿› `init_db.py`

æ·»åŠ é‡è¯•æœºåˆ¶ï¼š
- âœ… æœ€å¤šé‡è¯•5æ¬¡è¿æ¥æ•°æ®åº“
- âœ… æ¯æ¬¡å¤±è´¥åç­‰å¾…5ç§’å†é‡è¯•
- âœ… æ›´è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

### 3ï¸âƒ£ æ›´æ–° `Dockerfile`

```dockerfile
# å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY docker-entrypoint.sh /app/docker-entrypoint.sh
RUN chmod +x /app/docker-entrypoint.sh

# ä½¿ç”¨å¯åŠ¨è„šæœ¬ä½œä¸ºENTRYPOINT
ENTRYPOINT ["/app/docker-entrypoint.sh"]
```

### 4ï¸âƒ£ ä¼˜åŒ– `portainer-stack.yml`

**PostgreSQLå¥åº·æ£€æŸ¥**ï¼š
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U postgres -d purchase_orders"]
  interval: 5s
  timeout: 5s
  retries: 10      # å¢åŠ é‡è¯•æ¬¡æ•°
  start_period: 10s
```

**Backendå¯åŠ¨å»¶è¿Ÿ**ï¼š
```yaml
start_period: 90s  # ç»™init_db.pyå……è¶³æ—¶é—´åˆå§‹åŒ–
```

---

## ğŸš€ ç«‹å³ä¿®å¤æ­¥éª¤

### æ­¥éª¤1: é‡æ–°æ„å»ºé•œåƒ

```bash
# Windows
docker-compose build

# Linux/Mac
docker-compose build
```

**é¢„æœŸè¾“å‡º**ï¼š
```
Building backend
Sending build context to Docker daemon  ...
...
Successfully built xxx
Successfully tagged proto-sap:latest
```

### æ­¥éª¤2: åœæ­¢ç°æœ‰å®¹å™¨

åœ¨Portainerä¸­æˆ–å‘½ä»¤è¡Œï¼š
```bash
docker-compose down
# æˆ–åœ¨Portainer: Stacks â†’ proto-sap â†’ Remove
```

### æ­¥éª¤3: é‡æ–°éƒ¨ç½²Stack

**æ–¹æ¡ˆA: ä½¿ç”¨æœ¬åœ°docker-compose**
```bash
docker-compose up -d
```

**æ–¹æ¡ˆB: ä½¿ç”¨Portainerï¼ˆé‡æ–°ä¸Šä¼ ï¼‰**
1. è¿›å…¥ Stacks
2. ç‚¹å‡» Add Stack
3. ä¸Šä¼ æ›´æ–°åçš„ `portainer-stack.yml`
4. ç‚¹å‡» Deploy

**é¢„æœŸè¾“å‡º**ï¼š
```
Creating proto-sap-db ...
Creating proto-sap-db ... done
Creating proto-sap-backend ...
Creating proto-sap-backend ... done

âœ“ æŸ¥çœ‹æ—¥å¿—
docker logs -f proto-sap-backend
```

### æ­¥éª¤4: éªŒè¯åˆå§‹åŒ–è¿‡ç¨‹

æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼š
```bash
docker logs proto-sap-backend
```

**æ­£å¸¸æ—¥å¿—ç¤ºä¾‹**ï¼š
```
========================================
Proto-SAP åº”ç”¨å¯åŠ¨è„šæœ¬
========================================

ç¬¬1æ­¥: æ£€æŸ¥æ•°æ®åº“è¿æ¥...
æ•°æ®åº“ä¸»æœº: postgres
æ•°æ®åº“å: purchase_orders

ç¬¬2æ­¥: ç­‰å¾…æ•°æ®åº“å°±ç»ªï¼ˆæœ€å¤šç­‰å¾…60ç§’ï¼‰...
âœ“ æ•°æ®åº“è¿æ¥æˆåŠŸ

ç¬¬3æ­¥: åˆå§‹åŒ–æ•°æ®åº“è¡¨...
âœ“ æˆåŠŸåˆ›å»ºpurchase_ordersæ¨¡å¼
âœ“ æˆåŠŸåˆ›å»ºWF Openè¡¨
âœ“ æˆåŠŸåˆ›å»ºWF Closedè¡¨
âœ“ æˆåŠŸåˆ›å»ºNon-WF Openè¡¨
âœ“ æˆåŠŸåˆ›å»ºNon-WF Closedè¡¨
âœ“ æˆåŠŸåˆ›å»ºç”¨æˆ·è¡¨

âœ“ æ‰€æœ‰æ•°æ®åº“å¯¹è±¡åˆ›å»ºå®Œæˆ

ç¬¬4æ­¥: å¯åŠ¨Flaskåº”ç”¨...
åº”ç”¨åœ°å€: http://0.0.0.0:5000
========================================

 * Serving Flask app 'web_app'
 * Debug mode: on
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
```

### æ­¥éª¤5: æµ‹è¯•åº”ç”¨

```bash
# 1. è®¿é—®ä¸»é¡µ
curl http://localhost:5000/
# åº”è¯¥è¿”å›HTMLå†…å®¹

# 2. å°è¯•æ³¨å†Œç”¨æˆ·
curl -X POST http://localhost:5000/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!@#"}'

# 3. åº”è¯¥è¿”å›æˆåŠŸå“åº”ï¼ˆè€Œä¸æ˜¯æ•°æ®åº“è¡¨ä¸å­˜åœ¨é”™è¯¯ï¼‰
```

---

## ğŸ³ Docker Compose ä¿®å¤ç‰ˆæœ¬

å¦‚æœä½¿ç”¨docker-composeè€Œä¸æ˜¯Portainerï¼Œéœ€è¦ç¡®ä¿`docker-compose.yml`ä¹ŸåŒ…å«ç›¸åŒé…ç½®ï¼š

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:15
    container_name: proto-sap-db
    environment:
      POSTGRES_DB: purchase_orders
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pgsql
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d purchase_orders"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    restart: unless-stopped

  backend:
    image: proto-sap:latest
    container_name: proto-sap-backend
    build: .
    environment:
      DB_HOST: postgres
      DB_NAME: purchase_orders
      DB_USER: postgres
      DB_PASSWORD: pgsql
      DB_PORT: 5432
    ports:
      - "5000:5000"
    volumes:
      - ./uploads:/app/uploads
      - ./pdf_samples:/app/pdf_samples
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

volumes:
  postgres_data:
    driver: local
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

| æ–¹é¢ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| åˆå§‹åŒ–è„šæœ¬ | å†…è”åœ¨Dockerfileï¼ˆä¸å¯é ï¼‰ | ç‹¬ç«‹æ–‡ä»¶ï¼ˆå¯å¤ç”¨ï¼‰ |
| æ•°æ®åº“è¿æ¥é‡è¯• | æ— é‡è¯•ï¼Œç›´æ¥å¤±è´¥ | 5æ¬¡é‡è¯•ï¼Œæ¯æ¬¡é—´éš”5ç§’ |
| PostgreSQLæ£€æŸ¥ | `pg_isready -U postgres` | `pg_isready -U postgres -d purchase_orders` |
| åç«¯å¯åŠ¨å»¶è¿Ÿ | 60ç§’ | 90ç§’ |
| åˆå§‹åŒ–å¤±è´¥å¤„ç† | `|| true`ï¼ˆå¿½ç•¥é”™è¯¯ï¼‰ | æ£€æŸ¥è¿”å›å€¼ï¼Œå¤±è´¥æ—¶é€€å‡º |
| å¯åŠ¨æ—¥å¿— | æ— è¯¦ç»†æ—¥å¿— | æ¸…æ™°çš„4æ­¥å¯åŠ¨æ—¥å¿— |

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: æ•°æ®åº“è¿æ¥è¶…æ—¶

**ç—‡çŠ¶**ï¼šå¯åŠ¨æ—¥å¿—æ˜¾ç¤ºä¸€ç›´åœ¨ç­‰å¾…æ•°æ®åº“

**åŸå› **ï¼šPostgreSQLå®¹å™¨å¯åŠ¨è¿‡æ…¢æˆ–æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥PostgreSQLå®¹å™¨
docker ps | grep postgres

# æŸ¥çœ‹PostgreSQLæ—¥å¿—
docker logs proto-sap-db

# æ‰‹åŠ¨æµ‹è¯•è¿æ¥
docker exec proto-sap-db pg_isready -U postgres -d purchase_orders
```

### é—®é¢˜2: init_db.pyå¤±è´¥ä½†ä¸æ˜¾ç¤ºé”™è¯¯

**ç—‡çŠ¶**ï¼šæ—¥å¿—åªæ˜¾ç¤º"æ•°æ®åº“è¿æ¥æˆåŠŸ"ï¼Œç„¶åå¡ä½

**åŸå› **ï¼šè„šæœ¬å¯èƒ½å› ä¸ºå¯¼å…¥é”™è¯¯è€Œå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è¿›å…¥å®¹å™¨æ‰‹åŠ¨è¿è¡Œè„šæœ¬
docker exec -it proto-sap-backend bash
python init_db.py

# æŸ¥çœ‹å…·ä½“é”™è¯¯ä¿¡æ¯
```

### é—®é¢˜3: æ³¨å†Œä»ç„¶æç¤ºè¡¨ä¸å­˜åœ¨

**ç—‡çŠ¶**ï¼šä¿®å¤åä»ç„¶å‡ºç°relationä¸å­˜åœ¨é”™è¯¯

**åŸå› **ï¼šå¯èƒ½æ˜¯ä½¿ç”¨äº†æ—§é•œåƒï¼Œæˆ–åˆå§‹åŒ–çœŸçš„å¤±è´¥äº†

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. é‡æ–°æ„å»ºé•œåƒï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
docker-compose build --no-cache

# 2. åˆ é™¤æ‰€æœ‰å®¹å™¨å’Œæ•°æ®
docker-compose down -v

# 3. é‡æ–°å¯åŠ¨
docker-compose up -d

# 4. ç­‰å¾…2åˆ†é’Ÿåå†æµ‹è¯•
sleep 120
curl http://localhost:5000/api/user/register ...
```

### é—®é¢˜4: å®¹å™¨ä¸€ç›´å¤„äº"Restarting"çŠ¶æ€

**ç—‡çŠ¶**ï¼š`docker ps`æ˜¾ç¤º`Restarting (1) ...`

**åŸå› **ï¼šå¯åŠ¨è„šæœ¬å‡ºé”™ï¼Œå®¹å™¨ä¸æ–­é‡å¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker logs --tail 50 proto-sap-backend

# 2. æŸ¥çœ‹å®¹å™¨æœ€åçš„é”™è¯¯ä¿¡æ¯
docker logs proto-sap-backend 2>&1 | tail -20

# 3. è¿›å…¥PostgreSQLå®¹å™¨æ£€æŸ¥
docker exec -it proto-sap-db psql -U postgres -d purchase_orders -c "\dt purchase_orders.*"
```

---

## âœ… éªŒè¯æ¸…å•

å®Œæ•´éƒ¨ç½²åï¼Œæ£€æŸ¥ä»¥ä¸‹äº‹é¡¹ï¼š

- [ ] Dockeré•œåƒå·²é‡æ–°æ„å»º: `docker images | grep proto-sap`
- [ ] PostgreSQLå®¹å™¨æ­£å¸¸è¿è¡Œ: `docker ps | grep postgres`
- [ ] Backendå®¹å™¨æ­£å¸¸è¿è¡Œ: `docker ps | grep backend`
- [ ] å¯åŠ¨æ—¥å¿—æ˜¾ç¤ºæ‰€æœ‰4ä¸ªæ­¥éª¤å®Œæˆ
- [ ] æ•°æ®åº“è¡¨å·²åˆ›å»º: `docker exec proto-sap-db psql -U postgres -d purchase_orders -c "\dt purchase_orders.*"`
- [ ] Flaskåº”ç”¨å¯è®¿é—®: `curl http://localhost:5000/`
- [ ] ç”¨æˆ·æ³¨å†ŒæˆåŠŸ: è®¿é—® `http://localhost:5000/register.html`

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦é‡æ–°æ„å»ºé•œåƒï¼Ÿ

**A:** å› ä¸ºDockerfileæœ¬èº«è¢«ä¿®æ”¹äº†ï¼Œæ–°çš„å¯åŠ¨è„šæœ¬éœ€è¦è¢«åŒ…å«åœ¨é•œåƒä¸­ã€‚æ—§é•œåƒæ²¡æœ‰è¿™ä¸ªè„šæœ¬ï¼Œæ‰€ä»¥æ— æ³•å·¥ä½œã€‚

### Q2: è¿™ä¸ªä¿®å¤å¯¹å·²æœ‰çš„æ•°æ®æœ‰å½±å“å—ï¼Ÿ

**A:** æ²¡æœ‰ã€‚`CREATE TABLE IF NOT EXISTS`ç¡®ä¿åªæœ‰é¦–æ¬¡åˆ›å»ºæ—¶æ‰ä¼šåˆ›å»ºè¡¨ï¼Œä¸ä¼šè¦†ç›–ç°æœ‰æ•°æ®ã€‚

### Q3: å¯åŠ¨è¦èŠ±å¤šé•¿æ—¶é—´ï¼Ÿ

**A:** æ­£å¸¸æƒ…å†µä¸‹ï¼š
- PostgreSQLå¯åŠ¨ï¼š10-20ç§’
- åˆå§‹åŒ–æ•°æ®åº“ï¼š5-10ç§’
- Flaskåº”ç”¨å¯åŠ¨ï¼š10-20ç§’
- æ€»è®¡ï¼š30-50ç§’

### Q4: èƒ½å¦è·³è¿‡æ•°æ®åº“åˆå§‹åŒ–ï¼Ÿ

**A:** ä¸å»ºè®®ã€‚åˆå§‹åŒ–è„šæœ¬æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼ˆIF NOT EXISTSï¼‰ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸ä¼šé‡å¤åˆ›å»ºã€‚è·³è¿‡å¯èƒ½å¯¼è‡´æ–°éƒ¨ç½²æ—¶è¡¨ä¸å­˜åœ¨ã€‚

### Q5: å¦‚ä½•æ¸…é™¤æ‰€æœ‰æ•°æ®é‡æ–°å¼€å§‹ï¼Ÿ

**A:**
```bash
# åˆ é™¤PostgreSQLæ•°æ®å·
docker-compose down -v

# é‡æ–°å¯åŠ¨ï¼ˆä¼šè‡ªåŠ¨åˆå§‹åŒ–æ•°æ®åº“ï¼‰
docker-compose up -d
```

---

## ğŸš€ å®Œæ•´ä¿®å¤æµç¨‹æ€»ç»“

```bash
# 1. é‡æ–°æ„å»ºé•œåƒ
docker-compose build

# 2. åœæ­¢å¹¶ç§»é™¤æ—§å®¹å™¨
docker-compose down

# 3. å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d

# 4. ç­‰å¾…åˆå§‹åŒ–å®Œæˆï¼ˆ2åˆ†é’Ÿï¼‰
sleep 120

# 5. æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æˆåŠŸ
docker logs proto-sap-backend

# 6. æµ‹è¯•æ³¨å†ŒåŠŸèƒ½
curl -X POST http://localhost:5000/api/user/register \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"Test123!@#"}'

# 7. åº”è¯¥è¿”å› {"success": true} æˆ–ç±»ä¼¼å“åº”
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼š

1. æ£€æŸ¥å¯åŠ¨æ—¥å¿—ï¼š`docker logs -f proto-sap-backend`
2. æ£€æŸ¥æ•°æ®åº“å®¹å™¨ï¼š`docker logs -f proto-sap-db`
3. è¿›å…¥å®¹å™¨è°ƒè¯•ï¼š`docker exec -it proto-sap-backend bash`
4. æŸ¥çœ‹å®Œæ•´çš„è¯Šæ–­ï¼š`bash diagnose-tls-error.sh` æˆ– `diagnose-tls-error.bat`
