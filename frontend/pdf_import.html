<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFé‡‡è´­è®¢å•å¯¼å…¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        
        body {
            padding: 20px;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        .container-fluid {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            color: #1a202c;
            font-weight: 600;
            text-shadow: none;
            margin: 0;
            animation: slideDown 0.5s ease;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: slideDown 0.5s ease;
        }
        
        .header h1 {
            font-size: 2rem;
            margin: 0;
        }
        
        .user-info {
            color: #4a5568;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-info a, .user-info button {
            background: white;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .user-info a:hover, .user-info button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: none;
        }
        
        .container-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            animation: fadeInUp 0.6s ease;
            border: 1px solid #e2e8f0;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .container-card h3 {
            color: #1a202c;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px 30px;
            text-align: center;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(66, 153, 225, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: move 20s linear infinite;
            pointer-events: none;
        }
        
        @keyframes move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }
        
        .upload-area:hover {
            border-color: #4299e1;
            background: #f0f9ff;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.1);
            transform: none;
        }
        
        .upload-area.dragover {
            border-color: #4299e1;
            background: #f0f9ff;
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.15);
        }
        
        .upload-area i {
            color: #4299e1;
            transition: all 0.3s ease;
            font-size: 3rem;
        }
        
        .upload-area:hover i {
            transform: scale(1.1);
            color: #3182ce;
        }
        
        .upload-area h4 {
            color: #2d3748;
            font-weight: 600;
            margin-top: 15px;
        }
        
        .upload-area p {
            color: #718096;
            margin: 10px 0 0 0;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 6px;
            background: #f7fafc;
            padding: 15px;
            border: 1px solid #e2e8f0;
        }
        
        .file-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .file-list::-webkit-scrollbar-track {
            background: #e2e8f0;
            border-radius: 3px;
        }
        
        .file-list::-webkit-scrollbar-thumb {
            background: #a0aec0;
            border-radius: 3px;
        }
        
        .file-list::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
        
        .file-list h5 {
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid transparent;
        }
        
        .success {
            background: #f0fdf4;
            color: #166534;
            border-left-color: #48bb78;
        }
        
        .success::before {
            content: 'âœ“';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .error {
            background: #fef2f2;
            color: #7f1d1d;
            border-left-color: #f56565;
        }
        
        .error::before {
            content: 'âœ•';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .loading {
            background: #f0f9ff;
            color: #0c4a6e;
            border-left-color: #4299e1;
        }
        
        .loading::before {
            content: 'âŸ³';
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .progress-bar-container {
            height: 24px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .progress-bar {
            height: 100%;
            background: #4299e1;
            transition: width 0.3s ease;
            box-shadow: none;
            border-radius: 4px;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            border-radius: 4px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #f7fafc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transform: none;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 10px;
        }
        
        .file-info i {
            color: #4299e1;
            font-size: 1.2rem;
        }
        
        .file-name {
            font-size: 14px;
            color: #2d3748;
            font-weight: 500;
        }
        
        .file-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .status-uploading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-error {
            background: #fee2e2;
            color: #7f1d1d;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background: #4299e1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            transform: none;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.15);
            color: white;
        }
        
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-lg {
            padding: 12px 40px;
            font-size: 1.1rem;
        }
        
        .btn-secondary {
            background: #a0aec0;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #718096;
            transform: none;
            color: white;
            box-shadow: 0 2px 6px rgba(160, 174, 192, 0.15);
        }
        
        .form-select {
            border-radius: 4px;
            border: 1px solid #cbd5e0;
            transition: all 0.3s ease;
            background-color: white;
            color: #2d3748;
        }
        
        .form-select:focus {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .form-label {
            color: #2d3748;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        #fileInput {
            display: none;
        }
        
        .text-end a, .text-end button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .text-end a:hover, .text-end button:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.6);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- æ ‡é¢˜å’Œç”¨æˆ·ä¿¡æ¯åŒºåŸŸ -->
        <div class="header">
            <h1>PDFé‡‡è´­è®¢å•å¯¼å…¥ç³»ç»Ÿ</h1>
            <div class="user-info">
                <span id="currentUser">æœªç™»å½•</span>
                <a href="/register.html" id="registerLink">æ³¨å†Œ</a>
                <a href="/login.html" id="loginLink" style="display: inline-block;">ç™»å½•</a>
                <button id="logoutBtn" style="display: none;">é€€å‡º</button>
            </div>
        </div>
        
        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="mb-3">
            <a href="/" class="btn btn-primary">
                ğŸ“Š æ•°æ®åº“ç®¡ç†
            </a>
            <a href="/pdf_import.html" class="btn btn-secondary">
                ğŸ“¤ PDFå¯¼å…¥
            </a>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯åŒºåŸŸ -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <!-- å…¬å¸é€‰æ‹© -->
        <div class="container-card">
            <h3>é€‰æ‹©å…¬å¸</h3>
            <div class="row">
                <div class="col-md-6">
                    <label for="companySelect" class="form-label">é€‰æ‹©å…¬å¸</label>
                    <select class="form-select" id="companySelect">
                        <option value="">è¯·é€‰æ‹©å…¬å¸</option>
                        <!-- å…¬å¸é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </select>
                </div>
            </div>
        </div>
        
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="container-card">
            <h3>ä¸Šä¼ PDFæ–‡ä»¶</h3>
            <p class="text-muted">æ”¯æŒPDFæ ¼å¼ï¼Œå¯å¤šé€‰</p>
            
            <div id="uploadArea" class="upload-area">
                <h4 class="mt-3">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ–‡ä»¶</h4>
                <p class="text-muted">æ”¯æŒPDFæ ¼å¼ï¼Œå¯å¤šé€‰</p>
                <input type="file" id="fileInput" multiple accept=".pdf" style="margin: 10px auto; display: block;">
            </div>
            
            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div id="fileList" class="file-list mt-3" style="display: none;">
                <h5>å·²é€‰æ‹©çš„æ–‡ä»¶ï¼š</h5>
                <div id="fileListItems"></div>
            </div>
            
            <!-- å¯¼å…¥æŒ‰é’® -->
            <div class="mt-3 text-center">
                <button id="importBtn" class="btn btn-primary btn-lg" onclick="processAndImport()" disabled>
                    ğŸ“¥ å¯¼å…¥PDFæ–‡ä»¶
                </button>
            </div>
        </div>
        
        <!-- å¯¼å…¥è¿›åº¦ -->
        <div id="progressContainer" class="container-card" style="display: none;">
            <h3>å¯¼å…¥è¿›åº¦</h3>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar" style="width: 0%;"></div>
            </div>
            <div id="progressText" class="text-center text-muted">å‡†å¤‡å¯¼å…¥...</div>
        </div>
        
        <!-- å¯¼å…¥ç»“æœ -->
        <div id="resultContainer" class="container-card" style="display: none;">
            <h3>å¯¼å…¥ç»“æœ</h3>
            <div id="resultContent"></div>
            <div class="mt-3">
                <button class="btn btn-secondary" onclick="resetImport()">
                    ğŸ”„ é‡æ–°å¯¼å…¥
                </button>
                <a href="/" class="btn btn-primary">
                    ğŸ“Š æŸ¥çœ‹æ•°æ®åº“
                </a>
            </div>
        </div>
    </div>

    <!-- é‡å¤æ•°æ®ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="duplicateConfirmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ£€æµ‹åˆ°é‡å¤æ•°æ®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ä»¥ä¸‹æ•°æ®çš„ä¸»é”®åœ¨æ•°æ®åº“ä¸­å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦è¦†ç›–åŸæœ‰æ•°æ®ï¼Ÿ</p>
                    <div id="duplicateDataList" class="table-responsive">
                        <!-- é‡å¤æ•°æ®åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="confirmOverwriteBtn">ç¡®è®¤è¦†ç›–</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!checkLoginStatus()) {
            // å¦‚æœæœªç™»å½•ï¼Œé˜»æ­¢é¡µé¢ç»§ç»­åŠ è½½
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>è¯·å…ˆç™»å½•</h2><p>æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...</p></div>';
            });
        }
        
        // å…¨å±€å˜é‡
        let currentFiles = [];
        let uploadedFiles = []; // ç”¨äºå­˜å‚¨å·²ä¸Šä¼ çš„æ–‡ä»¶å†å²è®°å½•
        let isFileInputClick = false; // ç”¨äºé˜²æ­¢é‡å¤è§¦å‘çš„æ ‡å¿—ä½
        let pendingImportData = null; // ç”¨äºå­˜å‚¨å¾…å¯¼å…¥çš„æ•°æ®
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            if (!checkLoginStatus()) {
                return;
            }
            
            // æ˜¾ç¤ºå½“å‰ç”¨æˆ·
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.email;
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('loginLink').style.display = 'none';
                document.getElementById('registerLink').style.display = 'none';
            }
            
            // åŠ è½½å…¬å¸åˆ—è¡¨
            loadCompanyList();
            
            // è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
            setupFileUpload();
            
            // è®¾ç½®ç¡®è®¤è¦†ç›–æŒ‰é’®äº‹ä»¶
            document.getElementById('confirmOverwriteBtn').addEventListener('click', confirmOverwrite);
            
            // æ·»åŠ é€€å‡ºæŒ‰é’®äº‹ä»¶ç›‘å¬
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('currentUser');
                window.location.href = '/login.html';
            });
        });
        
        // å¸¦è®¤è¯çš„fetchå‡½æ•°
        function authenticatedFetch(url, options = {}) {
            // è·å–å­˜å‚¨çš„token
            const token = localStorage.getItem('authToken');
            if (!token) {
                // å¦‚æœæ²¡æœ‰tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login.html';
                throw new Error('æœªç™»å½•');
            }
            
            // æ·»åŠ è®¤è¯å¤´
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // æ·»åŠ ç”¨æˆ·é‚®ç®±å¤´
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                options.headers['X-User-Email'] = currentUser.email;
            }
            
            return fetch(url, options)
                .then(response => {
                    if (response.status === 401) {
                        // Tokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                        throw new Error('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    return response;
                })
                .catch(error => {
                    if (error.message === 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•') {
                        throw error;
                    }
                    // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                    throw error;
                });
        }
        
        // åŠ è½½å…¬å¸åˆ—è¡¨
        function loadCompanyList() {
            // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„APIæ¥è·å–å…¬å¸åˆ—è¡¨
            // æš‚æ—¶ä½¿ç”¨ç¡¬ç¼–ç çš„å…¬å¸åˆ—è¡¨
            const companies = ['wefabricate', 'centurion', 'magic_fx'];
            const select = document.getElementById('companySelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸</option>';
            
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                select.appendChild(option);
            });
        }
        
        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ äº‹ä»¶
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // ç§»é™¤ç‚¹å‡»ä¸Šä¼ åŒºåŸŸçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤è§¦å‘é—®é¢˜
            // ç”¨æˆ·å¯ä»¥ç›´æ¥ç‚¹å‡»æ–‡ä»¶è¾“å…¥æ¡†æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°ä¸Šä¼ åŒºåŸŸ
            
            // æ–‡ä»¶é€‰æ‹©å˜åŒ–æ—¶å¤„ç†æ–‡ä»¶
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ‹½ä¸Šä¼ äº‹ä»¶
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length) {
                    handleFiles(e.dataTransfer.files);
                }
            });
        }
        
        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFileSelect(e) {
            handleFiles(e.target.files);
            // æ¸…ç©ºæ–‡ä»¶è¾“å…¥æ¡†ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
            e.target.value = '';
        }
        
        // å¤„ç†æ–‡ä»¶
        function handleFiles(files) {
            // å°†æ–°æ–‡ä»¶æ·»åŠ åˆ°å½“å‰æ–‡ä»¶åˆ—è¡¨ä¸­
            const newFiles = Array.from(files);
            currentFiles = currentFiles.concat(newFiles);
            updateFileList();
            
            // å¯ç”¨å¯¼å…¥æŒ‰é’®
            if (currentFiles.length > 0) {
                document.getElementById('importBtn').disabled = false;
            } else {
                document.getElementById('importBtn').disabled = true;
            }
        }
        
        // åˆ é™¤æ–‡ä»¶
        function removeFile(index) {
            currentFiles.splice(index, 1);
            updateFileList();
            
            // æ›´æ–°å¯¼å…¥æŒ‰é’®çŠ¶æ€
            if (currentFiles.length > 0) {
                document.getElementById('importBtn').disabled = false;
            } else {
                document.getElementById('importBtn').disabled = true;
            }
        }
        
        // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileListItems = document.getElementById('fileListItems');
            
            // æ¸…ç©ºç°æœ‰åˆ—è¡¨
            fileListItems.innerHTML = '';
            
            if (currentFiles.length > 0) {
                fileList.style.display = 'block';
                
                currentFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            ğŸ“„
                            <span class="file-name">${file.name}</span>
                        </div>
                        <div>
                            <span class="file-status status-pending">å¾…å¤„ç†</span>
                            <button class="btn btn-sm btn-outline-danger ms-2" onclick="removeFile(${index})" title="åˆ é™¤æ–‡ä»¶">
                                âœ•
                            </button>
                        </div>
                    `;
                    fileListItems.appendChild(fileItem);
                });
            } else {
                fileList.style.display = 'none';
            }
        }
        
        // å¤„ç†å¹¶å¯¼å…¥æ•°æ®
        function processAndImport() {
            const company = document.getElementById('companySelect').value;
            if (!company) {
                showStatus('è¯·é€‰æ‹©å…¬å¸', 'error');
                return;
            }
            
            if (currentFiles.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶...', 'loading');
            document.getElementById('importBtn').disabled = true;
            
            // é€ä¸ªå¤„ç†æ–‡ä»¶
            processFilesSequentially(0, company);
        }
        
        // é€ä¸ªå¤„ç†æ–‡ä»¶
        function processFilesSequentially(index, company) {
            if (index >= currentFiles.length) {
                // æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆ
                showStatus(`å¤„ç†å®Œæˆï¼æˆåŠŸå¤„ç† ${currentFiles.length} ä¸ªæ–‡ä»¶`, 'success');
                document.getElementById('importBtn').disabled = false;
                
                // æ¸…ç©ºå½“å‰æ–‡ä»¶åˆ—è¡¨
                currentFiles = [];
                updateFileList();
                return;
            }
            
            const file = currentFiles[index];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('company', company);
            
            // æ›´æ–°æ–‡ä»¶çŠ¶æ€
            const fileItems = document.querySelectorAll('.file-item');
            if (fileItems[index]) {
                fileItems[index].querySelector('.file-status').className = 'file-status status-uploading';
                fileItems[index].querySelector('.file-status').textContent = 'å¤„ç†ä¸­...';
            }
            
            // å‘é€æ–‡ä»¶å¤„ç†è¯·æ±‚
            authenticatedFetch('/api/process_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤æ•°æ®
                    if (data.duplicates && data.duplicates.length > 0) {
                        // æ˜¾ç¤ºé‡å¤æ•°æ®ç¡®è®¤å¯¹è¯æ¡†
                        showDuplicateConfirmDialog(data.duplicates, data.data, data.table_name, index, company);
                    } else {
                        // æ²¡æœ‰é‡å¤æ•°æ®ï¼Œç›´æ¥æ’å…¥
                        insertData(data.data, data.table_name, index, company);
                    }
                } else {
                    // å¤„ç†å¤±è´¥
                    if (fileItems[index]) {
                        fileItems[index].querySelector('.file-status').className = 'file-status status-error';
                        fileItems[index].querySelector('.file-status').textContent = 'å¤„ç†å¤±è´¥';
                    }
                    showStatus(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${data.error}`, 'error');
                    document.getElementById('importBtn').disabled = false;
                }
            })
            .catch(error => {
                if (fileItems[index]) {
                    fileItems[index].querySelector('.file-status').className = 'file-status status-error';
                    fileItems[index].querySelector('.file-status').textContent = 'å¤„ç†å¤±è´¥';
                }
                showStatus(`å¤„ç†æ–‡ä»¶ ${file.name} æ—¶å‡ºé”™: ${error}`, 'error');
                document.getElementById('importBtn').disabled = false;
            });
        }
        
        // æ˜¾ç¤ºé‡å¤æ•°æ®ç¡®è®¤å¯¹è¯æ¡†
        function showDuplicateConfirmDialog(duplicates, allData, tableName, fileIndex, company) {
            // ä¿å­˜æ•°æ®ç”¨äºåç»­å¤„ç†
            pendingImportData = {
                allData: allData,
                tableName: tableName,
                fileIndex: fileIndex,
                company: company
            };
            
            // ç”Ÿæˆé‡å¤æ•°æ®åˆ—è¡¨
            const duplicateList = document.getElementById('duplicateDataList');
            let html = '<table class="table table-striped table-bordered">';
            html += '<thead><tr><th>ä¸»é”®</th><th>æè¿°</th><th>æ•°é‡</th><th>å•ä»·</th><th>æ€»ä»·</th></tr></thead><tbody>';
            
            duplicates.forEach(dup => {
                const data = dup.data;
                html += '<tr>';
                html += `<td>${dup.primary_key}</td>`;
                html += `<td>${data.description || ''}</td>`;
                html += `<td>${data.qty || ''}</td>`;
                html += `<td>${data.net_price || ''}</td>`;
                html += `<td>${data.total_price || ''}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            duplicateList.innerHTML = html;
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('duplicateConfirmModal'));
            modal.show();
        }
        
        // ç¡®è®¤è¦†ç›–é‡å¤æ•°æ®
        function confirmOverwrite() {
            // å…³é—­æ¨¡æ€æ¡†
            bootstrap.Modal.getInstance(document.getElementById('duplicateConfirmModal')).hide();
            
            // æ’å…¥æ•°æ®
            if (pendingImportData) {
                insertData(pendingImportData.allData, pendingImportData.tableName, pendingImportData.fileIndex, pendingImportData.company);
                pendingImportData = null;
            }
        }
        
        // æ’å…¥æ•°æ®
        // æ’å…¥æ•°æ®ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        function insertData(data, tableName, fileIndex, company) {
            const maxRetries = 3;
            const retryDelay = 1000;  // 1ç§’åé‡è¯•
            
            function attemptInsert(retryCount = 0) {
                console.log(`æ’å…¥æ•°æ® - å°è¯• ${retryCount + 1}/${maxRetries}`);
                
                // âœ… ç¡®ä¿æ‰€æœ‰æ•°æ®éƒ½åŒ…å«companyå­—æ®µ
                const dataWithCompany = data.map(item => ({
                    ...item,
                    company: company
                }));
                
                console.log(`æ•°æ®è¡Œæ•°: ${dataWithCompany.length}, å…¬å¸: ${company}`);
                
                authenticatedFetch(`/api/insert_data/${tableName}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ data: dataWithCompany })
                })
                .then(response => {
                    // æ£€æŸ¥HTTPçŠ¶æ€
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    const fileItems = document.querySelectorAll('.file-item');
                    if (result.success) {
                        if (fileItems[fileIndex]) {
                            fileItems[fileIndex].querySelector('.file-status').className = 'file-status status-success';
                            fileItems[fileIndex].querySelector('.file-status').textContent = 'å¤„ç†å®Œæˆ';
                        }
                        showStatus(`æ–‡ä»¶å¤„ç†å®Œæˆï¼ŒæˆåŠŸæ’å…¥ ${result.count} æ¡æ•°æ®`, 'success');
                        
                        // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
                        setTimeout(() => {
                            processFilesSequentially(fileIndex + 1, company);
                        }, 1000);
                    } else {
                        if (fileItems[fileIndex]) {
                            fileItems[fileIndex].querySelector('.file-status').className = 'file-status status-error';
                            fileItems[fileIndex].querySelector('.file-status').textContent = 'æ’å…¥å¤±è´¥';
                        }
                        showStatus(`æ’å…¥æ•°æ®æ—¶å‡ºé”™: ${result.error}`, 'error');
                        document.getElementById('importBtn').disabled = false;
                    }
                })
                .catch(error => {
                    console.error(`æ’å…¥å¤±è´¥ (å°è¯• ${retryCount + 1}):`, error);
                    const fileItems = document.querySelectorAll('.file-item');
                    
                    // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Œåˆ™é‡è¯•
                    if (retryCount < maxRetries - 1 && 
                        (error.message.includes('Failed to fetch') || 
                         error.message.includes('ERR_EMPTY_RESPONSE') ||
                         error.message.includes('HTTP 5'))) {
                        console.log(`${retryDelay}ms åè¿›è¡Œç¬¬ ${retryCount + 2} æ¬¡å°è¯•...`);
                        showStatus(`è¿æ¥è¶…æ—¶ï¼Œ${retryDelay/1000}ç§’åè‡ªåŠ¨é‡è¯•... (${retryCount + 1}/${maxRetries - 1})`, 'warning');
                        
                        setTimeout(() => {
                            attemptInsert(retryCount + 1);
                        }, retryDelay);
                    } else {
                        // å…¨éƒ¨é‡è¯•å¤±è´¥æˆ–å…¶ä»–é”™è¯¯
                        if (fileItems[fileIndex]) {
                            fileItems[fileIndex].querySelector('.file-status').className = 'file-status status-error';
                            fileItems[fileIndex].querySelector('.file-status').textContent = 'æ’å…¥å¤±è´¥';
                        }
                        const errorMsg = retryCount >= maxRetries - 1 
                            ? `${maxRetries}æ¬¡å°è¯•åä»ç„¶å¤±è´¥: ${error.message}`
                            : error.message;
                        showStatus(`æ’å…¥æ•°æ®æ—¶å‡ºé”™: ${errorMsg}`, 'error');
                        document.getElementById('importBtn').disabled = false;
                    }
                });
            }
            
            // å¼€å§‹ç¬¬ä¸€æ¬¡å°è¯•
            attemptInsert(0);
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
            
            // 3ç§’åè‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
            if (type === 'success') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 3000);
            }
        }
        
        // éšè—çŠ¶æ€æ¶ˆæ¯
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
        }
        
        // é‡ç½®å¯¼å…¥
        function resetImport() {
            // éšè—ç»“æœå®¹å™¨
            document.getElementById('resultContainer').style.display = 'none';
            
            // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨
            currentFiles = [];
            updateFileList();
            
            // é‡ç½®å¯¼å…¥æŒ‰é’®
            document.getElementById('importBtn').disabled = true;
            
            // éšè—çŠ¶æ€æ¶ˆæ¯
            hideStatus();
        }
    </script>
</body>
</html>