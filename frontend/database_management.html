<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        
        body {
            padding: 20px;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        /* Ê†πÊçÆÁº©ÊîæÊØî‰æãË∞ÉÊï¥bodyÂÜÖËæπË∑ù */
        @media (min-width: 1600px) {
            body {
                padding: 30px 40px;
            }
        }
        @media (min-width: 1200px) and (max-width: 1599px) {
            body {
                padding: 25px 35px;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            body {
                padding: 20px 30px;
            }
        }
        @media (max-width: 991px) {
            body {
                padding: 15px 20px;
            }
        }
        
        .container-fluid {
            margin: 0 auto;
            width: 100%;
            padding-left: 0;
            padding-right: 0;
        }
        
        .container-fluid .row {
            margin-left: 0;
            margin-right: 0;
            width: 100%;
        }
        
        .container-fluid .col-md-4,
        .container-fluid .col-md-8 {
            padding-left: 0;
            padding-right: 0;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: slideDown 0.5s ease;
            padding: 0;
        }
        
        .header h1 {
            font-weight: 600;
            color: #1a202c;
            font-size: 2rem;
            margin: 0;
            text-shadow: none;
        }
        
        .user-info {
            color: #4a5568;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-info a, .user-info button {
            background: white;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .user-info a:hover, .user-info button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: none;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            animation: fadeInUp 0.6s ease;
            border: 1px solid #e2e8f0;
            overflow-x: auto;
        }
        
        /* Ê†πÊçÆÁº©ÊîæÊØî‰æãË∞ÉÊï¥ÂÜÖËæπË∑ù */
        @media (min-width: 1600px) {
            .table-container {
                padding: 10px;
            }
        }
        @media (min-width: 1200px) and (max-width: 1599px) {
            .table-container {
                padding: 10px;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table-container {
                padding: 8px;
            }
        }
        @media (max-width: 991px) {
            .table-container {
                padding: 8px;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table-container h5 {
            color: #1a202c;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .editable-cell {
            cursor: text;
            padding: 6px 4px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 32px;
            display: table-cell;
            vertical-align: middle;
            color: #2d3748;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            overflow: visible;
            font-size: 0.9rem;
        }
        
        .editable-cell:hover {
            background: #f7fafc;
            border: 1px solid #cbd5e0;
            box-shadow: none;
        }
        
        .editing-cell {
            padding: 0;
        }
        
        .editing-cell input, .editing-cell select {
            width: 100%;
            border: 1px solid #cbd5e0;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 4px;
            box-shadow: none;
            font-family: inherit;
        }
        
        /* description-cell Âíå comment-cell ‰∏≠ÁöÑÊñáÊú¨ËæìÂÖ•Ê°ÜÊîØÊåÅÊç¢Ë°å */
        .editing-cell.description-cell input,
        .editing-cell.comment-cell input {
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            overflow: visible;
            min-height: 80px;
            padding: 10px;
            line-height: 1.4;
        }
        
        /* textarea Ê†∑Âºè */
        .editing-cell textarea {
            font-family: inherit;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }
        
        .editing-cell textarea:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .editing-cell input:focus, .editing-cell select:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            box-sizing: border-box;
            box-shadow: none;
        }
        
        .date-input:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .filter-row {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-row > .col,
        .filter-row > div {
            flex: 0 0 auto;
            padding-left: 5px;
            padding-right: 5px;
            min-width: 200px;
        }
        
        /* Ê†πÊçÆÁº©ÊîæÊØî‰æãË∞ÉÊï¥Ê£ÄÁ¥¢Ê°ÜÂÆΩÂ∫¶ */
        @media (max-width: 1200px) {
            .filter-row > .col,
            .filter-row > div {
                min-width: 150px;
            }
        }
        @media (max-width: 768px) {
            .filter-row > .col,
            .filter-row > div {
                min-width: 100%;
                flex: 0 0 100%;
            }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background: #4299e1;
            border-color: #4299e1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            border-color: #3182ce;
            transform: none;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.15);
            color: white;
        }
        
        .btn-success {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            border-color: #38a169;
            transform: none;
            box-shadow: 0 2px 6px rgba(72, 187, 120, 0.15);
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            border-color: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
            border-color: #e53e3e;
            transform: none;
            box-shadow: 0 2px 6px rgba(245, 101, 101, 0.15);
            color: white;
        }
        
        .btn-secondary {
            background: #a0aec0;
            border: none;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #718096;
            transform: none;
            box-shadow: 0 2px 6px rgba(160, 174, 192, 0.15);
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid transparent;
        }
        
        .success {
            background: #f0fdf4;
            color: #166534;
            border-left-color: #48bb78;
        }
        
        .success::before {
            content: '‚úì';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .error {
            background: #fef2f2;
            color: #7f1d1d;
            border-left-color: #f56565;
        }
        
        .error::before {
            content: '‚úï';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .loading {
            background: #f0f9ff;
            color: #0c4a6e;
            border-left-color: #4299e1;
        }
        
        .loading::before {
            content: '‚ü≥';
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        .warning {
            background: #fffbeb;
            color: #854d0e;
            border-left-color: #ed8936;
        }
        
        .warning::before {
            content: '‚ö†';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .table {
            margin-bottom: 0;
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            padding: 12px 8px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 80px;
        }
        
        .table td {
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 10px 8px;
            color: #4a5568;
            border-color: #e2e8f0;
            min-width: 80px;
        }
        
        /* Description Âíå Comment ÂàóÁöÑÁâπÊÆäÊ†∑Âºè - ÊîØÊåÅÊç¢Ë°åÔºå‰ΩøÁî®!important‰øùËØÅ‰ºòÂÖàÁ∫ß */
        .table td.description-cell,
        .table td.comment-cell {
            white-space: nowrap !important;
            word-wrap: normal !important;
            word-break: normal !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 140px !important;
            min-height: 32px !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
            line-height: 1.4 !important;
        }
        
        /* PO PN eta_wfsz Á≠âÂàó‰∏çËÉΩÁî®ÁúÅÁï•Âè∑ÔºåÂøÖÈ°ªÂÆåÊï¥ÊéíÊµÅËΩÆÊç¢Ë°åÊ∞¥Âπ≥Êï£Â∏É */
        .table td.no-ellipsis-cell {
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
            min-height: 32px !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
            line-height: 1.3 !important;
            font-size: 0.85rem !important;
        }
        
        /* ÂìçÂ∫îÂºèÔºöÊ†πÊçÆÂ±èÂπïÂ§ßÂ∞èË∞ÉÊï¥ Description Âíå Comment ÁöÑÊúÄÂ§ßÂÆΩÂ∫¶ */
        @media (min-width: 1600px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 180px !important;
            }
        }
        @media (min-width: 1400px) and (max-width: 1599px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 170px !important;
            }
        }
        @media (min-width: 1200px) and (max-width: 1399px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 160px !important;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 150px !important;
            }
        }
        @media (min-width: 768px) and (max-width: 991px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 140px !important;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 767px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 120px !important;
                font-size: 0.8rem;
            }
        }
        /* Ê†πÊçÆÁº©ÊîæÊØî‰æãË∞ÉÊï¥ÂàóÂÆΩ */
        @media (min-width: 1600px) {
            .table th, .table td { min-width: 80px; }
            /* description Âíå comment ÂàóËé∑ÂæóÊõ¥ÂÆΩÁöÑÁ©∫Èó¥ */
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 1400px) and (max-width: 1599px) {
            .table th, .table td { min-width: 70px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 1200px) and (max-width: 1399px) {
            .table th, .table td { min-width: 60px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table th, .table td { min-width: 50px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 768px) and (max-width: 991px) {
            .table th, .table td { min-width: 40px; font-size: 0.9rem; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (max-width: 767px) {
            .table th, .table td { min-width: 30px; font-size: 0.8rem; padding: 8px 6px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        
        .table tbody tr:hover {
            background: #f7fafc;
            box-shadow: none;
            border-left: 3px solid #4299e1;
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Êï∞ÊçÆÈ™åËØÅÈîôËØØË°åÊ†∑Âºè */
        .invalid-row {
            background: #fef2f2 !important;
            color: #7f1d1d;
        }
        
        .invalid-row:hover {
            background: #fed7d7 !important;
        }
        
        .invalid-row td {
            border-color: #fca5a5 !important;
        }
        
        /* Ê§úÁ¥¢Ê°ÜÊ†∑ÂºèË∞ÉÊï¥ */
        .filter-row .col {
            padding-left: 5px;
            padding-right: 5px;
            position: relative;
            min-width: auto;
        }
        
        /* Êó•ÊúüËæìÂÖ•Ê°ÜÊ†∑Âºè */
        .date-filter {
            min-width: 140px;
        }
        
        .date-filter-mode {
            font-size: 0.875rem;
        }
        
        .clear-filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            white-space: nowrap;
            width: 100%;
        }
        
        /* ÂìçÂ∫îÂºè‰∏âÂ±èÂπï */
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .table-container {
                padding: 15px;
            }
            
            .filter-row {
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .user-info {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .user-info a,
            .user-info button {
                width: 100%;
                text-align: center;
            }
            
            .filter-row {
                padding: 10px;
            }
        }
        
        .pagination {
            gap: 5px;
        }
        
        .page-link {
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            transition: all 0.3s ease;
        }
        
        .page-link:hover {
            background: #f7fafc;
            color: #4299e1;
            border-color: #cbd5e0;
        }
        
        .page-item.active .page-link {
            background: #4299e1;
            border-color: #4299e1;
            color: white;
        }
        
        /* Â§çÈÄâÊ°ÜÊ†∑Âºè */
        .checkbox-cell {
            text-align: center;
            width: 50px;
        }
        
        /* Êìç‰ΩúÂàóÊ†∑Âºè */
        .action-cell {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        td:first-child {
            width: 100px;
            min-width: 100px;
        }
        
        .shipment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* ÂõûÈÄÄÊåâÈíÆÊ†∑Âºè */
        .return-shipment-btn {
            background: #ffc107;
            border: 1px solid #ff9800;
            color: #333;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 32px !important;
        }
        
        .return-shipment-btn:hover {
            background: #ff9800;
            border-color: #f57c00;
            color: white;
            transform: scale(1.05);
        }
        
        .return-shipment-btn:active {
            transform: scale(0.95);
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 2px 6px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background: #fed7d7;
            color: #e53e3e;
        }
        
        /* ÂÖ®Â±ÄÂèëË¥ßÊåâÈíÆÂå∫Âüü */
        .shipment-button-area {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selected-items-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .selected-tab {
            background: #e6f2ff;
            border: 1px solid #4299e1;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-tab .remove-btn {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-weight: bold;
            padding: 0 3px;
        }
        
        .selected-tab .remove-btn:hover {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1>Purchase Order Management System</h1>
            <div class="user-info">
                <span id="currentUser">Not Logged In</span>
                <a href="/register.html" id="registerLink">Register</a>
                <a href="/login.html" id="loginLink" style="display: inline-block;">Login</a>
                <button id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </div>
        
        <!-- ÂØºËà™ÊåâÈíÆ -->
        <div class="mb-3">
            <a href="/" class="btn btn-primary">
                üìä Database Management
            </a>
            <a href="/pdf_import.html" class="btn btn-secondary">
                üì§ PDF Import
            </a>
        </div>
        
        <!-- Áä∂ÊÄÅÊ∂àÊÅØÂå∫Âüü -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <!-- Ë°®ÈÄâÊã© -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="tableSelect">
                    <option value="wf_open">WF Open</option>
                    <option value="wf_closed">WF Closed</option>
                    <option value="non_wf_open">Non-WF Open</option>
                    <option value="non_wf_closed">Non-WF Closed</option>
                </select>
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="loadTableData()">
                    üîÑ Refresh Data
                </button>
                <button class="btn btn-success" onclick="showInsertForm()">
                    ‚ûï Insert New Record
                </button>
            </div>
        </div>
        
        <!-- ÂÖ®Â±ÄÂèëË¥ßÊåâÈíÆÂå∫Âüü (‰ªÖÂú®OpenË°®ÊòæÁ§∫) -->
        <div id="shipmentButtonArea" class="shipment-button-area" style="display: none;">
            <button class="btn btn-warning me-2" onclick="openGlobalShipmentModal()" id="globalShipmentBtn">
                üì¶ Shipment
            </button>
            <div class="selected-items-tabs" id="selectedItemsDisplay">
                <!-- Â∑≤ÈÄâÈ°πÁõÆÂ∞ÜÊòæÁ§∫Âú®ËøôÈáå -->
            </div>
        </div>
        
        <!-- ÊèíÂÖ•Ë°®Âçï (ÈªòËÆ§ÈöêËóè) -->
        <div id="insertFormContainer" class="table-container" style="display: none;">
            <h5>Insert New Record</h5>
            <div id="insertFormFields" class="row g-2"></div>
            <div class="mt-2">
                <button class="btn btn-success me-2" onclick="insertRecord()">Insert</button>
                <button class="btn btn-secondary" onclick="hideInsertForm()">Cancel</button>
            </div>
        </div>
        

        
        <!-- Êï∞ÊçÆË°®Ê†º -->
        <div class="table-container">
            <h5 id="tableTitle">WF Open Table Data</h5>
            <div id="filterRow" class="filter-row"></div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead id="tableHeader">
                        <!-- Ë°®Â§¥Â∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- Ë°®‰ΩìÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </tbody>
                </table>
            </div>
            <div id="recordCount" class="mt-2 text-muted"></div>
            <div id="paginationContainer" class="mt-3"></div>
        </div>
    </div>

    <!-- Bootstrap Modal for Confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Operation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                                        Are you sure you want to perform this operation?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÖ®Â±ÄÂèëË¥ßÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="globalShipmentModal" tabindex="-1" style="overflow-y: auto;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- ÂÖ®Â±Ä‰ø°ÊÅØËæìÂÖ• -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Shipment Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tracking Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="globalTrackingNo" placeholder="Enter tracking number">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Shipping Mode <span class="text-danger">*</span></label>
                                    <select class="form-select" id="globalShippingMode">
                                        <option value="">Please select...</option>
                                        <option value="sea">Sea</option>
                                        <option value="air">Air</option>
                                        <option value="train">Train</option>
                                        <option value="truck">Truck</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Shipping Cost <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="globalShippingCost" placeholder="Enter shipping cost" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Áâ©ÊñôÂèëË¥ß‰ø°ÊÅØ -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Material Shipment Quantity</h6>
                        </div>
                        <div class="card-body" id="shipmentItemsContainer" style="max-height: 400px; overflow-y: auto;">
                            <!-- Áâ©ÊñôÈ°πÂ∞ÜÂä®ÊÄÅÁîüÊàê -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmGlobalShipmentBtn">Confirm Shipment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄÄË¥ßÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade" id="returnShipmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Return Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">PO/Line</label>
                            <input type="text" class="form-control" id="returnPoLine" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="returnDescription" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Return Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="returnQty" placeholder="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Available Qty</label>
                            <input type="text" class="form-control" id="returnMaxQty" readonly>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Shipping Cost for same batch:</strong>
                        <p id="batchShippingCostInfo" style="margin: 10px 0;"></p>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="updateBatchShippingCost">
                            <label class="form-check-label" for="updateBatchShippingCost">
                                Update shipping cost for other materials in same batch
                            </label>
                        </div>
                        <div id="updateShippingCostContainer" style="display: none; margin-top: 10px;">
                            <label class="form-label">New Shipping Cost</label>
                            <input type="number" class="form-control" id="newBatchShippingCost" placeholder="0" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmReturnBtn">Confirm Return</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â∑≤ÁôªÂΩï
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // Êú™ÁôªÂΩïÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // Âú®È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        if (!checkLoginStatus()) {
            // Â¶ÇÊûúÊú™ÁôªÂΩïÔºåÈòªÊ≠¢È°µÈù¢ÁªßÁª≠Âä†ËΩΩ
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>Please log in first</h2><p>Redirecting to login page...</p></div>';
            });
        }
        
        // Ë¥ßÂ∏ÅÁ¨¶Âè∑Êò†Â∞Ñ
        const currencyMap = {
            'wefabricate': '‚Ç¨',
            'centurion': '$',
            'magic_fx': '‚Ç¨'
        };
        
        // Ëé∑ÂèñÂÖ¨Âè∏ÁöÑË¥ßÂ∏ÅÁ¨¶Âè∑
        function getCurrencySymbol(company) {
            return currencyMap[company] || '';
        }
        
        // ÂÖ®Â±ÄÂèòÈáè
        let currentTable = 'wf_open';
        let tableData = [];
        let originalData = [];
        let filteredData = []; // Áî®‰∫éÂ≠òÂÇ®ËøáÊª§ÂêéÁöÑÊï∞ÊçÆ
        let columnNames = [];
        let columns = []; // Ë°®ÂàóÊï∞ÁªÑ
        let dateColumns = ['req_date_wf', 'eta_wfsz', 'latest_departure_date', 'po_placed_date', 'req_date'];
        let currentEditingCell = null; // Ë∑üË∏™ÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑÂçïÂÖÉÊ†º
        // ÂàÜÈ°µÁõ∏ÂÖ≥ÂèòÈáè
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // ÂÖ®Â±ÄÂèëË¥ßÁõ∏ÂÖ≥ÂèòÈáè
        let selectedItemsForShipment = new Map(); // Â≠òÂÇ®Â∑≤ÈÄâÊã©ÁöÑÈ°πÁõÆ: key=po_line, value=Áâ©Êñô‰ø°ÊÅØ
        
        // ÂàùÂßãÂåñÈ°µÈù¢
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("È°µÈù¢DOMÂÜÖÂÆπÂä†ËΩΩÂÆåÊàê");
                
                // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
                if (!checkLoginStatus()) {
                    return;
                }
                
                // ÊòæÁ§∫ÂΩìÂâçÁî®Êà∑
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    const currentUserElement = document.getElementById('currentUser');
                    const logoutBtn = document.getElementById('logoutBtn');
                    const loginLink = document.getElementById('loginLink');
                    const registerLink = document.getElementById('registerLink');
                    
                    if (currentUserElement) {
                        currentUserElement.textContent = currentUser.email;
                    }
                    
                    if (logoutBtn) {
                        logoutBtn.style.display = 'inline-block';
                    }
                    
                    if (loginLink) {
                        loginLink.style.display = 'none';
                    }
                    
                    if (registerLink) {
                        registerLink.style.display = 'none';
                    }
                }
                
                // Ê£ÄÊü•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                const requiredElements = [
                    'tableSelect',
                    'insertForm',
                    'insertFormFields',
                    'tableContainer',
                    'tableHeader',
                    'tableBody',
                    'filterRow',
                    'recordCount',
                    'paginationContainer'
                ];
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.warn(`Êú™ÊâæÂà∞id‰∏∫'${elementId}'ÁöÑÂÖÉÁ¥†`);
                    }
                });
                
                loadTableData();
                
                // ÁõëÂê¨Ë°®ÈÄâÊã©ÂèòÂåñ
                const tableSelect = document.getElementById('tableSelect');
                if (tableSelect) {
                    tableSelect.addEventListener('change', function() {
                        currentTable = this.value;
                        // Ê∏ÖÈô§ËøáÊª§Âô®
                        clearAllFilters();
                        loadTableData();
                    });
                }
                
                // ÁõëÂê¨ÂÖ®Â±ÄÈîÆÁõò‰∫ã‰ª∂
                document.addEventListener('keydown', function(event) {
                    // ÈÅøÂÖçÂú®ËæìÂÖ•Ê°Ü‰∏≠ÊåâÈîÆÊó∂Ëß¶ÂèëÂÖ®Â±Ä‰∫ã‰ª∂
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    if (currentEditingCell) {
                        if (event.key === 'Escape') {
                            // ESCÈîÆÂèñÊ∂àÁºñËæë
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                const originalValue = input.getAttribute('data-original-value');
                                input.value = originalValue || '';
                                // Ëß¶Âèëchange‰∫ã‰ª∂Êõ¥Êñ∞Êï∞ÊçÆÊ®°Âûã
                                input.dispatchEvent(new Event('change'));
                                // ÁªìÊùüÁºñËæëÁä∂ÊÄÅ
                                currentEditingCell.textContent = originalValue || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        } else if (event.key === 'Enter') {
                            // EnterÈîÆ‰øùÂ≠òÁºñËæë
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                input.dispatchEvent(new Event('change'));
                                currentEditingCell.textContent = input.value || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        }
                    }
                });
                
                // Ê∑ªÂä†ÈÄÄÂá∫ÊåâÈíÆ‰∫ã‰ª∂ÁõëÂê¨
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                    });
                }
                
                // ‰∏∫Á°ÆËÆ§Ê®°ÊÄÅÊ°ÜÊ∑ªÂä†ÈöêËóè‰∫ã‰ª∂ÁõëÂê¨ÔºåÁ°Æ‰øùÊ≠£Â∏∏ÂÖ≥Èó≠
                const confirmModal = document.getElementById('confirmModal');
                if (confirmModal) {
                    confirmModal.addEventListener('hidden.bs.modal', function() {
                        // Á£®Èô§ÊâÄÊúâ backdrop
                        document.querySelectorAll('.modal-backdrop').forEach(el => {
                            el.remove();
                        });
                        // ÁßªÈô§ body ÁöÑ modal-open Á±ª
                        document.body.classList.remove('modal-open');
                        document.body.style.paddingRight = '';
                    });
                }
                
                console.log("È°µÈù¢ÂàùÂßãÂåñÂÆåÊàê");
            } catch (error) {
                console.error("È°µÈù¢ÂàùÂßãÂåñÂá∫Èîô:", error);
            }
        });
        
        // Â∏¶ËÆ§ËØÅÁöÑfetchÂáΩÊï∞
        function authenticatedFetch(url, options = {}) {
            // Ëé∑ÂèñÂ≠òÂÇ®ÁöÑtoken
            const token = localStorage.getItem('authToken');
            if (!token) {
                // Â¶ÇÊûúÊ≤°ÊúâtokenÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                window.location.href = '/login.html';
                throw new Error('Êú™ÁôªÂΩï');
            }
            
            // Ê∑ªÂä†ËÆ§ËØÅÂ§¥
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // Ê∑ªÂä†Áî®Êà∑ÈÇÆÁÆ±Â§¥
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                options.headers['X-User-Email'] = currentUser.email;
            }
            
            return fetch(url, options)
                .then(response => {
                    if (response.status === 401) {
                        // TokenÊó†ÊïàÊàñËøáÊúüÔºåÊ∏ÖÈô§Êú¨Âú∞Â≠òÂÇ®Âπ∂Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µÈù¢
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                        throw new Error('ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                    }
                    return response;
                })
                .catch(error => {
                    if (error.message === 'ËÆ§ËØÅÂ§±Ë¥•ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï') {
                        throw error;
                    }
                    // ÂÖ∂‰ªñÈîôËØØÁªßÁª≠ÊäõÂá∫
                    throw error;
                });
        }
        
        // Ëé∑ÂèñË°®ÁöÑÂàóÂêç
        function getColumnNames(tableName) {
            // Ê†πÊçÆË°®ÂêçËøîÂõûÂØπÂ∫îÁöÑÂàóÈ°∫Â∫è
            const tableColumns = {
                'wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'wfsz_shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'latest_departure_date', 'chinese_name', 'unit', 'company'],
                'wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'wfsz_shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'chinese_name', 'unit', 'company'],
                'non_wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'company'],
                'non_wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'shipping_cost', 'tracking_no', 'so_number', 'company']
            };
            
            // ËøîÂõûÂØπÂ∫îË°®ÁöÑÂàóÈ°∫Â∫èÔºåÂ¶ÇÊûúÊ≤°ÊúâÂÆö‰πâÂàôËøîÂõûÈªòËÆ§È°∫Â∫è
            return tableColumns[tableName] || ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'po_placed_date', 'purchaser', 'company'];
        }
        
        // Ëé∑ÂèñÂàóÁöÑÊòæÁ§∫ÂêçÁß∞
        function getColumnDisplayName(columnName) {
            const displayNameMap = {
                'wfsz_shipping_mode': 'Ship Mode',
                'so_number': 'SO No',
                'latest_departure_date': 'Dep Date',
            };
            
            return displayNameMap[columnName] || columnName;
        }
        
        // Âä†ËΩΩË°®Êï∞ÊçÆ
        function loadTableData() {
            showStatus('Loading data...', 'loading');
            
            // Ê∏ÖÈô§ÈÄâÊã©ÁöÑÂèëË¥ßÈ°πÁõÆ
            selectedItemsForShipment.clear();
            
            authenticatedFetch(`/api/tables/${currentTable}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tableData = data.data;
                        filteredData = [...tableData]; // ÂàùÂßãÂåñËøáÊª§Êï∞ÊçÆ
                        // Ê†πÊçÆË°®ÂêçËé∑ÂèñÊ≠£Á°ÆÁöÑÂàóÈ°∫Â∫è
                        columnNames = getColumnNames(currentTable);
                        originalData = JSON.parse(JSON.stringify(tableData));
                        // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
                        currentPage = 1;
                        renderTable();
                        // Á°Æ‰øùËøáÊª§Ë°åÂú®Êï∞ÊçÆÂä†ËΩΩÂêéÊ≠£Á°ÆÊòæÁ§∫
                        setTimeout(() => {
                            renderFilterRow();
                        }, 0);
                        hideStatus();
                    } else {
                        showStatus(`Data loading failed: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Data loading failed: ${error}`, 'error');
                });
        }
        
        // ... existing code ...
        
        // Ëá™Âä®Ë∞ÉÊï¥ÂàóÂÆΩ
        function adjustColumnWidths() {
            const table = document.querySelector('.table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            if (rows.length === 0) return;
            
            const headerCells = table.querySelectorAll('thead th');
            const maxWidths = new Map();
            const minColumnWidth = 80; // ÊúÄÂ∞èÂàóÂÆΩ
            
            // ËÆæÁΩÆÁâπÂÆöÂàóÁöÑÈ¢ÑËÆæÊúÄÂ§ßÂÆΩÂ∫¶
            const columnMaxWidths = {
                'description': 140,
                'comment': 150,
                'po': 110,
                'pn': 110,
                'line': 50,
                'po_line': 110,
                'qty': 90,
                'net_price': 90,
                'total_price': 100,
                'company': 110,
                'purchaser': 110,
                'record_no': 95,
                'shipping_cost': 100,
                'tracking_no': 110,
                'eta_wfsz': 110,
                'req_date_wf': 100,
                'req_date': 100,
                'po_placed_date': 110,
                'wfsz_shipping_mode': 90,
                'so_number': 80,
                'latest_departure_date': 90,
                'Actions': 70
            };
            
            // ÈÅçÂéÜË°®Â§¥Ëé∑ÂèñÂàóÂêç
            headerCells.forEach((th, colIndex) => {
                const columnName = th.textContent.trim();
                
                // ActionsÂàóÂçïÁã¨Â§ÑÁêÜ
                if (columnName === 'Actions') {
                    const actionWidth = 70;
                    th.style.width = actionWidth + 'px';
                    th.style.minWidth = actionWidth + 'px';
                    th.style.maxWidth = actionWidth + 'px';
                    th.style.fontSize = '0.9rem';
                    return;
                }
                
                let maxWidth = columnMaxWidths[columnName] || 150;
                let width = columnName.length * 8 + 16; // ÂÖàÁî®Ê†áÈ¢òÂÆΩÂ∫¶
                
                // ËÆ°ÁÆóËØ•Âàó‰∏≠ÊâÄÊúâÂÜÖÂÆπÁöÑÊúÄÂ§ßÂÆΩÂ∫¶
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells[colIndex]) {
                        const cell = cells[colIndex];
                        const text = cell.textContent.trim();
                        // ‰º∞ÁÆóÊñáÊú¨ÂÆΩÂ∫¶ÔºàÁ≤óÁï•ËÆ°ÁÆóÔºâ
                        const estimatedWidth = Math.ceil(text.length * 7 + 16); // ÊØè‰∏™Â≠óÁ¨¶Á∫¶7px + padding
                        width = Math.max(width, estimatedWidth);
                    }
                });
                
                // ÂèñÊúÄÂ∞èÂÄºÂíåËÆæÂÆöÁöÑÊúÄÂ§ßÂÄº
                const finalWidth = Math.min(Math.max(width, minColumnWidth), maxWidth);
                maxWidths.set(colIndex, finalWidth);
            });
            
            // Â∫îÁî®ÂàóÂÆΩ
            headerCells.forEach((th, colIndex) => {
                const width = maxWidths.get(colIndex);
                if (width) {
                    th.style.width = width + 'px';
                    th.style.minWidth = width + 'px';
                    th.style.maxWidth = width + 'px';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                    th.style.whiteSpace = 'nowrap';
                    th.style.fontSize = '0.9rem';
                }
            });
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, colIndex) => {
                    // ActionsÂàóÔºàÁ¨¨‰∏ÄÂàóÔºâ
                    if (colIndex === 0) {
                        cell.style.width = '70px';
                        cell.style.minWidth = '70px';
                        cell.style.maxWidth = '70px';
                        return;
                    }
                    
                    const width = maxWidths.get(colIndex);
                    if (width) {
                        cell.style.width = width + 'px';
                        cell.style.minWidth = width + 'px';
                        cell.style.maxWidth = width + 'px';
                    }
                });
            });
        }
        
        // Ê∏≤ÊüìË°®Ê†º
        function renderTable() {
            renderTableHeader();
            renderTableBody();
            renderFilterRow();  // ÊÅ¢Â§çËøáÊª§Ë°åÊ∏≤Êüì
            updateRecordCount();
            renderPagination();
            updateTableTitle();
            // Â∫îÁî®Ëá™Âä®ÂàóÂÆΩ
            setTimeout(() => adjustColumnWidths(), 0);
        }
        
        // Ê∏≤ÊüìË°®‰Ωì
        function renderTableBody() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            // ËÆ°ÁÆóÂàÜÈ°µÊï∞ÊçÆ
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            let tableHtml = '';
            paginatedData.forEach((row, index) => {
                // ‰ΩøÁî®ÂÆûÈôÖÁöÑË°åÁ¥¢ÂºïËÄå‰∏çÊòØÂàÜÈ°µÂêéÁöÑÁ¥¢Âºï
                const rowIndex = startIndex + index;
                
                // Ê£ÄÊü• qty*net_price ÊòØÂê¶Á≠â‰∫é total_price
                const qty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = qty * netPrice;
                
                // Ê£ÄÊü•ËÆ°ÁÆóÂÄºÊòØÂê¶‰∏éÊÄª‰ª∑ÂåπÈÖçÔºàËÄÉËôëÊµÆÁÇπÊï∞Á≤æÂ∫¶ÈóÆÈ¢òÔºâ
                const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
                
                // ÊûÑÂª∫Ë°åÁöÑclassÂ±ûÊÄß
                let rowClass = '';
                if (isInvalidRow) {
                    rowClass = 'invalid-row';
                }
                
                let rowHtml = `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                
                // ÂÖàÊ∑ªÂä†Êìç‰ΩúÂàó
                const pn = row['pn'] || '';
                const po = row['po'] || '';
                const poLine = row['po_line'] || '';
                const id = row['id'] || '';
                const rowQty = parseFloat(row.qty) || 0;
                const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
                
                rowHtml += `<td style="text-align: center;" class="action-cell">`;
                
                // Â§çÈÄâÊ°Ü (‰ªÖÂú®OpenË°®ÊòæÁ§∫)
                if (isOpenTable) {
                    const isChecked = selectedItemsForShipment.has(poLine) ? 'checked' : '';
                    rowHtml += `<input type="checkbox" class="shipment-checkbox" data-po-line="${poLine}" data-po="${po}" data-pn="${pn}" data-qty="${rowQty}" data-row-index="${rowIndex}" ${isChecked} onchange="handleShipmentCheckboxChange()">`;
                }
                
                // Âà†Èô§ÊåâÈíÆ - Ê†πÊçÆË°®Á±ªÂûã‰º†ÈÄí‰∏çÂêåÁöÑ‰∏ªÈîÆ
                const deleteKey = isOpenTable ? poLine : id;
                const deleteKeyDisplay = isOpenTable ? poLine : id;
                rowHtml += `<button class="delete-btn" onclick="deleteRowRecord('${deleteKey}', '${currentTable}')" title="Âà†Èô§Ê≠§ËÆ∞ÂΩï">‚úï</button>`;
                
                // ÈÄÄË¥ßÊåâÈíÆ (‰ªÖÂú®closedË°®ÊòæÁ§∫)
                const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
                if (isClosedTable) {
                    const shipmentQty = parseFloat(row.qty) || 0;
                    const poLineStr = String(poLine).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    // Êõ¥ÂÆåÂñÑÁöÑËΩ¨‰πâÔºöÂ§ÑÁêÜÊç¢Ë°åÁ¨¶„ÄÅÂºïÂè∑Á≠âÁâπÊÆäÂ≠óÁ¨¶
                    const descriptionStr = String(row.description || '')
                        .replace(/\\/g, '\\\\\\\\')
                        .replace(/"/g, '\\"')
                        .replace(/'/g, "\\'") 
                        .replace(/\n/g, ' ')
                        .replace(/\r/g, '')
                        .substring(0, 100);
                    // Á°Æ‰øù recordId ÊòØÊúâÊïàÁöÑ id ÂÄºÔºà‰ºöËá™Âä®ËΩ¨Êç¢‰∏∫Â≠óÁ¨¶‰∏≤Ôºâ
                    const recordIdValue = id && id !== '' ? String(id) : String(rowIndex);
                    rowHtml += `<button class="btn btn-sm return-shipment-btn" onclick="openReturnShipmentModal('${poLineStr}', '${descriptionStr}', ${shipmentQty}, '${currentTable}', '${recordIdValue}')" title="ÈÄÄË¥ß" style="padding: 4px 6px; font-size: 12px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">‚Ü©</button>`;
                }
                
                rowHtml += `</td>`;
                // ÂÜçÊ∑ªÂä†Êï∞ÊçÆÂàó
                columnNames.forEach(col => {
                    const value = row[col] !== null ? row[col] : '';
                    // Ê†ºÂºèÂåñÊó•ÊúüÂÄº
                    let displayValue = value;
                    if (value && typeof value === 'object' && value.hasOwnProperty('$$date')) {
                        // Â§ÑÁêÜÁâπÊÆäÊó•ÊúüÊ†ºÂºè
                        const date = new Date(value.$$date);
                        displayValue = date.toLocaleDateString('zh-CN');
                    } else if (value && typeof value === 'string' && value.includes('GMT')) {
                        // Â§ÑÁêÜGMTÊó•ÊúüÂ≠óÁ¨¶‰∏≤
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            // Â¶ÇÊûú‰∏çÊòØÊúâÊïàÊó•ÊúüÔºå‰øùÊåÅÂéüÂÄº
                            displayValue = value;
                        }
                    } else if (value === null || value === 'None' || value === 'null') {
                        displayValue = '';
                    }
                    
                    // ‰∏∫‰ª∑Ê†ºÂ≠óÊÆµÊ∑ªÂä†Ë¥ßÂ∏ÅÁ¨¶Âè∑
                    if ((col === 'net_price' || col === 'total_price' || col === 'shipping_cost') && displayValue !== '') {
                        const company = row['company'] || '';
                        const currency = getCurrencySymbol(company);
                        if (currency && !isNaN(parseFloat(displayValue))) {
                            // ‰∏∫shipping_costÂ≠óÊÆµÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫ÂÖ±‰∫´ËøêË¥π
                            if (col === 'shipping_cost') {
                                const currentShippingCost = parseFloat(displayValue);
                                // ÁªüËÆ°ÊòØÂê¶Êúâ‰∏çÂêåÁöÑpo_lineÊúâÁõ∏ÂêåÁöÑshipping_cost
                                const sameShippingCostCount = paginatedData.filter(r => {
                                    const rShippingCost = parseFloat(r.shipping_cost || 0);
                                    return rShippingCost === currentShippingCost && r.shipping_cost !== null && r.shipping_cost !== '';
                                }).length;
                                
                                // Â¶ÇÊûúÊúâÂ§öÊù°ËÆ∞ÂΩïÂÖ±‰∫´ËøêË¥πÔºåÂàôÊ∑ªÂä†shared:ÂâçÁºÄ
                                if (sameShippingCostCount > 1) {
                                    displayValue = 'shared:' + currency + currentShippingCost;
                                } else {
                                    displayValue = currency + currentShippingCost;
                                }
                            } else {
                                // ÊòæÁ§∫ÁúüÂÆûÂ∞èÊï∞‰ΩçÊï∞Ôºå‰∏çËøõË°åÂõõËàç‰∫îÂÖ•
                                displayValue = currency + parseFloat(displayValue);
                            }
                        }
                    }
                    
                    // Â§ÑÁêÜcompanyÂ≠óÊÆµÔºöÊîπÂ∏ÉÊó†ÊïàÂÄº‰∏∫Á©∫Â≠óÁ¨¶‰∏≤
                    if (col === 'company' && (displayValue === 'undefined' || displayValue === 'null' || displayValue === 'None')) {
                        displayValue = '';
                    }
                    
                    // Á°Æ‰øùÁâπÊÆäÂ≠óÁ¨¶Ë¢´Ê≠£Á°ÆËΩ¨‰πâ
                    const escapedValue = String(displayValue).replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    // ‰∏∫ description Âíå comment ÂàóÊ∑ªÂä†ÁâπÊÆäÁöÑÁ±ªÂêç‰ª•ÊîØÊåÅÊç¢Ë°å
                    let cellClass = 'editable-cell';
                    if (col === 'description') {
                        cellClass += ' description-cell';
                    } else if (col === 'comment') {
                        cellClass += ' comment-cell';
                    } else if (col === 'po' || col === 'pn' || col === 'eta_wfsz') {
                        cellClass += ' no-ellipsis-cell';
                    }
                    
                    rowHtml += `<td class="${cellClass}" data-column="${col}" data-row="${rowIndex}" ondblclick="editCell(this)">${escapedValue}</td>`;
                });
                
                rowHtml += '</tr>';
                tableHtml += rowHtml;
            });
            
            body.innerHTML = tableHtml;
            
            paginatedData.forEach((row, index) => {
                const checkQty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = checkQty * netPrice;
                
                // Ê£ÄÊü•ËÆ°ÁÆóÂÄºÊòØÂê¶‰∏éÊÄª‰ª∑ÂåπÈÖçÔºàËÄÉËôëÊµÆÁÇπÊï∞Á≤æÂ∫¶ÈóÆÈ¢òÔºâ
                if (checkQty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01) {
                    const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
                    if (rowElement) {
                        rowElement.title = `Êï∞ÊçÆ‰∏ç‰∏ÄËá¥: qty(${checkQty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ‚â† total_price(${totalPrice})`;
                    }
                }
            });
            
            // Êõ¥Êñ∞ÂèëË¥ßÊåâÈíÆÂå∫ÂüüÊòæÁ§∫
            updateShipmentButtonArea();
        }
        
        // Ê∏≤ÊüìË°®Â§¥
        function renderTableHeader() {
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';
            
            let headerHtml = '<tr>';
            headerHtml += '<th>Actions</th>';
            columnNames.forEach(col => {
                const displayName = getColumnDisplayName(col);
                headerHtml += `<th>${displayName}</th>`;
            });
            headerHtml += '</tr>';
            
            header.innerHTML = headerHtml;
        }
        
        // Ê∏≤ÊüìËøáÊª§Ë°å
        function renderFilterRow() {
            const filterRow = document.getElementById('filterRow');
            if (!filterRow) {
                console.error('Filter row element not found');
                return;
            }
            
            // Ê∏ÖÁ©∫ËøáÊª§Ë°å
            let filterHtml = '';
            
            // ‰∏∫Êìç‰ΩúÂàóÊ∑ªÂä†Ê∏ÖÈô§ÊåâÈíÆ
            filterHtml += `
                <div>
                    <button class="btn btn-sm btn-outline-secondary clear-filter-btn" onclick="clearAllFilters()">
                       ‚ùå Clear
                    </button>
                </div>
            `;
            
            // ‰∏∫ÊØè‰∏™Êï∞ÊçÆÂàóÂàõÂª∫ËøáÊª§Âô®
            columnNames.forEach((col, index) => {
                const isDateColumn = dateColumns.includes(col);
                
                if (isDateColumn) {
                    // Êó•ÊúüÂàóÔºöÂàõÂª∫ÊåâÈíÆÊâìÂºÄÂºπÁ™ó + ÊØîËæÉÊ®°ÂºèÈÄâÊã©Âô®
                    filterHtml += `
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-outline-primary" onclick="openDateFilterModal('${col}')" style="white-space: nowrap;">
                                üìÖ ${col}
                            </button>
                            <select class="form-select form-select-sm date-filter-mode" 
                                    data-column="${col}"
                                    style="flex: 0 0 auto; width: 100px;" 
                                    onchange="filterTable(this)">
                                <option value="equals">On</option>
                                <option value="before">Before</option>
                                <option value="on_or_after">After</option>
                            </select>
                            <input type="hidden" class="date-filter" data-column="${col}">
                        </div>
                    `;
                } else {
                    // ÊôÆÈÄöÊñáÊú¨Âàó
                    filterHtml += `
                        <div>
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="${col}" 
                                   data-column="${col}"
                                   oninput="filterTable(this)">
                        </div>
                    `;
                }
            });
            
            filterRow.innerHTML = filterHtml;
            
            // ËÆæÁΩÆËøáÊª§Âô®‰∫ã‰ª∂
            setupFilterEvents();
        }
        
        // ÊâìÂºÄÊó•ÊúüËøáÊª§ÂºπÁ™ó
        function openDateFilterModal(column) {
            // Ëé∑ÂèñÂΩìÂâçÊó•ÊúüÂÄºÔºà‰ªéselectÁöÑdata-dateÂ±ûÊÄßËØªÂèñÔºâ
            const modeSelect = document.querySelector(`.date-filter-mode[data-column="${column}"]`);
            const currentDate = modeSelect ? modeSelect.getAttribute('data-date') : '';
            
            // ÂàõÂª∫ÂºπÁ™ó
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = `dateFilterModal_${column}`;
            modal.tabIndex = -1;
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Date - ${column}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">Select Date:</label>
                            <input type="date" id="dateFilterInput_${column}" class="form-control" value="${currentDate || ''}">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                            <button type="button" class="btn btn-primary" onclick="confirmDateFilter('${column}')">Á°ÆÂÆö</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Ê∑ªÂä†Âà∞È°µÈù¢
            document.body.appendChild(modal);
            
            // ÊòæÁ§∫ÂºπÁ™ó
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // ÂºπÁ™óÂÖ≥Èó≠ÂêéÁßªÈô§
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            }, { once: true });
        }
        
        // Á°ÆËÆ§Êó•ÊúüÈÄâÊã©
        function confirmDateFilter(column) {
            const dateInput = document.getElementById(`dateFilterInput_${column}`);
            let selectedDate = dateInput.value;
            
            // Â∞ÜÊó•ÊúüÊ†ºÂºè‰ªé YYYY-MM-DD ËΩ¨Êç¢‰∏∫ YYYY-MM-DDÔºàÁ°Æ‰øùÊ†ºÂºè‰∏ÄËá¥Ôºâ
            if (selectedDate && selectedDate.includes('/')) {
                // Áà∂Êç¢ / ‰∏∫ -
                selectedDate = selectedDate.replace(/\//g, '-');
                console.log(`Êó•ÊúüÊ†ºÂºèËΩ¨Êç¢: ${dateInput.value} => ${selectedDate}`);
            }
            
            // ‰øùÂ≠òÂà∞selectÁöÑdata-dateÂ±ûÊÄß
            const modeSelect = document.querySelector(`.date-filter-mode[data-column="${column}"]`);
            if (modeSelect) {
                modeSelect.setAttribute('data-date', selectedDate);
                console.log(`‰øùÂ≠òÊó•Êúü: ${column} = ${selectedDate}`);
            }
            
            // ÂÖ≥Èó≠ÂºπÁ™ó
            const modal = bootstrap.Modal.getInstance(document.getElementById(`dateFilterModal_${column}`));
            if (modal) {
                modal.hide();
            }
            
            // Â∫îÁî®ËøáÊª§Âô®
            applyAllFilters();
        }
        
        // ËøáÊª§Ë°®Ê†º
        function filterTable(input) {
            // Áõ¥Êé•Â∫îÁî®ËøáÊª§Âô®Ôºå‰∏ç‰ΩøÁî®Èò≤Êäñ
            applyAllFilters();
        }
        
        // Â∫îÁî®ÊâÄÊúâËøáÊª§Âô®
        function applyAllFilters() {
            // Ëé∑ÂèñÊâÄÊúâÊó•ÊúüËøáÊª§Âô®ÁöÑselectÂÖÉÁ¥†
            const dateFilterModes = document.querySelectorAll('.date-filter-mode');
            
            // Ëé∑ÂèñÊâÄÊúâÊñáÊú¨ËæìÂÖ•Ê°Ü
            const textFilters = document.querySelectorAll('input[data-column]:not(.date-filter)');
            
            // ‰øùÂ≠òÂΩìÂâçÁöÑËæìÂÖ•ÂÄº
            const currentDateValues = {};
            const currentModes = {};
            const currentTextValues = {};
            
            // ‰ªé select ÁöÑ data-date Â±ûÊÄßËØªÂèñÊó•ÊúüÂÄº
            dateFilterModes.forEach(select => {
                const col = select.getAttribute('data-column');
                currentDateValues[col] = select.getAttribute('data-date') || '';
                currentModes[col] = select.value;
                console.log(`‰øùÂ≠òÊ®°Âºè: ${col} = ${select.value}, Êó•Êúü = ${currentDateValues[col]}`);
            });
            
            textFilters.forEach(input => {
                currentTextValues[input.getAttribute('data-column')] = input.value;
            });
            
            // ‰ªéÂéüÂßãÊï∞ÊçÆÂºÄÂßãËøáÊª§‰ª•‰øùÊåÅÊó•ÊúüÁöÑÂéüÂßãÊ†ºÂºè
            filteredData = originalData.map(row => ({ ...row }));
            
            console.log(`ÂºÄÂßãËøáÊª§, ÂéüÂßãÊï∞ÊçÆÊï∞: ${filteredData.length}`);
            
            // ÂÖàÂ∫îÁî®Êó•ÊúüËøáÊª§
            dateFilterModes.forEach(select => {
                const column = select.getAttribute('data-column');
                const filterValue = (select.getAttribute('data-date') || '').trim();
                const mode = select.value || 'equals';
                
                console.log(`Êó•ÊúüËøáÊª§: column=${column}, value=${filterValue}, mode=${mode}`);
                
                if (filterValue) {
                    const beforeCount = filteredData.length;
                    
                    filteredData = filteredData.filter(row => {
                        const cellValue = (row[column] || '').toString().trim();
                        
                        // Á©∫Êó•Êúü‰∏çÂèÇ‰∏éËøáÊª§ - ËøîÂõû false ÊéíÈô§Á©∫ÂÄº
                        if (!cellValue || cellValue === 'undefined') {
                            return false;
                        }
                        
                        // ÊèêÂèñÊó•ÊúüÈÉ®ÂàÜÔºàÂ§ÑÁêÜÂèØËÉΩÁöÑÊó∂Èó¥ÂíåÂÖ∂‰ªñÊ≤ÑÊ±°Ôºâ
                        // ËÆæÂÆö‰ªÑÊ≠£Ê†ºÂºè‰∏∫ YYYY-MM-DD
                        const cellDate = extractDateOnly(cellValue);
                        const result = compareDate(cellDate, filterValue, mode);
                        
                        if (result) {
                            console.log(`  ‚úì ${cellDate} ${mode} ${filterValue}`);
                        }
                        return result;
                    });
                    
                    const afterCount = filteredData.length;
                    console.log(`  ÁªìÊûú: ${beforeCount} -> ${afterCount}`);
                }
            });
            
            // ÁÑ∂ÂêéÂ∫îÁî®ÊñáÊú¨ËøáÊª§
            textFilters.forEach(input => {
                const column = input.getAttribute('data-column');
                const filterValue = input.value.trim().toLowerCase();
                
                if (filterValue) {
                    filteredData = filteredData.filter(row => {
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        return cellValue.includes(filterValue);
                    });
                }
            });
            
            console.log(`ÊúÄÁªàÁªìÊûú: ${filteredData.length}`);
            
            // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µÂπ∂ÈáçÊñ∞Ê∏≤Êüì
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
            // ‰øùÊåÅÂ∑≤ÈÄâÈ°πÁõÆÁöÑUIÁä∂ÊÄÅ
            setTimeout(updateSelectedItemsDisplay, 100);
        }
        
        // Âà†Èô§Ëøô‰∏™ÈáçÂ§çÁöÑÂÆö‰πâÔºå‰ΩøÁî®‰∏ãÈù¢ÁöÑÁâàÊú¨
        
        // ÂàùÂßãÂåñË°®Ê†º
        function initTable() {
            renderTableBody();
            updateRecordCount();
            renderPagination();
        }
        
        // ÂàùÂßãÂåñÊï∞ÊçÆ
        function initData() {
            tableData = [
                { name: 'Alice', age: 25, date: '2023-01-01' },
                { name: 'Bob', age: 30, date: '2023-02-15' },
                { name: 'Charlie', age: 35, date: '2023-03-20' },
                { name: 'David', age: 40, date: '2023-04-25' },
                { name: 'Eve', age: 45, date: '2023-05-30' },
                { name: 'Frank', age: 50, date: '2023-06-05' },
                { name: 'Grace', age: 55, date: '2023-07-10' },
                { name: 'Hannah', age: 60, date: '2023-08-15' },
                { name: 'Ivy', age: 65, date: '2023-09-20' },
                { name: 'Jack', age: 70, date: '2023-10-25' },
                { name: 'Kathy', age: 75, date: '2023-11-30' },
                { name: 'Liam', age: 80, date: '2023-12-05' },
                { name: 'Mia', age: 85, date: '2023-12-10' },
                { name: 'Noah', age: 90, date: '2023-12-15' },
                { name: 'Olivia', age: 95, date: '2023-12-20' },
                { name: 'Paul', age: 100, date: '2023-12-25' },
                { name: 'Quinn', age: 105, date: '2024-01-01' },
                { name: 'Rachel', age: 110, date: '2024-01-05' },
                { name: 'Sam', age: 115, date: '2024-01-10' },
                { name: 'Tina', age: 120, date: '2024-01-15' },
            ];
            
            columns = Object.keys(tableData[0]);
            
            initTable();
        }
        
        // ÊèêÂèñYYYY-MM-DDÊ†ºÂºèÁöÑÊó•Êúü
        function extractDateOnly(dateString) {
            if (!dateString) return '';
            
            // ÊòØÂê¶Â∑≤ÁªèYYYY-MM-DDÊ†ºÂºè
            if (dateString.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateString.substring(0, 10);
            }
            
            // ÊòØÂê¶ÊòØGMTÊàñÂÖ∂‰ªñÊó•ÊúüÂ≠óÁ¨¶‰∏≤ÔºåÈúÄË¶ÅËß£Êûê
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    // ËΩ¨Êç¢‰∏∫YYYY-MM-DDÊ†ºÂºè
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn(`Êó•ÊúüËß£ÊûêÂ§±Ë¥•: ${dateString}`);
            }
            
            return dateString;
        }
        
        // ÊØîËæÉÊó•ÊúüÁöÑËæÖÂä©ÂáΩÊï∞
        function compareDate(cellDate, filterDate, mode) {
            console.log(`compareDate: cellDate=${cellDate}, filterDate=${filterDate}, mode=${mode}`);
            
            // ‰ΩøÁî®Â≠óÁ¨¶‰∏≤ÊØîËæÉÔºàYYYY-MM-DDÊ†ºÂºèÔºâ
            if (mode === 'equals') {
                // ÂΩìÂ§©ÔºöÂÆåÂÖ®Áõ∏Á≠â
                const result = cellDate === filterDate;
                console.log(`  equals: ${cellDate} === ${filterDate} = ${result}`);
                return result;
            } else if (mode === 'before') {
                // ‰πãÂâçÔºöÂ∞è‰∫éÁ≠â‰∫éÔºàÂåÖÂê´ÂΩìÂ§©Ôºâ
                const result = cellDate <= filterDate;
                console.log(`  before: ${cellDate} <= ${filterDate} = ${result}`);
                return result;
            } else if (mode === 'on_or_after') {
                // ‰πãÂêéÔºöÂ§ß‰∫éÁ≠â‰∫éÔºàÂåÖÂê´ÂΩìÂ§©Ôºâ
                const result = cellDate >= filterDate;
                console.log(`  on_or_after: ${cellDate} >= ${filterDate} = ${result}`);
                return result;
            }
            
            return true;
        }
        
        // ‰∏∫ËøáÊª§Âô®Ê∑ªÂä†ÂõûËΩ¶ÈîÆ‰∫ã‰ª∂
        function setupFilterEvents() {
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                // Á°Æ‰øùÁßªÈô§‰πãÂâçÂèØËÉΩÊ∑ªÂä†ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                input.removeEventListener('keyup', handleFilterKeyUp);
                // Ê∑ªÂä†Êñ∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
                input.addEventListener('keyup', handleFilterKeyUp);
            });
        }
        
        // Â§ÑÁêÜËøáÊª§Âô®ÁöÑkeyup‰∫ã‰ª∂
        function handleFilterKeyUp(event) {
            if (event.key === 'Enter') {
                applyAllFilters();
            }
        }
        
        // Ê∏ÖÈô§ÊâÄÊúâËøáÊª§Âô®
        function clearAllFilters() {
            // Ê∏ÖÈô§ÊâÄÊúâÊó•ÊúüËæìÂÖ•Ê°ÜÁöÑÂÄº
            const dateFilters = document.querySelectorAll('input.date-filter');
            const dateFilterModes = document.querySelectorAll('.date-filter-mode');
            const textFilters = document.querySelectorAll('input[data-column]:not(.date-filter)');
            
            dateFilters.forEach(input => {
                input.value = '';
            });
            
            dateFilterModes.forEach(select => {
                select.value = 'equals';
            });
            
            textFilters.forEach(input => {
                input.value = '';
            });
            
            // ÈáçÁΩÆËøáÊª§Êï∞ÊçÆ‰∏∫ÂéüÂßãÊï∞ÊçÆ
            filteredData = originalData.map(row => ({ ...row }));
            
            // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µÂπ∂ÈáçÊñ∞Ê∏≤Êüì
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
        }
        
        // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
        function showConfirmModal(message, confirmCallback) {
            // ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            document.getElementById('confirmModalBody').innerHTML = message;
            
            // ËÆæÁΩÆÁ°ÆËÆ§ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
            const confirmButton = document.getElementById('confirmModalButton');
            // Ê∏ÖÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // Ê∑ªÂä†Êñ∞ÁöÑÁÇπÂáª‰∫ã‰ª∂ÁõëÂê¨Âô®
            newConfirmButton.onclick = function() {
                // ÊâßË°åÁ°ÆËÆ§ÂõûË∞É
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü - Á®ç‰ΩúÂª∂ËøüÊâπÂáÜÂõûË∞ÉÊâßË°å
                setTimeout(() => {
                    const modalElement = document.getElementById('confirmModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    } else {
                        // Â¶ÇÊûúÂÆû‰æã‰∏çÂ≠òÂú®ÔºåÁõ¥Êé•Ê∏ÖÁêÜ
                        closeConfirmModal();
                    }
                }, 50);
            };
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            
            // Ê∑ªÂä†ModalÂÖ≥Èó≠‰∫ã‰ª∂ÁõëÂê¨ÔºåÁ°Æ‰øùÊªöÂä®Êù°ÊÅ¢Â§ç
            modalElement.addEventListener('hidden.bs.modal', function() {
                document.body.style.overflow = 'auto';
            }, { once: true });
            
            modal.show();
        }
        
        // ‰∏ªÂä®ÂÖ≥Èó≠ModalÁöÑÂ∫îÊÄ•ÊñπÊ≥ï
        function closeConfirmModal() {
            const modalElement = document.getElementById('confirmModal');
            // ÁßªÈô§modalÂÖÉÁ¥†ÁöÑshowÁ±ª
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            // Ê∏ÖÈô§ÊâÄÊúâbackdrop
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            // Ê≠£Â∏∏Âåñ‰ΩìÁöÑÊ†∑Âºè
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = 'auto';
        }
        
        // ÁºñËæëÂçïÂÖÉÊ†º
        function editCell(cell) {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØËæìÂÖ•Ê°ÜÔºå‰∏çÊâßË°åÁºñËæëÊìç‰Ωú
            if (event && event.target.tagName === 'INPUT') {
                return;
            }
            
            // Â¶ÇÊûúÊúâÊ≠£Âú®ÁºñËæëÁöÑÂçïÂÖÉÊ†ºÔºåÂÖàÂèñÊ∂àÂÆÉÁöÑÁºñËæëÁä∂ÊÄÅ
            if (currentEditingCell && currentEditingCell !== cell) {
                // ÊÅ¢Â§çÂçïÂÖÉÊ†ºÊòæÁ§∫
                const originalValue = currentEditingCell.getAttribute('data-original-value');
                currentEditingCell.textContent = originalValue || '';
                currentEditingCell.classList.remove('editing-cell');
                currentEditingCell.classList.add('editable-cell');
            }
            
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØÂ∑≤ÁªèÂ§Ñ‰∫éÁºñËæëÁä∂ÊÄÅÁöÑÂçïÂÖÉÊ†ºÔºåÂàô‰∏çÂÅö‰ªª‰ΩïÊìç‰Ωú
            if (cell.classList.contains('editing-cell')) {
                return;
            }
            
            const rowIndex = parseInt(cell.getAttribute('data-row'));
            const columnName = cell.getAttribute('data-column');
            const currentValue = cell.textContent || '';
            
            // ‰øùÂ≠òÂéüÂßãÂÄº
            cell.setAttribute('data-original-value', currentValue);
            
            // Ê†πÊçÆÂàóÂêçÂà§Êñ≠ËæìÂÖ•Á±ªÂûã
            let inputHtml = '';
            let dateValue = '';
            
            if (dateColumns.includes(columnName)) {
                // ÂØπ‰∫éÊó•ÊúüÂ≠óÊÆµÔºåÁ°Æ‰øùÂÄºÊ†ºÂºèÊ≠£Á°Æ
                dateValue = currentValue;
                if (currentValue && currentValue !== 'null' && currentValue !== 'None') {
                    // Â¶ÇÊûúÊòØÊó•ÊúüÂØπË±°ÔºåÊ†ºÂºèÂåñ‰∏∫ YYYY-MM-DD
                    if (currentValue instanceof Date) {
                        dateValue = currentValue.toISOString().split('T')[0];
                    } else if (typeof currentValue === 'string' && currentValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                        // Â∑≤ÁªèÊòØÊ≠£Á°ÆÊ†ºÂºè
                        dateValue = currentValue;
                    } else if (typeof currentValue === 'string' && currentValue.includes('GMT')) {
                        // Â§ÑÁêÜGMTÊó•ÊúüÂ≠óÁ¨¶‰∏≤
                        try {
                            const date = new Date(currentValue);
                            if (!isNaN(date.getTime())) {
                                dateValue = date.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            dateValue = currentValue;
                        }
                    }
                } else {
                    dateValue = '';
                }
                inputHtml = `<input type="date" class="date-input" 
                                     data-original-value="${dateValue}">`;
            } else if (columnName === 'shipping_mode' || columnName === 'wfsz_shipping_mode') {
                // ‰∏∫ shipping_mode Êàñ wfsz_shipping_mode ‰ΩøÁî®‰∏ãÊãâÊ°Ü
                const shippingModeOptions = ['sea', 'air', 'train', 'truck'];
                let optionsHtml = '';
                optionsHtml += '<option value=""></option>'; // Á©∫ÈÄâÈ°π
                shippingModeOptions.forEach(option => {
                    const selected = currentValue === option ? 'selected' : '';
                    optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
                });
                inputHtml = `<select class="form-select" data-original-value="${currentValue}" style="width: 100%; padding: 8px;">${optionsHtml}</select>`;
            } else if (columnName === 'description' || columnName === 'comment') {
                // ‰∏∫ description Âíå comment ‰ΩøÁî®Â§öË°åÊñáÊú¨Ê°Ü
                inputHtml = `<textarea class="form-control" style="min-height: 100px; resize: vertical;">${currentValue}</textarea>`;
            } else {
                inputHtml = `<input type="text" value="${currentValue}" 
                                     data-original-value="${currentValue}">`;
            }
            
            cell.innerHTML = inputHtml;
            cell.classList.add('editing-cell');
            cell.classList.remove('editable-cell');
            // ‰øùÊåÅ description-cell Êàñ comment-cell ÁöÑÊ†∑ÂºèÁ±ªÂú®ÁºñËæëÊó∂‰πüÈÄÇÁî®
            // ËøôÊ†∑Êç¢Ë°åÊ†∑ÂºèÂú®ÁºñËæëÊó∂‰πüËÉΩ‰øùÊåÅ
            
            // ËÅöÁÑ¶Âà∞Êñ∞ÂàõÂª∫ÁöÑËæìÂÖ•Ê°Ü
            const input = cell.querySelector('input, textarea, select');
            if (input) {
                // ÂØπ‰∫éÊó•ÊúüËæìÂÖ•Ê°ÜÔºåÂçïÁã¨ËÆæÁΩÆvalueÂ±ûÊÄß
                if (dateColumns.includes(columnName)) {
                    input.value = dateValue;
                } else if (columnName === 'shipping_mode' || columnName === 'wfsz_shipping_mode') {
                    // select ÂÖÉÁ¥†Â∑≤ÁªèÊúâ data-original-value ÂíåÈÄâ‰∏≠ÁöÑÂÄºÔºåÁõ¥Êé•ËÅöÁÑ¶
                    // Êó†ÈúÄÈ¢ùÂ§ñÂ§ÑÁêÜ
                } else if (columnName === 'description' || columnName === 'comment') {
                    // textarea Â∑≤ÁªèËÆæÁΩÆ‰∫ÜÂÄºÔºåËÆæÁΩÆ data-original-value Â±ûÊÄß
                    input.setAttribute('data-original-value', currentValue);
                    input.select();
                } else {
                    // ÂØπ‰∫éÊñáÊú¨ËæìÂÖ•Ê°ÜÔºåÈÄâÊã©ÊâÄÊúâÊñáÊú¨‰ª•‰æøÁºñËæë
                    input.select();
                }
                input.focus();
                
                // ‰∏∫ËæìÂÖ•Ê°ÜÂíå‰∏ãÊãâÊ°ÜÈÉΩÊ∑ªÂä†ÈîÆÁõò‰∫ã‰ª∂ÁõëÂê¨
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        event.stopPropagation();
                        // ESCÈîÆÂèñÊ∂àÁºñËæëÔºåÊÅ¢Â§çÂéüÂßãÂÄº
                        const originalValue = input.getAttribute('data-original-value');
                        cell.textContent = originalValue || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    } else if (event.key === 'Enter' && input.tagName !== 'TEXTAREA' && input.tagName !== 'SELECT') {
                        // EnterÈîÆ‰ªÖÂØπÈùûtextareaÂíåÈùûselectÁîüÊïà
                        event.preventDefault();
                        event.stopPropagation();
                        // EnterÈîÆËß¶Âèë‰øùÂ≠òÈÄªËæë
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        // Ê£ÄÊü•ÂÄºÊòØÂê¶ÊúâÂèòÂåñ
                        if (originalValue !== currentInputValue) {
                            // ÂºπÂá∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                // Á°ÆËÆ§‰øùÂ≠ò
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            // Ê≤°Êúâ‰øÆÊîπÔºåÁõ¥Êé•ÂÖ≥Èó≠
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    } else if (event.key === 'Enter' && event.ctrlKey && input.tagName === 'TEXTAREA') {
                        // Ctrl+Enter‰∏∫textareaÈ¢ÑÁïôÁöÑ‰øùÂ≠òÈîÆ
                        event.preventDefault();
                        event.stopPropagation();
                        // Ctrl+EnterÈîÆËß¶Âèë‰øùÂ≠òÈÄªËæë
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                    } else if (event.key === 'Enter' && input.tagName === 'SELECT') {
                        // EnterÈîÆ‰∏∫selectËß¶Âèë‰øùÂ≠òÈÄªËæë
                        event.preventDefault();
                        event.stopPropagation();
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        // Ê£ÄÊü•ÂÄºÊòØÂê¶ÊúâÂèòÂåñ
                        if (originalValue !== currentInputValue) {
                            // ÂºπÂá∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                // Á°ÆËÆ§‰øùÂ≠ò
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            // Ê≤°Êúâ‰øÆÊîπÔºåÁõ¥Êé•ÂÖ≥Èó≠
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    }
                });
                
                // ÁõëÂê¨ËæìÂÖ•Ê°ÜÂ§±ÂéªÁÑ¶ÁÇπ‰∫ã‰ª∂ÔºàÂåÖÊã¨selectÔºâ
                input.addEventListener('blur', function(e) {
                    // ÂØπ‰∫éselectÂÖÉÁ¥†ÔºåblurÊó∂Áõ¥Êé•‰øùÂ≠ò
                    if (input.tagName === 'SELECT') {
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        if (originalValue !== currentInputValue) {
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                        return;
                    }
                    
                    // Âª∂ËøüÊâßË°åÔºåÁ°Æ‰øù‰∏ç‰ºö‰∏éÁÇπÂáª‰∫ã‰ª∂ÂÜ≤Á™Å
                    setTimeout(() => {
                        // Ê£ÄÊü•ÂçïÂÖÉÊ†ºÊòØÂê¶‰ªçÂ§Ñ‰∫éÁºñËæëÁä∂ÊÄÅ
                        if (cell.classList.contains('editing-cell')) {
                            const originalValue = input.getAttribute('data-original-value');
                            const currentInputValue = input.value;
                            
                            // Ê£ÄÊü•ÂÄºÊòØÂê¶ÊúâÂèòÂåñ
                            if (originalValue !== currentInputValue) {
                                // ÂºπÂá∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                                showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                    // Á°ÆËÆ§‰øùÂ≠ò
                                    cell.textContent = currentInputValue || '';
                                    cell.classList.remove('editing-cell');
                                    cell.classList.add('editable-cell');
                                    updateCellValue(rowIndex, columnName, currentInputValue);
                                    currentEditingCell = null;
                                });
                            } else {
                                // Ê≤°Êúâ‰øÆÊîπÔºåÁõ¥Êé•ÂÖ≥Èó≠
                                cell.textContent = originalValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        }
                    }, 100);
                });
            }
            
            // ËÆæÁΩÆÂΩìÂâçÁºñËæëÁöÑÂçïÂÖÉÊ†º
            currentEditingCell = cell;
        }
        
        // Êõ¥Êñ∞ÂçïÂÖÉÊ†ºÂÄº
        function updateCellValue(rowIndex, columnName, value) {
            // Â§ÑÁêÜÁâπÊÆäÂÄº
            if (value === 'null' || value === 'None' || value === 'nan') {
                tableData[rowIndex][columnName] = null;
            } else {
                tableData[rowIndex][columnName] = value;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØqtyÊàñnet_priceÂàóÔºåÂ¶ÇÊûúÊòØÂàôËá™Âä®ËÆ°ÁÆótotal_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                const totalPrice = (qty * netPrice).toFixed(2);
                
                // Êõ¥Êñ∞total_priceÂ≠óÊÆµ
                tableData[rowIndex]['total_price'] = totalPrice;
                
                // Êõ¥Êñ∞Ë°®Ê†º‰∏≠ÊòæÁ§∫ÁöÑtotal_priceÂÄº
                const totalCell = document.querySelector(`td[data-column="total_price"][data-row="${rowIndex}"]`);
                if (totalCell) {
                    totalCell.textContent = totalPrice;
                }
            }
            
            // Á°ÆÂÆö‰∏ªÈîÆÔºöÂØπ‰∫éclosedË°®‰ΩøÁî®idÔºåÂØπ‰∫éopenË°®‰ΩøÁî®po_line
            const row = tableData[rowIndex];
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = row.id;
            } else if (isOpenTable) {
                primaryKeyValue = row.po_line;
            } else {
                primaryKeyValue = row.pn || row.PN;
            }
            
            if (!primaryKeyValue) {
                showStatus('Cannot save: missing primary key value', 'error');
                return;
            }
            
            // ÂáÜÂ§áÊõ¥Êñ∞Êï∞ÊçÆ
            const updates = {};
            updates[columnName] = value === 'null' || value === 'None' || value === 'nan' ? null : value;
            
            // Â¶ÇÊûúÊòØqtyÊàñnet_priceÔºåÂêåÊó∂ÂèëÈÄÅtotal_priceÊõ¥Êñ∞
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
            authenticatedFetch(`/api/tables/${currentTable}/${primaryKeyValue}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆ
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // ÈáçÊñ∞È™åËØÅËØ•Ë°åÊï∞ÊçÆÔºà‰ªÖÂØπÊï∞ÂÄºÂàóÔºâ
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('‰øùÂ≠òÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // ‰øùÂ≠òÂçïÂÖÉÊ†ºÁºñËæë
        function saveCellEdit(cell) {
            // Ëß¶ÂèëËæìÂÖ•Ê°ÜÁöÑchange‰∫ã‰ª∂Êù•‰øùÂ≠òÂÄº
            const input = cell.querySelector('input');
            if (input) {
                input.dispatchEvent(new Event('change'));
            }
            // Êõ¥Êñ∞ÊòæÁ§∫ÂÄº
            if (input) {
                cell.textContent = input.value || '';
            }
            cell.classList.remove('editing-cell');
            cell.classList.add('editable-cell');
        }
        
        // ‰øùÂ≠òÂçïÂÖÉÊ†ºÊï∞ÊçÆÔºàËá™Âä®‰øùÂ≠òÔºâ
        function saveCellData(rowIndex, columnName, value) {
            // Êõ¥Êñ∞Êï∞ÊçÆÊ®°Âûã
            tableData[rowIndex][columnName] = value;
            
            // Â¶ÇÊûúÊòØqtyÊàñnet_priceÔºåÂêåÊó∂Êõ¥Êñ∞total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                tableData[rowIndex]['total_price'] = (qty * netPrice).toFixed(2);
            }
            
            // Á°ÆÂÆö‰∏ªÈîÆÔºöÂØπ‰∫éclosedË°®‰ΩøÁî®idÔºåÂØπ‰∫éopenË°®‰ΩøÁî®po_line
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = row.id;
            } else if (isOpenTable) {
                primaryKeyValue = row.po_line;
            } else {
                primaryKeyValue = row.pn || row.PN;
            }
            
            if (!primaryKeyValue) {
                showStatus('Cannot save: missing primary key value', 'error');
                return;
            }
            
            // ÂáÜÂ§áÊõ¥Êñ∞Êï∞ÊçÆ
            const updates = {};
            updates[columnName] = value;
            
            // Â¶ÇÊûúÊòØqtyÊàñnet_priceÔºåÂêåÊó∂ÂèëÈÄÅtotal_priceÊõ¥Êñ∞
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
            authenticatedFetch(`/api/tables/${currentTable}/${primaryKeyValue}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆ
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // ÈáçÊñ∞È™åËØÅËØ•Ë°åÊï∞ÊçÆÔºà‰ªÖÂØπÊï∞ÂÄºÂàóÔºâ
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('‰øùÂ≠òÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // ÂÆûÊó∂‰øùÂ≠òÂçïÂÖÉÊ†ºÂÄºÂà∞Êï∞ÊçÆÂ∫ì
        function saveCellValueToDatabase(rowIndex, columnName, value) {
            // Ëé∑ÂèñË¶ÅÊõ¥Êñ∞ÁöÑÊï∞ÊçÆ
            const rowData = tableData[rowIndex];
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = rowData.id;
            } else if (isOpenTable) {
                primaryKeyValue = rowData.po_line;
            } else {
                primaryKeyValue = rowData.pn;
            }
            
            // ÊûÑÈÄ†Êõ¥Êñ∞Êï∞ÊçÆ
            const updates = {};
            updates[columnName] = value;
            
            // Â¶ÇÊûúÊòØqtyÊàñnet_priceÔºåÂêåÊó∂Êõ¥Êñ∞total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // ÂèëÈÄÅÊõ¥Êñ∞ËØ∑Ê±Ç
            authenticatedFetch(`/api/tables/${currentTable}/${primaryKeyValue}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆ
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // ÈáçÊñ∞È™åËØÅËØ•Ë°åÊï∞ÊçÆÔºà‰ªÖÂØπÊï∞ÂÄºÂàóÔºâ
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('‰øùÂ≠òÊï∞ÊçÆÊó∂Âá∫Èîô:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }

        // È™åËØÅË°åÊï∞ÊçÆ
        function validateRow(rowIndex) {
            const row = tableData[rowIndex];
            // Á°Æ‰øùÂøÖË¶ÅÁöÑÂàóÂ≠òÂú®
            if (!row.hasOwnProperty('qty') || !row.hasOwnProperty('net_price') || !row.hasOwnProperty('total_price')) {
                return;
            }
            
            const qty = parseFloat(row.qty) || 0;
            const netPrice = parseFloat(row.net_price) || 0;
            const totalPrice = parseFloat(row.total_price) || 0;
            const calculatedTotal = qty * netPrice;
            
            // Ê£ÄÊü•ËÆ°ÁÆóÂÄºÊòØÂê¶‰∏éÊÄª‰ª∑ÂåπÈÖçÔºàËÄÉËôëÊµÆÁÇπÊï∞Á≤æÂ∫¶ÈóÆÈ¢òÔºâ
            const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
            
            const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (rowElement) {
                if (isInvalidRow) {
                    rowElement.classList.add('invalid-row');
                    rowElement.title = `Êï∞ÊçÆ‰∏ç‰∏ÄËá¥: qty(${qty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} ‚â† total_price(${totalPrice})`;
                } else {
                    rowElement.classList.remove('invalid-row');
                    rowElement.title = '';
                }
            }
        }
        
        // ‰øùÂ≠òË°åÊï∞ÊçÆ
        function saveRow(rowIndex) {
            const row = tableData[rowIndex];
            const originalRow = originalData[rowIndex];
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÊõ¥Êîπ
            let hasChanges = false;
            for (let key in row) {
                if (row[key] !== originalRow[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            if (!hasChanges) {
                showStatus('No changes to save', 'info');
                return;
            }
            
            // Ëé∑Âèñ‰∏ªÈîÆÂÄºÔºàÂÅáËÆæ‰∏∫pnÂ≠óÊÆµÔºâ
            const pn = row.pn || row.PN;
            if (!pn) {
                showStatus('Cannot save: missing primary key value(pn)', 'error');
                return;
            }
            
            showStatus('Saving data...', 'loading');
            
            authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(row)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('Data saved successfully', 'success');
                    // Êõ¥Êñ∞ÂéüÂßãÊï∞ÊçÆÂâØÊú¨
                    originalData[rowIndex] = JSON.parse(JSON.stringify(row));
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`Save failed: ${error}`, 'error');
            });
        }
        
        // ÊèíÂÖ•Êñ∞ËÆ∞ÂΩï
        function insertRecord() {
            try {
                const formData = {};
                const formFields = document.querySelectorAll('#insertFormFields input, #insertFormFields select');
                
                // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
                formFields.forEach(field => {
                    let value = field.value;
                    
                    // Â§ÑÁêÜÁâπÊÆäÂÄº
                    if (value === 'null' || value === 'None' || value === '') {
                        value = null;
                    }
                    
                    formData[field.name] = value;
                });
                
                // ÂèëÈÄÅÊèíÂÖ•ËØ∑Ê±Ç
                authenticatedFetch(`/api/tables/${currentTable}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record inserted successfully', 'success');
                        hideInsertForm();
                        loadTableData(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    } else {
                        showStatus(`Insert failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Insert failed: ${error}`, 'error');
                });
            } catch (error) {
                console.error("insertRecordÂáΩÊï∞ÊâßË°åÂá∫Èîô:", error);
                showStatus(`Error inserting record: ${error.message}`, 'error');
            }
        }
        

        
        // ÊòæÁ§∫ÊèíÂÖ•Ë°®Âçï
        function showInsertForm() {
            try {
                console.log("showInsertFormÂáΩÊï∞Ë¢´Ë∞ÉÁî®");
                
                const insertForm = document.getElementById('insertFormContainer');
                
                if (!insertForm) {
                    console.error("Êú™ÊâæÂà∞id‰∏∫'insertFormContainer'ÁöÑÂÖÉÁ¥†");
                    return;
                }
                
                // Â¶ÇÊûúË°®ÂçïÂ∑≤ÁªèÂ±ïÂºÄÔºåÂàôÈöêËóèÔºà‰Ωú‰∏∫ÂèñÊ∂àÔºâ
                if (insertForm.style.display === 'block') {
                    hideInsertForm();
                    return;
                }
                
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertFormFields) {
                    console.error("Êú™ÊâæÂà∞id‰∏∫'insertFormFields'ÁöÑÂÖÉÁ¥†");
                    return;
                }
                
                const columns = getColumnNames(currentTable);
                console.log("ÂΩìÂâçË°®ÁöÑÂàóÂêç:", columns);
                
                let formHtml = '';
                columns.forEach(column => {
                    if (column === 'total_price') return;
                    formHtml += `<div class="col-md-3 mb-2"><input type="text" class="form-control form-control-sm" name="${column}" placeholder="${column}"></div>`;
                });
                
                insertFormFields.innerHTML = formHtml;
                
                insertForm.style.display = 'block';
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'none';
                }
                
                console.log("ÊèíÂÖ•Ë°®ÂçïÂ∑≤ÊòæÁ§∫");
            } catch (error) {
                console.error("showInsertFormÂáΩÊï∞ÊâßË°åÂá∫Èîô:", error);
                alert("ÊòæÁ§∫ÊèíÂÖ•Ë°®ÂçïÊó∂Âá∫Èîô: " + error.message);
            }
        }
        
        // ÈöêËóèÊèíÂÖ•Ë°®Âçï
        function hideInsertForm() {
            try {
                console.log("hideInsertFormÂáΩÊï∞Ë¢´Ë∞ÉÁî®");
                
                // Ê£ÄÊü•ÂøÖË¶ÅÁöÑDOMÂÖÉÁ¥†ÊòØÂê¶Â≠òÂú®
                const insertForm = document.getElementById('insertFormContainer');
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertForm) {
                    console.error("Êú™ÊâæÂà∞id‰∏∫'insertFormContainer'ÁöÑÂÖÉÁ¥†");
                    return;
                }
                
                if (!insertFormFields) {
                    console.error("Êú™ÊâæÂà∞id‰∏∫'insertFormFields'ÁöÑÂÖÉÁ¥†");
                    return;
                }
                
                // ÈöêËóèÊèíÂÖ•Ë°®ÂçïÔºåÊòæÁ§∫Êï∞ÊçÆË°®Ê†º
                insertForm.style.display = 'none';
                // ÊòæÁ§∫ÊúÄÂêé‰∏Ä‰∏™ÂÆπÂô®ÔºàÊï∞ÊçÆË°®Ê†ºÔºâ
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'block';
                }
                
                // Ê∏ÖÁ©∫Ë°®ÂçïÂ≠óÊÆµ
                insertFormFields.innerHTML = '';
                
                console.log("ÊèíÂÖ•Ë°®ÂçïÂ∑≤ÈöêËóè");
            } catch (error) {
                console.error("hideInsertFormÂáΩÊï∞ÊâßË°åÂá∫Èîô:", error);
                console.log("ÈöêËóèÊèíÂÖ•Ë°®ÂçïÊó∂Âá∫Èîô: " + error.message);
            }
        }
        

        
        // ============ ÂÖ®Â±ÄÂèëË¥ßÁõ∏ÂÖ≥ÂáΩÊï∞ ============
        
        // Êõ¥Êñ∞ÂèëË¥ßÊåâÈíÆÂå∫ÂüüÊòæÁ§∫
        function updateShipmentButtonArea() {
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            const buttonArea = document.getElementById('shipmentButtonArea');
            
            if (isOpenTable) {
                buttonArea.style.display = 'flex';
                updateSelectedItemsDisplay();
            } else {
                buttonArea.style.display = 'none';
            }
        }
        
        // Êõ¥Êñ∞Â∑≤ÈÄâÈ°πÁõÆÊòæÁ§∫
        function updateSelectedItemsDisplay() {
            const displayArea = document.getElementById('selectedItemsDisplay');
            displayArea.innerHTML = '';
            
            if (selectedItemsForShipment.size === 0) {
                displayArea.innerHTML = '<span style="color: #a0aec0; font-size: 0.9rem;">No materials selected</span>';
            } else {
                selectedItemsForShipment.forEach((item, poLine) => {
                    const tabHtml = `<div class="selected-tab">
                        <span>${poLine}</span>
                        <button type="button" class="remove-btn" onclick="removeFromShipmentSelection('${poLine}')">√ó</button>
                    </div>`;
                    displayArea.innerHTML += tabHtml;
                });
            }
        }
        
        // Â§ÑÁêÜÂèëË¥ßÂ§áÈÄâÊ°ÜÂèòÂåñ
        function handleShipmentCheckboxChange() {
            const checkboxes = document.querySelectorAll('.shipment-checkbox');
            
            checkboxes.forEach(checkbox => {
                const poLine = checkbox.getAttribute('data-po-line');
                const po = checkbox.getAttribute('data-po');
                const pn = checkbox.getAttribute('data-pn');
                const qty = parseFloat(checkbox.getAttribute('data-qty')) || 0;
                const rowIndex = parseInt(checkbox.getAttribute('data-row-index'));
                
                if (checkbox.checked) {
                    // Â¶ÇÊûúcheckboxË¢´checkedÔºåÊ∑ªÂä†Âà∞Map
                    if (!selectedItemsForShipment.has(poLine)) {
                        // ‰ªéÊï¥‰∏™Êï∞ÊçÆ‰∏≠ÊâæÂà∞ÂéüÂßãËÆ∞ÂΩï
                        const originalRow = tableData[rowIndex] || filteredData.find(r => r.po_line === poLine);
                        
                        selectedItemsForShipment.set(poLine, {
                            po: po,
                            pn: pn,
                            po_line: poLine,
                            qty: qty,
                            description: originalRow ? (originalRow.description || '') : '',
                            row_index: rowIndex,
                            original_row: originalRow
                        });
                    }
                } else {
                    // Â¶ÇÊûúcheckboxË¢´uncheckedÔºå‰ªéMap‰∏≠ÁßªÈô§
                    selectedItemsForShipment.delete(poLine);
                }
            });
            
            updateSelectedItemsDisplay();
        }
        
        // ‰ªéÈÄâÊã©‰∏≠ÁßªÈô§‰∏ÄÈ°π
        function removeFromShipmentSelection(poLine) {
            selectedItemsForShipment.delete(poLine);
            
            // Êõ¥Êñ∞checkboxÁä∂ÊÄÅ
            const checkbox = document.querySelector(`.shipment-checkbox[data-po-line="${poLine}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateSelectedItemsDisplay();
        }
        
        // ÊâìÂºÄÂÖ®Â±ÄÂèëË¥ßÊ®°ÊÄÅÊ°Ü
        function openGlobalShipmentModal() {
            if (selectedItemsForShipment.size === 0) {
                showStatus('Please select materials to ship', 'warning');
                return;
            }
            
            // Ê∏ÖÁ©∫Ê®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            document.getElementById('globalTrackingNo').value = '';
            document.getElementById('globalShippingMode').value = '';
            document.getElementById('globalShippingCost').value = '';
            
            // ÁîüÊàêÁâ©ÊñôÂèëË¥ßÈ°πÁõÆ
            renderShipmentItems();
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            const modalElement = document.getElementById('globalShipmentModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // Ê∏≤ÊüìÁâ©ÊñôÂèëË¥ßÈ°πÁõÆ
        function renderShipmentItems() {
            const container = document.getElementById('shipmentItemsContainer');
            container.innerHTML = '';
            
            selectedItemsForShipment.forEach((item, poLine) => {
                const description = item.description || 'Êú™Êèê‰æõ';
                const description_preview = description.length > 100 ? description.substring(0, 100) + '...' : description;
                const maxQty = item.qty || 0;
                
                const itemHtml = `
                    <div class="card mb-2" style="border: 1px solid #e2e8f0;">
                        <div class="card-body" style="padding: 12px;">
                            <div class="row align-items-center" style="display: flex; flex-wrap: nowrap; gap: 5px;">
                                <div style="flex: 0 0 100px;">
                                    <label class="form-label" style="font-weight: 600; margin-bottom: 3px; font-size: 0.8rem;">PO/Line</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-weight: 500; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${poLine}</div>
                                </div>
                                <div style="flex: 1 1 auto; min-width: 250px;">
                                    <label class="form-label" style="font-weight: 600; margin-bottom: 3px; font-size: 0.8rem;">Description</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${description}">${description}</div>
                                </div>
                                <div style="flex: 0 0 100px;">
                                    <label class="form-label" style="font-size: 0.8rem; margin-bottom: 3px;">Max Qty</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-weight: 500; font-size: 0.8rem; text-align: right;">${maxQty}</div>
                                </div>
                                <div style="flex: 0 0 110px;">
                                    <label class="form-label" style="font-size: 0.8rem; margin-bottom: 3px; display: inline;">Shipment Qty</label><span class="text-danger" style="font-size: 0.8rem;">*</span>
                                    <input type="number" class="form-control form-control-sm shipment-qty-input" data-po-line="${poLine}" data-max-qty="${maxQty}" placeholder="0" step="0.01" min="0" value="${maxQty}" style="padding: 3px 5px; font-size: 0.8rem; height: 28px; margin-top: 2px;">
                                </div>
                                <div style="flex: 0 0 30px; display: flex; align-items: center; justify-content: center; height: 55px;">
                                    <button type="button" class="btn btn-sm" style="background: none; border: none; color: #f56565; cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;" onclick="removeFromShipmentSelection('${poLine}')" title="Remove">‚úï</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHtml;
            });
        }
        
        // Á°ÆËÆ§ÂÖ®Â±ÄÂèëË¥ß
        function confirmGlobalShipment() {
            // È™åËØÅÂ∏∏ËßÑ‰ø°ÊÅØ
            const trackingNo = document.getElementById('globalTrackingNo').value.trim();
            const shippingMode = document.getElementById('globalShippingMode').value.trim();
            const shippingCostStr = document.getElementById('globalShippingCost').value.trim();
            
            if (!trackingNo) {
                showStatus('Please enter tracking number', 'error');
                return;
            }
            
            if (!shippingMode) {
                showStatus('Please select shipping method', 'error');
                return;
            }
            
            if (!shippingCostStr || parseFloat(shippingCostStr) < 0) {
                showStatus('Please enter valid shipping cost', 'error');
                return;
            }
            
            // È™åËØÅÂèëË¥ßÊï∞Èáè
            const qtyInputs = document.querySelectorAll('.shipment-qty-input');
            const shipmentData = [];
            let isValid = true;
            
            qtyInputs.forEach(input => {
                const poLine = input.getAttribute('data-po-line');
                const maxQty = parseFloat(input.getAttribute('data-max-qty'));
                const shipmentQty = parseFloat(input.value) || 0;
                
                if (shipmentQty <= 0) {
                    showStatus(`PO/Line ${poLine}: Please enter valid shipment quantity`, 'error');
                    isValid = false;
                    return;
                }
                
                if (shipmentQty > maxQty) {
                    showStatus(`PO/Line ${poLine}: Shipment quantity cannot exceed ${maxQty}`, 'error');
                    isValid = false;
                    return;
                }
                
                shipmentData.push({
                    po_line: poLine,
                    shipment_qty: shipmentQty
                });
            });
            
            if (!isValid || shipmentData.length === 0) {
                return;
            }
            
            // Ëß£ÊûêËøêË¥πÊï∞ÂÄºÔºàÂéªÊéâpossibleÁöÑ"shared:"ÂâçÁºÄÁî®‰∫éÊòæÁ§∫Ôºå‰ΩÜÂÆûÈôÖÂèëÈÄÅÁªôÂêéÁ´ØÊó∂ÂàÜÁ¶ªÔºâ
            const shippingCostValue = parseFloat(shippingCostStr);
            const itemCount = selectedItemsForShipment.size;
            
            // ÂèëÈÄÅ‰∏Ä‰∏™‰∏Ä‰∏™ÁöÑÂèëË¥ßËØ∑Ê±Ç
            showStatus('Processing shipment...', 'loading');
            
            const shipmentRequests = shipmentData.map(data => {
                const item = selectedItemsForShipment.get(data.po_line);
                return authenticatedFetch('/api/shipment/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_table: currentTable,
                        po: item.po,
                        pn: item.pn,
                        po_line: item.po_line,
                        shipment_qty: data.shipment_qty,
                        max_qty: item.qty,
                        tracking_no: trackingNo,
                        shipping_mode: shippingMode,
                        shipping_cost: shippingCostValue,
                        is_shared: itemCount > 1
                    })
                });
            });
            
            // ÊâßË°åÊâÄÊúâËØ∑Ê±Ç
            Promise.all(shipmentRequests)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÂ§±Ë¥•
                    const hasError = results.some(r => !r.success);
                    
                    if (hasError) {
                        const errors = results.filter(r => !r.success).map(r => r.message).join('; ');
                        showStatus(`Shipment partially failed: ${errors}`, 'error');
                    } else {
                        showStatus('All materials have been shipped!', 'success');
                        
                        // ÂÖ≥Èó≠modal
                        const modalElement = document.getElementById('globalShipmentModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                        
                        // ÈáçÊñ∞Âä†ËΩΩË°®Êï∞ÊçÆ
                        setTimeout(() => loadTableData(), 800);
                    }
                })
                .catch(error => {
                    showStatus(`Shipment failed: ${error}`, 'error');
                });
        }
        
        // ËÆæÁΩÆÂèëË¥ßÁ°ÆËÆ§ÊåâÈíÆ‰∫ã‰ª∂
        document.addEventListener('DOMContentLoaded', function() {
            const confirmGlobalShipmentBtn = document.getElementById('confirmGlobalShipmentBtn');
            if (confirmGlobalShipmentBtn) {
                confirmGlobalShipmentBtn.addEventListener('click', confirmGlobalShipment);
            }
        });

        // ‰ªéË°åÊìç‰Ωú‰∏≠Âà†Èô§ËÆ∞ÂΩï
        function deleteRowRecord(key, tableName) {
            if (!key) {
                showStatus('Unable to get critical fields for record', 'error');
                return;
            }
            
            // Ê†πÊçÆË°®Á±ªÂûãÁ°ÆÂÆöË¶ÅÂà†Èô§ÁöÑÂ≠óÊÆµÂêç
            const isOpenTable = (tableName === 'wf_open' || tableName === 'non_wf_open');
            const fieldName = isOpenTable ? 'po_line' : 'id';
            
            // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
            showConfirmModal(`Are you sure you want to delete this record? This action cannot be undone.`, function() {
                showStatus('Deleting record...', 'loading');
                
                // ‰ΩøÁî® POST ËØ∑Ê±ÇÔºå‰º†ÈÄí key Âíå key_field Âú®ËØ∑Ê±Ç‰Ωì‰∏≠
                authenticatedFetch(`/api/tables/${tableName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: key,
                        key_field: fieldName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record deleted successfully', 'success');
                        loadTableData(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    } else {
                        showStatus(`Delete failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Delete failed: ${error}`, 'error');
                });
            });
        }
        
        // Âà†Èô§ËÆ∞ÂΩï
        function deleteRecord() {
            const pn = document.getElementById('deletePN').value.trim();
            
            if (!pn) {
                showStatus('ËØ∑ËæìÂÖ•Ë¶ÅÂà†Èô§ËÆ∞ÂΩïÁöÑPNÂè∑', 'error');
                return;
            }
            
            // È™åËØÅPNÂè∑Ê†ºÂºèÔºàÂ∫îËØ•ÂåÖÂê´ËøûÂ≠óÁ¨¶Ôºâ
            if (!pn.includes('-')) {
                showStatus('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑPNÂè∑Ê†ºÂºèÔºàÂ¶ÇÔºö8942-9106-1100Ôºâ', 'error');
                return;
            }
            
            // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
            showConfirmModal(`Are you sure you want to delete the record with PN number ${pn}? This action cannot be undone.`, function() {
                showStatus('Deleting record...', 'loading');
                
                authenticatedFetch(`/api/tables/${currentTable}/${pn}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record deleted successfully', 'success');
                        document.getElementById('deletePN').value = '';
                        loadTableData(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
                    } else {
                        showStatus(`Delete failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Delete failed: ${error}`, 'error');
                });
            });
        }
        
        // ÊâìÂºÄÈÄÄË¥ßModal
        function openReturnShipmentModal(poLine, description, shipmentQty, closedTable, recordId) {
            try {
                // ËΩ¨Êç¢recordId‰∏∫Êï∞Â≠óÔºå‰ª•Ê≠£Á°ÆÂåπÈÖçÊï∞ÊçÆÂ∫ì‰∏≠id
                const recordIdNum = parseInt(recordId);
                
                console.log('[DEBUG] openReturnShipmentModal called with recordId:', recordId, 'parsed:', recordIdNum);
                
                const currentRow = tableData.find(row => row.id === recordIdNum);
                if (!currentRow) {
                    console.error('[ERROR] Unable to find record with id:', recordIdNum);
                    console.log('[DEBUG] tableData length:', tableData.length, 'first few ids:', tableData.slice(0, 5).map(r => r.id));
                    showStatus('Unable to get record information', 'error');
                    return;
                }
                
                // ËÆæÁΩÆÈÄÄË¥ßModalÁöÑÂÄº
                document.getElementById('returnPoLine').value = poLine;
                document.getElementById('returnDescription').value = description;
                document.getElementById('returnQty').value = shipmentQty;  // ÈªòËÆ§Â°´ÂÖ•ÊúÄÂ§ßÊï∞Èáè
                document.getElementById('returnMaxQty').value = shipmentQty;
                document.getElementById('newBatchShippingCost').value = currentRow.shipping_cost || '';
                document.getElementById('updateBatchShippingCost').checked = false;
                document.getElementById('updateShippingCostContainer').style.display = 'none';
                
                // ‰∏∫Modal‰∏çÂêçÊîπÂèòÈáèÔºå‰æõÈÄÄË¥ß‰ΩøÁî®
                document.getElementById('returnShipmentModal').dataset.closedTable = closedTable;
                document.getElementById('returnShipmentModal').dataset.recordId = recordId;
                document.getElementById('returnShipmentModal').dataset.shipmentBatchNo = currentRow.shipment_batch_no || '';
                
                console.log('[DEBUG] Set modal dataset:', {
                    closedTable: closedTable,
                    recordId: recordId,
                    shipmentBatchNo: currentRow.shipment_batch_no
                });
                
                // Ëá™Âä®Âä†ËΩΩÂêå‰∏ÄÊâπÂèëË¥ßÂè∑ÁöÑÂÖ∂‰ªñÁâ©Êñô
                const shipmentBatchNo = currentRow.shipment_batch_no;
                if (shipmentBatchNo) {
                    const batchItems = tableData.filter(row => row.shipment_batch_no === shipmentBatchNo && row.id !== recordId);
                    let infoText = `Shipping Cost: $${currentRow.shipping_cost || 'N/A'}`;
                    if (batchItems.length > 0) {
                        infoText += `<br><br><strong>Other materials in this batch:</strong><ul>`;
                        batchItems.forEach(item => {
                            infoText += `<li>${item.po_line}: ${item.description} (Qty: ${item.qty}, Cost: $${item.shipping_cost})</li>`;
                        });
                        infoText += `</ul>`;
                    }
                    document.getElementById('batchShippingCostInfo').innerHTML = infoText;
                } else {
                    document.getElementById('batchShippingCostInfo').innerHTML = `Shipping Cost: $${currentRow.shipping_cost || 'N/A'}`;
                }
                
                // ÊòæÁ§∫ Modal
                const modalElement = document.getElementById('returnShipmentModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } catch (error) {
                console.error('[ERROR] Exception in openReturnShipmentModal:', error);
                showStatus('Error opening return modal: ' + error.message, 'error');
            }
        }
        
        // Á°ÆËÆ§ÈÄÄË¥ß
        function confirmReturnShipment() {
            const returnQtyStr = document.getElementById('returnQty').value.trim();
            const maxQty = parseFloat(document.getElementById('returnMaxQty').value) || 0;
            const closedTable = document.getElementById('returnShipmentModal').dataset.closedTable;
            const recordId = document.getElementById('returnShipmentModal').dataset.recordId; // ‰ºö‰ª•‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤ÁöÑÂΩ¢Âºèreturn
            const shipmentBatchNo = document.getElementById('returnShipmentModal').dataset.shipmentBatchNo;
            const shouldUpdateBatchShippingCost = document.getElementById('updateBatchShippingCost').checked;
            
            console.log('[DEBUG] confirmReturnShipment called with:', {
                closedTable: closedTable,
                recordId: recordId,
                shipmentBatchNo: shipmentBatchNo,
                shouldUpdateBatchShippingCost: shouldUpdateBatchShippingCost
            });
            
            // È™åËØÅÈÄÄË¥ßÊï∞Èáè
            if (!returnQtyStr || returnQtyStr === '') {
                showStatus('Please enter return quantity', 'error');
                return;
            }
            
            const returnQty = parseFloat(returnQtyStr);
            if (isNaN(returnQty) || returnQty <= 0) {
                showStatus('Return quantity must be greater than 0', 'error');
                return;
            }
            
            if (returnQty > maxQty) {
                showStatus(`Return quantity cannot exceed available quantity (${maxQty})`, 'error');
                return;
            }
            
            let newShippingCost = null;
            if (shouldUpdateBatchShippingCost) {
                const newShippingCostStr = document.getElementById('newBatchShippingCost').value.trim();
                if (!newShippingCostStr) {
                    showStatus('Please enter new shipping cost for batch', 'error');
                    return;
                }
                newShippingCost = parseFloat(newShippingCostStr);
                if (isNaN(newShippingCost) || newShippingCost < 0) {
                    showStatus('Shipping cost must be a valid number >= 0', 'error');
                    return;
                }
            }
            
            // ÂèëÈÄÅÈÄÄË¥ßËØ∑Ê±Ç
            showStatus('Processing return shipment...', 'loading');
            
            const userEmail = localStorage.getItem('userEmail') || 'unknown@example.com';
            
            const requestData = {
                closed_table: closedTable,
                record_id: recordId,
                return_qty: returnQty,
                new_shipping_cost: newShippingCost,
                shipment_batch_no: shipmentBatchNo
            };
            
            console.log('[DEBUG] Sending return shipment request:', requestData);
            
            authenticatedFetch('/api/shipment/return', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-Email': userEmail
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('Return shipment processed successfully!', 'success');
                    
                    // ÂÖ≥Èó≠Modal
                    const modalElement = document.getElementById('returnShipmentModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // ÈáçÊñ∞Âä†ËΩΩË°®Êï∞ÊçÆ
                    setTimeout(() => loadTableData(), 800);
                } else {
                    showStatus(`Return failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`Return failed: ${error}`, 'error');
            });
        }
        
        // ÈÄÄË¥ßÊ®°ÊÄÅÊ°Ü‰∏≠Êõ¥Êñ∞ËøêË¥πCheckboxÁöÑ‰∫ã‰ª∂ÁõëÂê¨
        document.addEventListener('DOMContentLoaded', function() {
            const updateBatchShippingCostCheckbox = document.getElementById('updateBatchShippingCost');
            if (updateBatchShippingCostCheckbox) {
                updateBatchShippingCostCheckbox.addEventListener('change', function() {
                    const container = document.getElementById('updateShippingCostContainer');
                    container.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            const confirmReturnBtn = document.getElementById('confirmReturnBtn');
            if (confirmReturnBtn) {
                confirmReturnBtn.addEventListener('click', confirmReturnShipment);
            }
        });
        
        function updateRecordCount() {
            const countElement = document.getElementById('recordCount');
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
            countElement.textContent = `Showing records ${startIndex}-${endIndex}, Total: ${filteredData.length}`;
        }
        
        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            // Hide pagination if only one page or no data
            if (totalPages <= 1) {
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }
            
            let paginationHtml = `
                <nav aria-label="Pagination Navigation">
                    <ul class="pagination justify-content-center">
            `;
            
            // Previous page button
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">Previous</span>
                    </li>
                `;
            }
            
            // Page number buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Ensure always showing 5 page buttons (if possible)
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `
                        <li class="page-item active">
                            <span class="page-link">${i}</span>
                        </li>
                    `;
                } else {
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                }
            }
            
            // Next page button
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">Next</span>
                    </li>
                `;
            }
            
            paginationHtml += `
                    </ul>
                </nav>
            `;
            
            document.getElementById('paginationContainer').innerHTML = paginationHtml;
        }
        
        // ÂàáÊç¢È°µÈù¢
        function changePage(pageNumber) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentPage = pageNumber;
                renderTableBody();
                updateRecordCount();
                renderPagination();
            }
        }
        
        // Update table title
        function updateTableTitle() {
            const titleMap = {
                'wf_open': 'WF Open',
                'wf_closed': 'WF Closed',
                'non_wf_open': 'Non-WF Open',
                'non_wf_closed': 'Non-WF Closed'
            };
            
            const titleElement = document.getElementById('tableTitle');
            titleElement.textContent = `${titleMap[currentTable] || currentTable} Table Data`;
        }
        
        // ÊòæÁ§∫Áä∂ÊÄÅÊ∂àÊÅØ
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }
        
        // ÈöêËóèÁä∂ÊÄÅÊ∂àÊÅØ
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
        }
    </script>
</body>
</html>