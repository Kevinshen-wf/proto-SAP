<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        * {
            transition: color 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        }
        
        body {
            padding: 20px;
            background: #f5f7fa;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        
        /* æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è°ƒæ•´bodyå†…è¾¹è· */
        @media (min-width: 1600px) {
            body {
                padding: 30px 40px;
            }
        }
        @media (min-width: 1200px) and (max-width: 1599px) {
            body {
                padding: 25px 35px;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            body {
                padding: 20px 30px;
            }
        }
        @media (max-width: 991px) {
            body {
                padding: 15px 20px;
            }
        }
        
        .container-fluid {
            margin: 0 auto;
            width: 100%;
            padding-left: 0;
            padding-right: 0;
        }
        
        .container-fluid .row {
            margin-left: 0;
            margin-right: 0;
            width: 100%;
        }
        
        .container-fluid .col-md-4,
        .container-fluid .col-md-8 {
            padding-left: 0;
            padding-right: 0;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            animation: slideDown 0.5s ease;
            padding: 0;
        }
        
        .header h1 {
            font-weight: 600;
            color: #1a202c;
            font-size: 2rem;
            margin: 0;
            text-shadow: none;
        }
        
        .user-info {
            color: #4a5568;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .user-info a, .user-info button {
            background: white;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .user-info a:hover, .user-info button:hover {
            background: #f7fafc;
            border-color: #cbd5e0;
            transform: none;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table-container {
            background: white;
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            animation: fadeInUp 0.6s ease;
            border: 1px solid #e2e8f0;
            overflow-x: auto;
        }
        
        /* æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è°ƒæ•´å†…è¾¹è· */
        @media (min-width: 1600px) {
            .table-container {
                padding: 10px;
            }
        }
        @media (min-width: 1200px) and (max-width: 1599px) {
            .table-container {
                padding: 10px;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table-container {
                padding: 8px;
            }
        }
        @media (max-width: 991px) {
            .table-container {
                padding: 8px;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .table-container h5 {
            color: #1a202c;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }
        
        .editable-cell {
            cursor: text;
            padding: 6px 4px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
            min-height: 32px;
            display: table-cell;
            vertical-align: middle;
            color: #2d3748;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            overflow: visible;
            font-size: 0.9rem;
        }
        
        .editable-cell:hover {
            background: #f7fafc;
            border: 1px solid #cbd5e0;
            box-shadow: none;
        }
        
        .editing-cell {
            padding: 0;
        }
        
        .editing-cell input, .editing-cell select {
            width: 100%;
            border: 1px solid #cbd5e0;
            padding: 8px;
            box-sizing: border-box;
            border-radius: 4px;
            box-shadow: none;
            font-family: inherit;
        }
        
        /* description-cell å’Œ comment-cell ä¸­çš„æ–‡æœ¬è¾“å…¥æ¡†æ”¯æŒæ¢è¡Œ */
        .editing-cell.description-cell input,
        .editing-cell.comment-cell input {
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            overflow: visible;
            min-height: 80px;
            padding: 10px;
            line-height: 1.4;
        }
        
        /* textarea æ ·å¼ */
        .editing-cell textarea {
            font-family: inherit;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 10px;
            box-sizing: border-box;
            width: 100%;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            line-height: 1.4;
        }
        
        .editing-cell textarea:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .editing-cell input:focus, .editing-cell select:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            box-sizing: border-box;
            box-shadow: none;
        }
        
        .date-input:focus {
            border-color: #4299e1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        
        .filter-row {
            margin-bottom: 15px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .filter-row > .col,
        .filter-row > div {
            flex: 0 0 auto;
            padding-left: 5px;
            padding-right: 5px;
            min-width: 200px;
        }
        
        /* æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è°ƒæ•´æ£€ç´¢æ¡†å®½åº¦ */
        @media (max-width: 1200px) {
            .filter-row > .col,
            .filter-row > div {
                min-width: 150px;
            }
        }
        @media (max-width: 768px) {
            .filter-row > .col,
            .filter-row > div {
                min-width: 100%;
                flex: 0 0 100%;
            }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border: 1px solid transparent;
        }
        
        .btn-primary {
            background: #4299e1;
            border-color: #4299e1;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3182ce;
            border-color: #3182ce;
            transform: none;
            box-shadow: 0 2px 6px rgba(66, 153, 225, 0.15);
            color: white;
        }
        
        .btn-success {
            background: #48bb78;
            border-color: #48bb78;
            color: white;
        }
        
        .btn-success:hover {
            background: #38a169;
            border-color: #38a169;
            transform: none;
            box-shadow: 0 2px 6px rgba(72, 187, 120, 0.15);
            color: white;
        }
        
        .btn-danger {
            background: #f56565;
            border-color: #f56565;
            color: white;
        }
        
        .btn-danger:hover {
            background: #e53e3e;
            border-color: #e53e3e;
            transform: none;
            box-shadow: 0 2px 6px rgba(245, 101, 101, 0.15);
            color: white;
        }
        
        .btn-secondary {
            background: #a0aec0;
            border: none;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #718096;
            transform: none;
            box-shadow: 0 2px 6px rgba(160, 174, 192, 0.15);
        }
        
        .status-message {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideDown 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 4px solid transparent;
        }
        
        .success {
            background: #f0fdf4;
            color: #166534;
            border-left-color: #48bb78;
        }
        
        .success::before {
            content: 'âœ“';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .error {
            background: #fef2f2;
            color: #7f1d1d;
            border-left-color: #f56565;
        }
        
        .error::before {
            content: 'âœ•';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .loading {
            background: #f0f9ff;
            color: #0c4a6e;
            border-left-color: #4299e1;
        }
        
        .loading::before {
            content: 'âŸ³';
            display: inline-block;
            animation: spin 1s linear infinite;
        }
        
        .warning {
            background: #fffbeb;
            color: #854d0e;
            border-left-color: #ed8936;
        }
        
        .warning::before {
            content: 'âš ';
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .table {
            margin-bottom: 0;
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            padding: 12px 8px;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 80px;
        }
        
        .table td {
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 10px 8px;
            color: #4a5568;
            border-color: #e2e8f0;
            min-width: 80px;
        }
        
        /* Description å’Œ Comment åˆ—çš„ç‰¹æ®Šæ ·å¼ - æ”¯æŒæ¢è¡Œï¼Œä½¿ç”¨!importantä¿è¯ä¼˜å…ˆçº§ */
        .table td.description-cell,
        .table td.comment-cell {
            white-space: nowrap !important;
            word-wrap: normal !important;
            word-break: normal !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            max-width: 140px !important;
            min-height: 32px !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
            line-height: 1.4 !important;
        }
        
        /* PO PN eta_wfsz ç­‰åˆ—ä¸èƒ½ç”¨çœç•¥å·ï¼Œå¿…é¡»å®Œæ•´æ’æµè½®æ¢è¡Œæ°´å¹³æ•£å¸ƒ */
        .table td.no-ellipsis-cell {
            white-space: normal !important;
            word-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
            min-height: 32px !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
            line-height: 1.3 !important;
            font-size: 0.85rem !important;
        }
        
        /* shipping_cost åˆ—ä¸èƒ½æœ‰çœç•¥å·ï¼Œéœ€è¦å®Œæ•´æ˜¾ç¤º shipping cost å€¼ï¼ˆä¾‹å¦‚ s:â‚¬100.00ï¼‰ */
        .table td.shipping-cost-cell {
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow: visible !important;
            text-overflow: clip !important;
            min-width: 110px !important;
            vertical-align: middle !important;
            padding: 6px 4px !important;
        }
        
        /* å“åº”å¼ï¼šæ ¹æ®å±å¹•å¤§å°è°ƒæ•´ Description å’Œ Comment çš„æœ€å¤§å®½åº¦ */
        @media (min-width: 1600px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 180px !important;
            }
        }
        @media (min-width: 1400px) and (max-width: 1599px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 170px !important;
            }
        }
        @media (min-width: 1200px) and (max-width: 1399px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 160px !important;
            }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 150px !important;
            }
        }
        @media (min-width: 768px) and (max-width: 991px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 140px !important;
                font-size: 0.9rem;
            }
        }
        @media (max-width: 767px) {
            .table td.description-cell,
            .table td.comment-cell {
                max-width: 120px !important;
                font-size: 0.8rem;
            }
        }
        /* æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è°ƒæ•´åˆ—å®½ */
        @media (min-width: 1600px) {
            .table th, .table td { min-width: 80px; }
            /* description å’Œ comment åˆ—è·å¾—æ›´å®½çš„ç©ºé—´ */
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 1400px) and (max-width: 1599px) {
            .table th, .table td { min-width: 70px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 1200px) and (max-width: 1399px) {
            .table th, .table td { min-width: 60px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 992px) and (max-width: 1199px) {
            .table th, .table td { min-width: 50px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (min-width: 768px) and (max-width: 991px) {
            .table th, .table td { min-width: 40px; font-size: 0.9rem; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        @media (max-width: 767px) {
            .table th, .table td { min-width: 30px; font-size: 0.8rem; padding: 8px 6px; }
            .table td.description-cell,
            .table td.comment-cell { min-width: 0; }
        }
        
        .table tbody tr:hover {
            background: #f7fafc;
            box-shadow: none;
            border-left: 3px solid #4299e1;
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* æ•°æ®éªŒè¯é”™è¯¯è¡Œæ ·å¼ */
        .invalid-row {
            background: #fef2f2 !important;
            color: #7f1d1d;
        }
        
        .invalid-row:hover {
            background: #fed7d7 !important;
        }
        
        .invalid-row td {
            border-color: #fca5a5 !important;
        }
        
        /* æ¤œç´¢æ¡†æ ·å¼è°ƒæ•´ */
        .filter-row .col {
            padding-left: 5px;
            padding-right: 5px;
            position: relative;
            min-width: auto;
        }
        
        /* æ—¥æœŸè¾“å…¥æ¡†æ ·å¼ */
        .date-filter {
            min-width: 140px;
        }
        
        .date-filter-mode {
            font-size: 0.875rem;
        }
        
        .clear-filter-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            white-space: nowrap;
            width: 100%;
        }
        
        /* å“åº”å¼ä¸‰å±å¹• */
        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .table-container {
                padding: 15px;
            }
            
            .filter-row {
                padding: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .user-info {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .user-info a,
            .user-info button {
                width: 100%;
                text-align: center;
            }
            
            .filter-row {
                padding: 10px;
            }
        }
        
        .pagination {
            gap: 5px;
        }
        
        .page-link {
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            color: #4a5568;
            transition: all 0.3s ease;
        }
        
        .page-link:hover {
            background: #f7fafc;
            color: #4299e1;
            border-color: #cbd5e0;
        }
        
        .page-item.active .page-link {
            background: #4299e1;
            border-color: #4299e1;
            color: white;
        }
        
        /* å¤é€‰æ¡†æ ·å¼ */
        .checkbox-cell {
            text-align: center;
            width: 50px;
        }
        
        /* æ“ä½œåˆ—æ ·å¼ */
        .action-cell {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            width: 130px !important;
            min-width: 130px !important;
            max-width: 130px !important;
        }
        
        .shipment-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        /* å›é€€æŒ‰é’®æ ·å¼ */
        .return-shipment-btn {
            background: #ffc107;
            border: 1px solid #ff9800;
            color: #333;
            transition: all 0.3s ease;
            font-weight: bold;
            min-width: 32px !important;
        }
        
        .return-shipment-btn:hover {
            background: #ff9800;
            border-color: #f57c00;
            color: white;
            transform: scale(1.05);
        }
        
        .return-shipment-btn:active {
            transform: scale(0.95);
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 2px 6px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background: #fed7d7;
            color: #e53e3e;
        }
        
        /* å…¨å±€å‘è´§æŒ‰é’®åŒºåŸŸ */
        .shipment-button-area {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .selected-items-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .selected-tab {
            background: #e6f2ff;
            border: 1px solid #4299e1;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .selected-tab .remove-btn {
            background: none;
            border: none;
            color: #f56565;
            cursor: pointer;
            font-weight: bold;
            padding: 0 3px;
        }
        
        .selected-tab .remove-btn:hover {
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="header">
            <h1>Purchase Order Management System</h1>
            <div class="user-info">
                <span id="currentUser">Not Logged In</span>
                <a href="/register.html" id="registerLink">Register</a>
                <a href="/login.html" id="loginLink" style="display: inline-block;">Login</a>
                <button id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </div>
        
        <!-- å¯¼èˆªæŒ‰é’® -->
        <div class="mb-3">
            <a href="/" class="btn btn-primary">
                ğŸ“Š Database Management
            </a>
            <a href="/pdf_import.html" class="btn btn-secondary">
                ğŸ“¤ PDF Import
            </a>
        </div>
        
        <!-- çŠ¶æ€æ¶ˆæ¯åŒºåŸŸ -->
        <div id="statusMessage" class="status-message" style="display: none;"></div>
        
        <!-- è¡¨é€‰æ‹© -->
        <div class="row mb-3">
            <div class="col-md-4">
                <select class="form-select" id="tableSelect">
                    <option value="wf_open">WF Open</option>
                    <option value="wf_closed">WF Closed</option>
                    <option value="non_wf_open">Non-WF Open</option>
                    <option value="non_wf_closed">Non-WF Closed</option>
                </select>
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-primary me-2" onclick="loadTableData()">
                    ğŸ”„ Refresh Data
                </button>
                <button class="btn btn-success" onclick="showInsertForm()">
                    â• Insert New Record
                </button>
            </div>
        </div>
        
        <!-- å…¨å±€å‘è´§æŒ‰é‘’åŒºåŸŸ (ä»…åœ¨Openè¡¨æ˜¾ç¤º) -->
        <div id="shipmentButtonArea" class="shipment-button-area" style="display: none;">
            <button class="btn btn-warning me-2" onclick="openGlobalShipmentModal()" id="globalShipmentBtn">
                ğŸ“¦ Shipment
            </button>
            <button class="btn btn-info me-2" onclick="openBatchUpdateModal()" id="batchUpdateBtn">
                âœï¸ Batch Update
            </button>
            <div class="selected-items-tabs" id="selectedItemsDisplay">
                <!-- å·²é€‰é¡¹ç›®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
            </div>
        </div>
        
        <!-- æ’å…¥è¡¨å• (é»˜è®¤éšè—) -->
        <div id="insertFormContainer" class="table-container" style="display: none;">
            <h5>Insert New Record</h5>
            <div id="insertFormFields" class="row g-2"></div>
            <div class="mt-2">
                <button class="btn btn-success me-2" onclick="insertRecord()">Insert</button>
                <button class="btn btn-secondary" onclick="hideInsertForm()">Cancel</button>
            </div>
        </div>
        

        
        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="table-container">
            <h5 id="tableTitle">WF Open Table Data</h5>
            <div id="filterRow" class="filter-row"></div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead id="tableHeader">
                        <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </thead>
                    <tbody id="tableBody">
                        <!-- è¡¨ä½“å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            <div id="recordCount" class="mt-2 text-muted"></div>
            <div id="paginationContainer" class="mt-3"></div>
        </div>
    </div>

    <!-- Bootstrap Modal for Confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Operation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                                        Are you sure you want to perform this operation?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmModalButton">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±€å‘è´§æ¨¡æ€æ¡† -->
    <div class="modal fade" id="globalShipmentModal" tabindex="-1" style="overflow-y: auto;">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- å…¨å±€ä¿¡æ¯è¾“å…¥ -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h6 class="mb-0">Shipment Information</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Tracking Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="globalTrackingNo" placeholder="Enter tracking number">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Shipping Mode <span class="text-danger">*</span></label>
                                    <select class="form-select" id="globalShippingMode">
                                        <option value="">Please select...</option>
                                        <option value="sea">Sea</option>
                                        <option value="air">Air</option>
                                        <option value="train">Train</option>
                                        <option value="truck">Truck</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Shipping Cost <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="globalShippingCost" placeholder="Enter shipping cost" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç‰©æ–™å‘è´§ä¿¡æ¯ -->
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Material Shipment Quantity</h6>
                        </div>
                        <div class="card-body" id="shipmentItemsContainer" style="max-height: 400px; overflow-y: auto;">
                            <!-- ç‰©æ–™é¡¹å°†åŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmGlobalShipmentBtn">Confirm Shipment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€€è´§æ¨¡æ€æ¡† -->
    <div class="modal fade" id="returnShipmentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Return Shipment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">PO/Line</label>
                            <input type="text" class="form-control" id="returnPoLine" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" id="returnDescription" readonly>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Return Quantity <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="returnQty" placeholder="0" step="0.01" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Max Available Qty</label>
                            <input type="text" class="form-control" id="returnMaxQty" readonly>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <strong>Shipping Cost for same batch:</strong>
                        <p id="batchShippingCostInfo" style="margin: 10px 0;"></p>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="updateBatchShippingCost">
                            <label class="form-check-label" for="updateBatchShippingCost">
                                Update shipping cost for other materials in same batch
                            </label>
                        </div>
                        <div id="updateShippingCostContainer" style="display: none; margin-top: 10px;">
                            <label class="form-label">New Shipping Cost</label>
                            <input type="number" class="form-control" id="newBatchShippingCost" placeholder="0" step="0.01" min="0">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmReturnBtn">Confirm Return</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡ä¿®æ”¹æ¨¡æ€æ¡† -->
    <div class="modal fade" id="batchUpdateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Batch Update</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong id="batchUpdateCount">0</strong> records selected
                    </div>
                    <div id="batchUpdateFields" class="row g-3">
                        <!-- Fields will be dynamically added here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmBatchUpdateBtn">Confirm Update</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        function checkLoginStatus() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login.html';
                return false;
            }
            return true;
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!checkLoginStatus()) {
            // å¦‚æœæœªç™»å½•ï¼Œé˜»æ­¢é¡µé¢ç»§ç»­åŠ è½½
            document.addEventListener('DOMContentLoaded', function() {
                document.body.innerHTML = '<div style="text-align: center; padding: 50px;"><h2>Please log in first</h2><p>Redirecting to login page...</p></div>';
            });
        }
        
        // è´§å¸ç¬¦å·æ˜ å°„
        const currencyMap = {
            'wefabricate': 'â‚¬',
            'centurion': '$',
            'magic_fx': 'â‚¬'
        };
        
        // è·å–å…¬å¸çš„è´§å¸ç¬¦å·
        function getCurrencySymbol(company) {
            return currencyMap[company] || '';
        }
        
        // å…¨å±€å˜é‡
        let currentTable = 'wf_open';
        let tableData = [];
        let originalData = [];
        let filteredData = []; // ç”¨äºå­˜å‚¨è¿‡æ»¤åçš„æ•°æ®
        let columnNames = [];
        let columns = []; // è¡¨åˆ—æ•°ç»„
        let dateColumns = ['req_date_wf', 'eta_wfsz', 'latest_departure_date', 'po_placed_date', 'req_date'];
        let currentEditingCell = null; // è·Ÿè¸ªå½“å‰æ­£åœ¨ç¼–è¾‘çš„å•å…ƒæ ¼
        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // å…¨å±€å‘è´§ç›¸å…³å˜é‡
        let selectedItemsForShipment = new Map(); // å­˜å‚¨å·²é€‰æ‹©çš„é¡¹ç›®: key=po_line, value=ç‰©æ–™ä¿¡æ¯
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log("é¡µé¢DOMå†…å®¹åŠ è½½å®Œæˆ");
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                if (!checkLoginStatus()) {
                    return;
                }
                
                // æ˜¾ç¤ºå½“å‰ç”¨æˆ·
                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    const currentUserElement = document.getElementById('currentUser');
                    const logoutBtn = document.getElementById('logoutBtn');
                    const loginLink = document.getElementById('loginLink');
                    const registerLink = document.getElementById('registerLink');
                    
                    if (currentUserElement) {
                        currentUserElement.textContent = currentUser.email;
                    }
                    
                    if (logoutBtn) {
                        logoutBtn.style.display = 'inline-block';
                    }
                    
                    if (loginLink) {
                        loginLink.style.display = 'none';
                    }
                    
                    if (registerLink) {
                        registerLink.style.display = 'none';
                    }
                }
                
                // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const requiredElements = [
                    'tableSelect',
                    'insertForm',
                    'insertFormFields',
                    'tableContainer',
                    'tableHeader',
                    'tableBody',
                    'filterRow',
                    'recordCount',
                    'paginationContainer'
                ];
                
                requiredElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    if (!element) {
                        console.warn(`æœªæ‰¾åˆ°idä¸º'${elementId}'çš„å…ƒç´ `);
                    }
                });
                
                loadTableData();
                
                // ç›‘å¬è¡¨é€‰æ‹©å˜åŒ–
                const tableSelect = document.getElementById('tableSelect');
                if (tableSelect) {
                    tableSelect.addEventListener('change', function() {
                        currentTable = this.value;
                        // æ¸…é™¤è¿‡æ»¤å™¨
                        clearAllFilters();
                        loadTableData();
                    });
                }
                
                // ç›‘å¬å…¨å±€é”®ç›˜äº‹ä»¶
                document.addEventListener('keydown', function(event) {
                    // é¿å…åœ¨è¾“å…¥æ¡†ä¸­æŒ‰é”®æ—¶è§¦å‘å…¨å±€äº‹ä»¶
                    if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    if (currentEditingCell) {
                        if (event.key === 'Escape') {
                            // ESCé”®å–æ¶ˆç¼–è¾‘
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                const originalValue = input.getAttribute('data-original-value');
                                input.value = originalValue || '';
                                // è§¦å‘changeäº‹ä»¶æ›´æ–°æ•°æ®æ¨¡å‹
                                input.dispatchEvent(new Event('change'));
                                // ç»“æŸç¼–è¾‘çŠ¶æ€
                                currentEditingCell.textContent = originalValue || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        } else if (event.key === 'Enter') {
                            // Enteré”®ä¿å­˜ç¼–è¾‘
                            const input = currentEditingCell.querySelector('input');
                            if (input) {
                                input.dispatchEvent(new Event('change'));
                                currentEditingCell.textContent = input.value || '';
                                currentEditingCell.classList.remove('editing-cell');
                                currentEditingCell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        }
                    }
                });
                
                // æ·»åŠ é€€å‡ºæŒ‰é’®äº‹ä»¶ç›‘å¬
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', function() {
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                    });
                }
                
                // ä¸ºç¡®è®¤æ¨¡æ€æ¡†æ·»åŠ éšè—äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿æ­£å¸¸å…³é—­
                const confirmModal = document.getElementById('confirmModal');
                if (confirmModal) {
                    confirmModal.addEventListener('hidden.bs.modal', function() {
                        // ç£¨é™¤æ‰€æœ‰ backdrop
                        document.querySelectorAll('.modal-backdrop').forEach(el => {
                            el.remove();
                        });
                        // ç§»é™¤ body çš„ modal-open ç±»
                        document.body.classList.remove('modal-open');
                        document.body.style.paddingRight = '';
                    });
                }
                
                console.log("é¡µé¢åˆå§‹åŒ–å®Œæˆ");
            } catch (error) {
                console.error("é¡µé¢åˆå§‹åŒ–å‡ºé”™:", error);
            }
        });
        
        // å¸¦è®¤è¯çš„fetchå‡½æ•°
        function authenticatedFetch(url, options = {}) {
            // è·å–å­˜å‚¨çš„token
            const token = localStorage.getItem('authToken');
            if (!token) {
                // å¦‚æœæ²¡æœ‰tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/login.html';
                throw new Error('æœªç™»å½•');
            }
            
            // æ·»åŠ è®¤è¯å¤´
            options.headers = options.headers || {};
            options.headers['Authorization'] = `Bearer ${token}`;
            
            // æ·»åŠ ç”¨æˆ·é‚®ç®±å¤´
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser && currentUser.email) {
                options.headers['X-User-Email'] = currentUser.email;
            }
            
            return fetch(url, options)
                .then(response => {
                    if (response.status === 401) {
                        // Tokenæ— æ•ˆæˆ–è¿‡æœŸï¼Œæ¸…é™¤æœ¬åœ°å­˜å‚¨å¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('currentUser');
                        window.location.href = '/login.html';
                        throw new Error('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                    }
                    return response;
                })
                .catch(error => {
                    if (error.message === 'è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•') {
                        throw error;
                    }
                    // å…¶ä»–é”™è¯¯ç»§ç»­æŠ›å‡º
                    throw error;
                });

                
        }
        
        // è·å–è¡¨çš„åˆ—å
        function getColumnNames(tableName) {
            // æ ¹æ®è¡¨åè¿”å›å¯¹åº”çš„åˆ—é¡ºåº
            // æ³¨æ„: id å’Œ update_at å­—æ®µåº”è¯¥è¢«æ’é™¤éœ€ä¸æ˜¾ç¤º
            const tableColumns = {
                'wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'wfsz_shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'latest_departure_date', 'chinese_name', 'unit', 'company'],
                'wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'eta_wfsz', 'wfsz_shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'chinese_name', 'unit', 'company'],
                'non_wf_open': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'record_no', 'shipping_cost', 'tracking_no', 'so_number', 'company'],
                'non_wf_closed': ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date', 'eta_wfsz', 'shipping_mode', 'comment', 'po_placed_date', 'purchaser', 'shipping_cost', 'tracking_no', 'so_number', 'company']
            };
            
            // è¿”å›å¯¹åº”è¡¨çš„åˆ—é¡ºåºï¼Œå¦‚æœæ²¡æœ‰å®šä¹‰åˆ™è¿”å›é»˜è®¤é¡ºåº
            return tableColumns[tableName] || ['po', 'pn', 'line', 'po_line', 'description', 'qty', 'net_price', 'total_price', 'req_date_wf', 'po_placed_date', 'purchaser', 'company'];
        }
        
        // è·å–åˆ—çš„æ˜¾ç¤ºåç§°
        function getColumnDisplayName(columnName) {
            const displayNameMap = {
                'wfsz_shipping_mode': 'ship_mode',
                'shipping_mode': 'ship_mode',
                'so_number': 'so_no',
                'latest_departure_date': 'dep_date',
                'po_placed_date': 'placed_date',
                'shipping_cost': 'ship_cost'
            };
            
            return displayNameMap[columnName] || columnName;
        }
        
        // åŠ è½½è¡¨æ•°æ®
        function loadTableData() {
            showStatus('Loading data...', 'loading');
            
            // æ¸…é™¤é€‰æ‹©çš„å‘è´§é¡¹ç›®
            selectedItemsForShipment.clear();
            
            authenticatedFetch(`/api/tables/${currentTable}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        tableData = data.data;
                        // ç¡®ä¿æ•°æ®æŒ‰update_até™åºæ’åˆ—ï¼ˆæœ€æ–°æ›´æ–°çš„æ•°æ®ä¼˜å…ˆï¼‰
                        // æ£€æŸ¥æ‰€æœ‰è®°å½•ä¸­æ˜¯å¦æœ‰ä»»ä½•è®°å½•æœ‰update_atå­—æ®µ
                        const hasUpdateAtField = tableData && tableData.length > 0 && tableData.some(row => row.update_at);
                        if (hasUpdateAtField) {
                            tableData.sort((a, b) => {
                                const dateA = a.update_at ? new Date(a.update_at).getTime() : 0;
                                const dateB = b.update_at ? new Date(b.update_at).getTime() : 0;
                                console.log(`æ’åº: ${a.po_line || 'unknown'} (${a.update_at}) = ${dateA}, ${b.po_line || 'unknown'} (${b.update_at}) = ${dateB}, ç»“æœ=${dateB - dateA}`);
                                return dateB - dateA; // æŒ‰æ›´æ–°æ—¶é—´é™åº
                            });
                        }
                        filteredData = [...tableData]; // åˆå§‹åŒ–è¿‡æ»¤æ•°æ®
                        // æ ¹æ®è¡¨åè·å–æ­£ç¡®çš„åˆ—é¡ºåº
                        columnNames = getColumnNames(currentTable);
                        // åŒæ—¶ä¿æŒoriginalDataä¹Ÿæ˜¯æ’åºå¥½çš„ï¼ˆé‡è¦ï¼ï¼‰
                        originalData = JSON.parse(JSON.stringify(tableData));
                        // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                        currentPage = 1;
                        renderTable();
                        // ç¡®ä¿è¿‡æ»¤è¡Œåœ¨æ•°æ®åŠ è½½åæ­£ç¡®æ˜¾ç¤º
                        setTimeout(() => {
                            renderFilterRow();
                        }, 0);
                        hideStatus();
                    } else {
                        showStatus(`Data loading failed: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Data loading failed: ${error}`, 'error');
                });
        }
        
        // ... existing code ...
        
        // è‡ªåŠ¨è°ƒæ•´åˆ—å®½
        function adjustColumnWidths() {
            const table = document.querySelector('.table');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            if (rows.length === 0) return;
            
            const headerCells = table.querySelectorAll('thead th');
            const maxWidths = new Map();
            const minColumnWidth = 80; // æœ€å°åˆ—å®½
            
            // è®¾ç½®ç‰¹å®šåˆ—çš„é¢„è®¾æœ€å¤§å®½åº¦
            const columnMaxWidths = {
                'description': 140,
                'comment': 150,
                'po': 110,
                'pn': 110,
                'line': 50,
                'po_line': 110,
                'qty': 90,
                'net_price': 90,
                'total_price': 100,
                'company': 110,
                'purchaser': 110,
                'record_no': 95,
                'shipping_cost': 110,
                'ship_cost': 110,
                'tracking_no': 110,
                'eta_wfsz': 110,
                'req_date_wf': 100,
                'req_date': 100,
                'po_placed_date': 100,
                'placed_date': 100,
                'wfsz_shipping_mode': 70,
                'shipping_mode': 70,
                'ship_mode': 70,
                'so_number': 70,
                'so_no': 70,
                'latest_departure_date': 90,
                'dep_date': 90,
                'Actions': 130
            };
            
            // éå†è¡¨å¤´è·å–åˆ—å
            headerCells.forEach((th, colIndex) => {
                const columnName = th.textContent.trim();
                
                // Actionsåˆ—å•å•ç‹¬å¤„ç†
                if (columnName === 'Actions') {
                    // æ ¹æ®è¡¨ç±»å‹åŠ¨æ€è®¾ç½®å®½åº¦: openè¡¨ä¸éœ€è¦é€€è´§æŒ‰é’®, æ‰€ä»¥å®½åº¦è¾ƒå°; closedè¡¨æœ‰é€€è´§æŒ‰é’®, éœ€è¦æ›´å¤§çš„å®½åº¦
                    const isOpen = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
                    const actionWidth = isOpen ? 65 : 140;
                    th.style.width = actionWidth + 'px';
                    th.style.minWidth = actionWidth + 'px';
                    th.style.maxWidth = actionWidth + 'px';
                    th.style.fontSize = '0.9rem';
                    return;
                }
                
                let maxWidth = columnMaxWidths[columnName] || 150;
                let width = columnName.length * 8 + 16; // å…ˆç”¨æ ‡é¢˜å®½åº¦
                
                // è®¡ç®—è¯¥åˆ—ä¸­æ‰€æœ‰å†…å®¹çš„æœ€å¤§å®½åº¦
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    if (cells[colIndex]) {
                        const cell = cells[colIndex];
                        const text = cell.textContent.trim();
                        // ä¼°ç®—æ–‡æœ¬å®½åº¦ï¼ˆç²—ç•¥è®¡ç®—ï¼‰
                        const estimatedWidth = Math.ceil(text.length * 7 + 16); // æ¯ä¸ªå­—ç¬¦çº¦7px + padding
                        width = Math.max(width, estimatedWidth);
                    }
                });
                
                // å–æœ€å°å€¼å’Œè®¾å®šçš„æœ€å¤§å€¼
                const finalWidth = Math.min(Math.max(width, minColumnWidth), maxWidth);
                maxWidths.set(colIndex, finalWidth);
            });
            
            // åº”ç”¨åˆ—å®½
            headerCells.forEach((th, colIndex) => {
                const width = maxWidths.get(colIndex);
                if (width) {
                    th.style.width = width + 'px';
                    th.style.minWidth = width + 'px';
                    th.style.maxWidth = width + 'px';
                    th.style.overflow = 'hidden';
                    th.style.textOverflow = 'ellipsis';
                    th.style.whiteSpace = 'nowrap';
                    th.style.fontSize = '0.9rem';
                }
            });
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                cells.forEach((cell, colIndex) => {
                    // Actionsåˆ—ï¼ˆç¬¬ä¸€åˆ—ï¼‰
                    if (colIndex === 0) {
                        // æ ¹æ®è¡¨ç±»å‹è®¾ç½®å®½åº¦: openè¡¨è¾ƒå°, closedè¡¨è¾ƒå¤§
                        const isOpen = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
                        const actionWidth = isOpen ? 65 : 140;
                        cell.style.width = actionWidth + 'px';
                        cell.style.minWidth = actionWidth + 'px';
                        cell.style.maxWidth = actionWidth + 'px';
                        return;
                    }
                    
                    const width = maxWidths.get(colIndex);
                    if (width) {
                        cell.style.width = width + 'px';
                        cell.style.minWidth = width + 'px';
                        cell.style.maxWidth = width + 'px';
                    }
                });
            });
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            renderTableHeader();
            renderTableBody();
            renderFilterRow();  // æ¢å¤è¿‡æ»¤è¡Œæ¸²æŸ“
            updateRecordCount();
            renderPagination();
            updateTableTitle();
            // åº”ç”¨è‡ªåŠ¨åˆ—å®½
            setTimeout(() => adjustColumnWidths(), 0);
        }
        
        // æ¸²æŸ“è¡¨ä½“
        function renderTableBody() {
            const body = document.getElementById('tableBody');
            body.innerHTML = '';
            
            // è®¡ç®—åˆ†é¡µæ•°æ®
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredData.length);
            const paginatedData = filteredData.slice(startIndex, endIndex);
            
            let tableHtml = '';
            paginatedData.forEach((row, index) => {
                // ä½¿ç”¨å®é™…çš„è¡Œç´¢å¼•è€Œä¸æ˜¯åˆ†é¡µåçš„ç´¢å¼•
                const rowIndex = startIndex + index;
                
                // æ£€æŸ¥ qty*net_price æ˜¯å¦ç­‰äº total_price
                const qty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = qty * netPrice;
                
                // æ£€æŸ¥è®¡ç®—å€¼æ˜¯å¦ä¸æ€»ä»·åŒ¹é…ï¼ˆè€ƒè™‘æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼‰
                const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
                
                // æ„å»ºè¡Œçš„classå±æ€§
                let rowClass = '';
                if (isInvalidRow) {
                    rowClass = 'invalid-row';
                }
                
                let rowHtml = `<tr data-row-index="${rowIndex}" class="${rowClass}">`;
                
                // å…ˆæ·»åŠ æ“ä½œåˆ—
                const pn = row['pn'] || '';
                const po = row['po'] || '';
                const poLine = row['po_line'] || '';
                const id = row['id'] || '';
                const rowQty = parseFloat(row.qty) || 0;
                const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
                
                rowHtml += `<td style="text-align: center;" class="action-cell">`;
                
                // å¤é€‰æ¡† (æ‰€æœ‰è¡¨æ ¼éƒ½æ˜¾ç¤º)
                const isChecked = selectedItemsForShipment.has(poLine) ? 'checked' : '';
                rowHtml += `<input type="checkbox" class="shipment-checkbox" data-po-line="${poLine}" data-po="${po}" data-pn="${pn}" data-qty="${rowQty}" data-row-index="${rowIndex}" ${isChecked} onchange="handleShipmentCheckboxChange()" />`;
                
                // åˆ é™¤æŒ‰é’® - æ ¹æ®è¡¨ç±»å‹ä¼ é€’ä¸åŒçš„ä¸»é”®
                const deleteKey = isOpenTable ? poLine : id;
                const deleteKeyDisplay = isOpenTable ? poLine : id;
                rowHtml += `<button class="delete-btn" onclick="deleteRowRecord('${deleteKey}', '${currentTable}')" title="åˆ é™¤æ­¤è®°å½•">âœ•</button>`;
                
                // é€€è´§æŒ‰é’® (ä»…åœ¨closedè¡¨æ˜¾ç¤º)
                const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
                if (isClosedTable) {
                    const shipmentQty = parseFloat(row.qty) || 0;
                    const poLineStr = String(poLine).replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/"/g, '\\"');
                    // æ›´å®Œå–„çš„è½¬ä¹‰ï¼šå¤„ç†æ¢è¡Œç¬¦ã€å¼•å·ç­‰ç‰¹æ®Šå­—ç¬¦
                    const descriptionStr = String(row.description || '')
                        .replace(/\\/g, '\\\\\\\\')
                        .replace(/"/g, '\\"')
                        .replace(/'/g, "\\'") 
                        .replace(/\n/g, ' ')
                        .replace(/\r/g, '')
                        .substring(0, 100);
                    // ç¡®ä¿ recordId æ˜¯æœ‰æ•ˆçš„ id å€¼ï¼ˆä¼šè‡ªåŠ¨è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼‰
                    const recordIdValue = id && id !== '' ? String(id) : String(rowIndex);
                    rowHtml += `<button class="btn btn-sm return-shipment-btn" onclick="openReturnShipmentModal('${poLineStr}', '${descriptionStr}', ${shipmentQty}, '${currentTable}', '${recordIdValue}')" title="é€€è´§" style="padding: 4px 6px; font-size: 12px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">â†©</button>`;
                }
                
                rowHtml += `</td>`;
                // å†æ·»åŠ æ•°æ®åˆ—
                columnNames.forEach(col => {
                    const value = row[col] !== null ? row[col] : '';
                    // æ ¼å¼åŒ–æ—¥æœŸå€¼
                    let displayValue = value;
                    if (value && typeof value === 'object' && value.hasOwnProperty('$$date')) {
                        // å¤„ç†ç‰¹æ®Šæ—¥æœŸæ ¼å¼
                        const date = new Date(value.$$date);
                        displayValue = date.toLocaleDateString('zh-CN');
                    } else if (value && typeof value === 'string' && value.includes('GMT')) {
                        // å¤„ç†GMTæ—¥æœŸå­—ç¬¦ä¸²
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                displayValue = date.toLocaleDateString('zh-CN');
                            }
                        } catch (e) {
                            // å¦‚æœä¸æ˜¯æœ‰æ•ˆæ—¥æœŸï¼Œä¿æŒåŸå€¼
                            displayValue = value;
                        }
                    } else if (value === null || value === 'None' || value === 'null') {
                        displayValue = '';
                    }
                    
                    // ä¸ºä»·æ ¼å­—æ®µæ·»åŠ è´§å¸ç¬¦å·
                    if ((col === 'net_price' || col === 'total_price' || col === 'shipping_cost') && displayValue !== '') {
                        const company = row['company'] || '';
                        const currency = getCurrencySymbol(company);
                        if (currency && !isNaN(parseFloat(displayValue))) {
                            // ä¸ºshipping_costå­—æ®µï¼Œæ£€æŸ¥æ˜¯å¦ä¸ºå…±äº«è¿è´¹
                            if (col === 'shipping_cost') {
                                const currentShippingCost = parseFloat(displayValue);
                                const currentBatchNo = row['shipment_batch_no'];
                                
                                // ç»Ÿè®¡åŒä¸€æ‰¹æ¬¡ä¸­æ˜¯å¦æœ‰å¤šæ¡è®°å½•å…±äº«è¿è´¹
                                // åªæœ‰å½“å­˜åœ¨shipment_batch_noä¸”æœ‰å¤šæ¡è®°å½•æ—¶ï¼Œæ‰æ˜¾ç¤ºshared:
                                let shouldShowShared = false;
                                if (currentBatchNo && currentBatchNo !== null && currentBatchNo !== '') {
                                    // ç»Ÿè®¡åŒä¸€æ‰¹æ¬¡ä¸­ç›¸åŒshipping_costçš„è®°å½•æ•°
                                    const sameBatchAndCostCount = paginatedData.filter(r => {
                                        const rBatchNo = r['shipment_batch_no'];
                                        const rShippingCost = parseFloat(r.shipping_cost || 0);
                                        return rBatchNo === currentBatchNo && 
                                               rShippingCost === currentShippingCost && 
                                               r.shipping_cost !== null && 
                                               r.shipping_cost !== '';
                                    }).length;
                                    
                                    // åŒä¸€æ‰¹æ¬¡ä¸­æœ‰å¤šæ¡è®°å½•æ—¶æ˜¾ç¤ºshared:
                                    shouldShowShared = sameBatchAndCostCount > 1;
                                }
                                
                                if (shouldShowShared) {
                                    displayValue = 's:' + currency + currentShippingCost;
                                } else {
                                    displayValue = currency + currentShippingCost;
                                }
                            } else {
                                // æ˜¾ç¤ºçœŸå®å°æ•°ä½æ•°ï¼Œä¸è¿›è¡Œå››èˆäº”å…¥
                                displayValue = currency + parseFloat(displayValue);
                            }
                        }
                    }
                    
                    // å¤„ç†companyå­—æ®µï¼šæ”¹å¸ƒæ— æ•ˆå€¼ä¸ºç©ºå­—ç¬¦ä¸²
                    if (col === 'company' && (displayValue === 'undefined' || displayValue === 'null' || displayValue === 'None')) {
                        displayValue = '';
                    }
                    
                    // ç¡®ä¿ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®è½¬ä¹‰
                    const escapedValue = String(displayValue).replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                    
                    // ä¸º description å’Œ comment åˆ—æ·»åŠ ç‰¹æ®Šçš„ç±»åä»¥æ”¯æŒæ¢è¡Œ
                    let cellClass = 'editable-cell';
                    if (col === 'description') {
                        cellClass += ' description-cell';
                    } else if (col === 'comment') {
                        cellClass += ' comment-cell';
                    } else if (col === 'shipping_cost') {
                        cellClass += ' shipping-cost-cell';
                    } else if (col === 'po' || col === 'pn' || col === 'eta_wfsz') {
                        cellClass += ' no-ellipsis-cell';
                    }
                    
                    rowHtml += `<td class="${cellClass}" data-column="${col}" data-row="${rowIndex}" ondblclick="editCell(this)">${escapedValue}</td>`;
                });
                
                rowHtml += '</tr>';
                tableHtml += rowHtml;
            });
            
            body.innerHTML = tableHtml;
            
            paginatedData.forEach((row, index) => {
                const checkQty = parseFloat(row.qty) || 0;
                const netPrice = parseFloat(row.net_price) || 0;
                const totalPrice = parseFloat(row.total_price) || 0;
                const calculatedTotal = checkQty * netPrice;
                
                // æ£€æŸ¥è®¡ç®—å€¼æ˜¯å¦ä¸æ€»ä»·åŒ¹é…ï¼ˆè€ƒè™‘æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼‰
                if (checkQty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01) {
                    const actualRowIndex = startIndex + index;
                    const rowElement = document.querySelector(`tr[data-row-index="${actualRowIndex}"]`);
                    if (rowElement) {
                        rowElement.title = `æ•°æ®ä¸ä¸€è‡´: qty(${checkQty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} â‰  total_price(${totalPrice})`;
                    }
                }
            });
            
            // æ›´æ–°å‘è´§æŒ‰é’®åŒºåŸŸæ˜¾ç¤º
            updateShipmentButtonArea();
        }
        
        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeader() {
            const header = document.getElementById('tableHeader');
            header.innerHTML = '';
            
            let headerHtml = '<tr>';
            headerHtml += '<th>Actions</th>';
            columnNames.forEach(col => {
                const displayName = getColumnDisplayName(col);
                headerHtml += `<th>${displayName}</th>`;
            });
            headerHtml += '</tr>';
            
            header.innerHTML = headerHtml;
        }
        
        // æ¸²æŸ“è¿‡æ»¤è¡Œ
        function renderFilterRow() {
            const filterRow = document.getElementById('filterRow');
            if (!filterRow) {
                console.error('Filter row element not found');
                return;
            }
            
            // æ¸…ç©ºè¿‡æ»¤è¡Œ
            let filterHtml = '';
            
            // ä¸ºæ“ä½œåˆ—æ·»åŠ æ¸…é™¤æŒ‰é’®
            filterHtml += `
                <div>
                    <button class="btn btn-sm btn-outline-secondary clear-filter-btn" onclick="clearAllFilters()">
                       âŒ Clear
                    </button>
                </div>
            `;
            
            // ä¸ºæ¯ä¸ªæ•°æ®åˆ—åˆ›å»ºè¿‡æ»¤å™¨
            columnNames.forEach((col, index) => {
                const isDateColumn = dateColumns.includes(col);
                
                if (isDateColumn) {
                    // æ—¥æœŸåˆ—ï¼šåˆ›å»ºæŒ‰é’®æ‰“å¼€å¼¹çª— + æ¯”è¾ƒæ¨¡å¼é€‰æ‹©å™¨
                    filterHtml += `
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-sm btn-outline-primary" onclick="openDateFilterModal('${col}')" style="white-space: nowrap;">
                                ğŸ“… ${col}
                            </button>
                            <select class="form-select form-select-sm date-filter-mode" 
                                    data-column="${col}"
                                    style="flex: 0 0 auto; width: 100px;" 
                                    onchange="filterTable(this)">
                                <option value="equals">On</option>
                                <option value="before">Before</option>
                                <option value="on_or_after">After</option>
                            </select>
                            <input type="hidden" class="date-filter" data-column="${col}">
                        </div>
                    `;
                } else {
                    // æ™®é€šæ–‡æœ¬åˆ—
                    filterHtml += `
                        <div>
                            <input type="text" class="form-control form-control-sm" 
                                   placeholder="${col}" 
                                   data-column="${col}"
                                   oninput="filterTable(this)">
                        </div>
                    `;
                }
            });
            
            filterRow.innerHTML = filterHtml;
            
            // è®¾ç½®è¿‡æ»¤å™¨äº‹ä»¶
            setupFilterEvents();
        }
        
        // æ‰“å¼€æ—¥æœŸè¿‡æ»¤å¼¹çª—
        function openDateFilterModal(column) {
            // è·å–å½“å‰æ—¥æœŸå€¼ï¼ˆä»selectçš„data-dateå±æ€§è¯»å–ï¼‰
            const modeSelect = document.querySelector(`.date-filter-mode[data-column="${column}"]`);
            const currentDate = modeSelect ? modeSelect.getAttribute('data-date') : '';
            
            // åˆ›å»ºå¼¹çª—
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = `dateFilterModal_${column}`;
            modal.tabIndex = -1;
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Select Date - ${column}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <label class="form-label">Select Date:</label>
                            <input type="date" id="dateFilterInput_${column}" class="form-control" value="${currentDate || ''}">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                            <button type="button" class="btn btn-primary" onclick="confirmDateFilter('${column}')">ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modal);
            
            // æ˜¾ç¤ºå¼¹çª—
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // å¼¹çª—å…³é—­åç§»é™¤
            modal.addEventListener('hidden.bs.modal', () => {
                modal.remove();
            }, { once: true });
        }
        
        // ç¡®è®¤æ—¥æœŸé€‰æ‹©
        function confirmDateFilter(column) {
            const dateInput = document.getElementById(`dateFilterInput_${column}`);
            let selectedDate = dateInput.value;
            
            // å°†æ—¥æœŸæ ¼å¼ä» YYYY-MM-DD è½¬æ¢ä¸º YYYY-MM-DDï¼ˆç¡®ä¿æ ¼å¼ä¸€è‡´ï¼‰
            if (selectedDate && selectedDate.includes('/')) {
                // çˆ¶æ¢ / ä¸º -
                selectedDate = selectedDate.replace(/\//g, '-');
                console.log(`æ—¥æœŸæ ¼å¼è½¬æ¢: ${dateInput.value} => ${selectedDate}`);
            }
            
            // ä¿å­˜åˆ°selectçš„data-dateå±æ€§
            const modeSelect = document.querySelector(`.date-filter-mode[data-column="${column}"]`);
            if (modeSelect) {
                modeSelect.setAttribute('data-date', selectedDate);
                console.log(`ä¿å­˜æ—¥æœŸ: ${column} = ${selectedDate}`);
            }
            
            // å…³é—­å¼¹çª—
            const modal = bootstrap.Modal.getInstance(document.getElementById(`dateFilterModal_${column}`));
            if (modal) {
                modal.hide();
            }
            
            // åº”ç”¨è¿‡æ»¤å™¨
            applyAllFilters();
        }
        
        // è¿‡æ»¤è¡¨æ ¼
        function filterTable(input) {
            // ç›´æ¥åº”ç”¨è¿‡æ»¤å™¨ï¼Œä¸ä½¿ç”¨é˜²æŠ–
            applyAllFilters();
        }
        
        // åº”ç”¨æ‰€æœ‰è¿‡æ»¤å™¨
        function applyAllFilters() {
            // è·å–æ‰€æœ‰æ—¥æœŸè¿‡æ»¤å™¨çš„selectå…ƒç´ 
            const dateFilterModes = document.querySelectorAll('.date-filter-mode');
            
            // è·å–æ‰€æœ‰æ–‡æœ¬è¾“å…¥æ¡†
            const textFilters = document.querySelectorAll('input[data-column]:not(.date-filter)');
            
            // ä¿å­˜å½“å‰çš„è¾“å…¥å€¼
            const currentDateValues = {};
            const currentModes = {};
            const currentTextValues = {};
            
            // ä» select çš„ data-date å±æ€§è¯»å–æ—¥æœŸå€¼
            dateFilterModes.forEach(select => {
                const col = select.getAttribute('data-column');
                currentDateValues[col] = select.getAttribute('data-date') || '';
                currentModes[col] = select.value;
                console.log(`ä¿å­˜æ¨¡å¼: ${col} = ${select.value}, æ—¥æœŸ = ${currentDateValues[col]}`);
            });
            
            textFilters.forEach(input => {
                currentTextValues[input.getAttribute('data-column')] = input.value;
            });
            
            // ä»åŸå§‹æ•°æ®å¼€å§‹è¿‡æ»¤ä»¥ä¿æŒæ—¥æœŸçš„åŸå§‹æ ¼å¼
            filteredData = originalData.map(row => ({ ...row }));
            
            console.log(`å¼€å§‹è¿‡æ»¤, åŸå§‹æ•°æ®æ•°: ${filteredData.length}`);
            
            // å…ˆåº”ç”¨æ—¥æœŸè¿‡æ»¤
            dateFilterModes.forEach(select => {
                const column = select.getAttribute('data-column');
                const filterValue = (select.getAttribute('data-date') || '').trim();
                const mode = select.value || 'equals';
                
                console.log(`æ—¥æœŸè¿‡æ»¤: column=${column}, value=${filterValue}, mode=${mode}`);
                
                if (filterValue) {
                    const beforeCount = filteredData.length;
                    
                    filteredData = filteredData.filter(row => {
                        const cellValue = (row[column] || '').toString().trim();
                        
                        // ç©ºæ—¥æœŸä¸å‚ä¸è¿‡æ»¤ - è¿”å› false æ’é™¤ç©ºå€¼
                        if (!cellValue || cellValue === 'undefined') {
                            return false;
                        }
                        
                        // æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆå¤„ç†å¯èƒ½çš„æ—¶é—´å’Œå…¶ä»–æ²„æ±¡ï¼‰
                        // è®¾å®šä»„æ­£æ ¼å¼ä¸º YYYY-MM-DD
                        const cellDate = extractDateOnly(cellValue);
                        const result = compareDate(cellDate, filterValue, mode);
                        
                        if (result) {
                            console.log(`  âœ“ ${cellDate} ${mode} ${filterValue}`);
                        }
                        return result;
                    });
                    
                    const afterCount = filteredData.length;
                    console.log(`  ç»“æœ: ${beforeCount} -> ${afterCount}`);
                }
            });
            
            // ç„¶ååº”ç”¨æ–‡æœ¬è¿‡æ»¤
            textFilters.forEach(input => {
                const column = input.getAttribute('data-column');
                const filterValue = input.value.trim().toLowerCase();
                
                if (filterValue) {
                    filteredData = filteredData.filter(row => {
                        const cellValue = (row[column] || '').toString().toLowerCase();
                        return cellValue.includes(filterValue);
                    });
                }
            });
            
            console.log(`æœ€ç»ˆç»“æœ: ${filteredData.length}`);
            
            // è¿‡æ»¤å®Œæˆåï¼Œä¿æŒæŒ‰update_até™åºæ’åˆ—ï¼ˆæœ€æ–°æ•°æ®åœ¨æœ€å‰é¢ï¼‰
            const hasUpdateAtField = filteredData.length > 0 && filteredData.some(row => row.update_at);
            if (hasUpdateAtField) {
                filteredData.sort((a, b) => {
                    const dateA = a.update_at ? new Date(a.update_at).getTime() : 0;
                    const dateB = b.update_at ? new Date(b.update_at).getTime() : 0;
                    return dateB - dateA;
                });
            }
            
            // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶é‡æ–°æ¸²æŸ“
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
            // ä¿æŒå·²é€‰é¡¹ç›®çš„UIçŠ¶æ€
            setTimeout(updateSelectedItemsDisplay, 100);
        }
        
        // åˆ é™¤è¿™ä¸ªé‡å¤çš„å®šä¹‰ï¼Œä½¿ç”¨ä¸‹é¢çš„ç‰ˆæœ¬
        
        // åˆå§‹åŒ–è¡¨æ ¼
        function initTable() {
            renderTableBody();
            updateRecordCount();
            renderPagination();
        }
        
        // åˆå§‹åŒ–æ•°æ®
        function initData() {
            tableData = [
                { name: 'Alice', age: 25, date: '2023-01-01' },
                { name: 'Bob', age: 30, date: '2023-02-15' },
                { name: 'Charlie', age: 35, date: '2023-03-20' },
                { name: 'David', age: 40, date: '2023-04-25' },
                { name: 'Eve', age: 45, date: '2023-05-30' },
                { name: 'Frank', age: 50, date: '2023-06-05' },
                { name: 'Grace', age: 55, date: '2023-07-10' },
                { name: 'Hannah', age: 60, date: '2023-08-15' },
                { name: 'Ivy', age: 65, date: '2023-09-20' },
                { name: 'Jack', age: 70, date: '2023-10-25' },
                { name: 'Kathy', age: 75, date: '2023-11-30' },
                { name: 'Liam', age: 80, date: '2023-12-05' },
                { name: 'Mia', age: 85, date: '2023-12-10' },
                { name: 'Noah', age: 90, date: '2023-12-15' },
                { name: 'Olivia', age: 95, date: '2023-12-20' },
                { name: 'Paul', age: 100, date: '2023-12-25' },
                { name: 'Quinn', age: 105, date: '2024-01-01' },
                { name: 'Rachel', age: 110, date: '2024-01-05' },
                { name: 'Sam', age: 115, date: '2024-01-10' },
                { name: 'Tina', age: 120, date: '2024-01-15' },
            ];
            
            columns = Object.keys(tableData[0]);
            
            initTable();
        }
        
        // æå–YYYY-MM-DDæ ¼å¼çš„æ—¥æœŸ
        function extractDateOnly(dateString) {
            if (!dateString) return '';
            
            // æ˜¯å¦å·²ç»YYYY-MM-DDæ ¼å¼
            if (dateString.match(/^\d{4}-\d{2}-\d{2}/)) {
                return dateString.substring(0, 10);
            }
            
            // æ˜¯å¦æ˜¯GMTæˆ–å…¶ä»–æ—¥æœŸå­—ç¬¦ä¸²ï¼Œéœ€è¦è§£æ
            try {
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    // è½¬æ¢ä¸ºYYYY-MM-DDæ ¼å¼
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
            } catch (e) {
                console.warn(`æ—¥æœŸè§£æå¤±è´¥: ${dateString}`);
            }
            
            return dateString;
        }
        
        // æ¯”è¾ƒæ—¥æœŸçš„è¾…åŠ©å‡½æ•°
        function compareDate(cellDate, filterDate, mode) {
            console.log(`compareDate: cellDate=${cellDate}, filterDate=${filterDate}, mode=${mode}`);
            
            // ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
            if (mode === 'equals') {
                // å½“å¤©ï¼šå®Œå…¨ç›¸ç­‰
                const result = cellDate === filterDate;
                console.log(`  equals: ${cellDate} === ${filterDate} = ${result}`);
                return result;
            } else if (mode === 'before') {
                // ä¹‹å‰ï¼šå°äºç­‰äºï¼ˆåŒ…å«å½“å¤©ï¼‰
                const result = cellDate <= filterDate;
                console.log(`  before: ${cellDate} <= ${filterDate} = ${result}`);
                return result;
            } else if (mode === 'on_or_after') {
                // ä¹‹åï¼šå¤§äºç­‰äºï¼ˆåŒ…å«å½“å¤©ï¼‰
                const result = cellDate >= filterDate;
                console.log(`  on_or_after: ${cellDate} >= ${filterDate} = ${result}`);
                return result;
            }
            
            return true;
        }
        
        // ä¸ºè¿‡æ»¤å™¨æ·»åŠ å›è½¦é”®äº‹ä»¶
        function setupFilterEvents() {
            const filterInputs = document.querySelectorAll('input[data-column]');
            filterInputs.forEach(input => {
                // ç¡®ä¿ç§»é™¤ä¹‹å‰å¯èƒ½æ·»åŠ çš„äº‹ä»¶ç›‘å¬å™¨
                input.removeEventListener('keyup', handleFilterKeyUp);
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
                input.addEventListener('keyup', handleFilterKeyUp);
            });
        }
        
        // å¤„ç†è¿‡æ»¤å™¨çš„keyupäº‹ä»¶
        function handleFilterKeyUp(event) {
            if (event.key === 'Enter') {
                applyAllFilters();
            }
        }
        
        // æ¸…é™¤æ‰€æœ‰è¿‡æ»¤å™¨
        function clearAllFilters() {
            // æ¸…é™¤æ‰€æœ‰æ—¥æœŸè¾“å…¥æ¡†çš„å€¼
            const dateFilters = document.querySelectorAll('input.date-filter');
            const dateFilterModes = document.querySelectorAll('.date-filter-mode');
            const textFilters = document.querySelectorAll('input[data-column]:not(.date-filter)');
            
            dateFilters.forEach(input => {
                input.value = '';
            });
            
            dateFilterModes.forEach(select => {
                select.value = 'equals';
            });
            
            textFilters.forEach(input => {
                input.value = '';
            });
            
            // é‡ç½®è¿‡æ»¤æ•°æ®ä¸ºåŸå§‹æ•°æ®
            filteredData = originalData.map(row => ({ ...row }));
            
            // ä¿æŒæŒ‰update_até™åºæ’åˆ—
            const hasUpdateAtField = filteredData.length > 0 && filteredData.some(row => row.update_at);
            if (hasUpdateAtField) {
                filteredData.sort((a, b) => {
                    const dateA = a.update_at ? new Date(a.update_at).getTime() : 0;
                    const dateB = b.update_at ? new Date(b.update_at).getTime() : 0;
                    return dateB - dateA;
                });
            }
            
            // é‡ç½®åˆ°ç¬¬ä¸€é¡µå¹¶é‡æ–°æ¸²æŸ“
            currentPage = 1;
            renderTableBody();
            updateRecordCount();
            renderPagination();
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmModal(message, confirmCallback) {
            // è®¾ç½®æ¨¡æ€æ¡†å†…å®¹
            document.getElementById('confirmModalBody').innerHTML = message;
            
            // è®¾ç½®ç¡®è®¤æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const confirmButton = document.getElementById('confirmModalButton');
            // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
            const newConfirmButton = confirmButton.cloneNode(true);
            confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
            
            // æ·»åŠ æ–°çš„ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            newConfirmButton.onclick = function() {
                // æ‰§è¡Œç¡®è®¤å›è°ƒ
                if (confirmCallback && typeof confirmCallback === 'function') {
                    confirmCallback();
                }
                // å…³é—­æ¨¡æ€æ¡† - ç¨ä½œå»¶è¿Ÿæ‰¹å‡†å›è°ƒæ‰§è¡Œ
                setTimeout(() => {
                    const modalElement = document.getElementById('confirmModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    } else {
                        // å¦‚æœå®ä¾‹ä¸å­˜åœ¨ï¼Œç›´æ¥æ¸…ç†
                        closeConfirmModal();
                    }
                }, 50);
            };
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalElement = document.getElementById('confirmModal');
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            
            // æ·»åŠ Modalå…³é—­äº‹ä»¶ç›‘å¬ï¼Œç¡®ä¿æ»šåŠ¨æ¡æ¢å¤
            modalElement.addEventListener('hidden.bs.modal', function() {
                document.body.style.overflow = 'auto';
            }, { once: true });
            
            modal.show();
        }
        
        // ä¸»åŠ¨å…³é—­Modalçš„åº”æ€¥æ–¹æ³•
        function closeConfirmModal() {
            const modalElement = document.getElementById('confirmModal');
            // ç§»é™¤modalå…ƒç´ çš„showç±»
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            modalElement.setAttribute('aria-hidden', 'true');
            // æ¸…é™¤æ‰€æœ‰backdrop
            document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
            // æ­£å¸¸åŒ–ä½“çš„æ ·å¼
            document.body.classList.remove('modal-open');
            document.body.style.paddingRight = '';
            document.body.style.overflow = 'auto';
        }
        
        // ç¼–è¾‘å•å…ƒæ ¼
        function editCell(cell) {
            // å¦‚æœç‚¹å‡»çš„æ˜¯è¾“å…¥æ¡†ï¼Œä¸æ‰§è¡Œç¼–è¾‘æ“ä½œ
            if (event && event.target.tagName === 'INPUT') {
                return;
            }
            
            // å¦‚æœæœ‰æ­£åœ¨ç¼–è¾‘çš„å•å…ƒæ ¼ï¼Œå…ˆå–æ¶ˆå®ƒçš„ç¼–è¾‘çŠ¶æ€
            if (currentEditingCell && currentEditingCell !== cell) {
                // æ¢å¤å•å…ƒæ ¼æ˜¾ç¤º
                const originalValue = currentEditingCell.getAttribute('data-original-value');
                currentEditingCell.textContent = originalValue || '';
                currentEditingCell.classList.remove('editing-cell');
                currentEditingCell.classList.add('editable-cell');
            }
            
            // å¦‚æœç‚¹å‡»çš„æ˜¯å·²ç»å¤„äºç¼–è¾‘çŠ¶æ€çš„å•å…ƒæ ¼ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œ
            if (cell.classList.contains('editing-cell')) {
                return;
            }
            
            const rowIndex = parseInt(cell.getAttribute('data-row'));
            const columnName = cell.getAttribute('data-column');
            const currentValue = cell.textContent || '';
            
            // ä¿å­˜åŸå§‹å€¼
            cell.setAttribute('data-original-value', currentValue);
            
            // æ ¹æ®åˆ—ååˆ¤æ–­è¾“å…¥ç±»å‹
            let inputHtml = '';
            let dateValue = '';
            
            if (dateColumns.includes(columnName)) {
                // å¯¹äºæ—¥æœŸå­—æ®µï¼Œç¡®ä¿å€¼æ ¼å¼æ­£ç¡®
                dateValue = currentValue;
                if (currentValue && currentValue !== 'null' && currentValue !== 'None') {
                    // å¦‚æœæ˜¯æ—¥æœŸå¯¹è±¡ï¼Œæ ¼å¼åŒ–ä¸º YYYY-MM-DD
                    if (currentValue instanceof Date) {
                        dateValue = currentValue.toISOString().split('T')[0];
                    } else if (typeof currentValue === 'string' && currentValue.match(/^\d{4}-\d{2}-\d{2}/)) {
                        // å·²ç»æ˜¯æ­£ç¡®æ ¼å¼
                        dateValue = currentValue;
                    } else if (typeof currentValue === 'string' && currentValue.includes('GMT')) {
                        // å¤„ç†GMTæ—¥æœŸå­—ç¬¦ä¸²
                        try {
                            const date = new Date(currentValue);
                            if (!isNaN(date.getTime())) {
                                dateValue = date.toISOString().split('T')[0];
                            }
                        } catch (e) {
                            dateValue = currentValue;
                        }
                    }
                } else {
                    dateValue = '';
                }
                inputHtml = `<input type="date" class="date-input" 
                                     data-original-value="${dateValue}">`;
            } else if (columnName === 'shipping_mode' || columnName === 'wfsz_shipping_mode') {
                // ä¸º shipping_mode æˆ– wfsz_shipping_mode ä½¿ç”¨ä¸‹æ‹‰æ¡†
                const shippingModeOptions = ['sea', 'air', 'train', 'truck'];
                let optionsHtml = '';
                optionsHtml += '<option value=""></option>'; // ç©ºé€‰é¡¹
                shippingModeOptions.forEach(option => {
                    const selected = currentValue === option ? 'selected' : '';
                    optionsHtml += `<option value="${option}" ${selected}>${option}</option>`;
                });
                inputHtml = `<select class="form-select" data-original-value="${currentValue}" style="width: 100%; padding: 8px;">${optionsHtml}</select>`;
            } else if (columnName === 'description' || columnName === 'comment') {
                // ä¸º description å’Œ comment ä½¿ç”¨å¤šè¡Œæ–‡æœ¬æ¡†
                inputHtml = `<textarea class="form-control" style="min-height: 100px; resize: vertical;">${currentValue}</textarea>`;
            } else if (columnName === 'shipping_cost') {
                // å¯¹äºshipping_costï¼Œæå–çº¯æ•°å€¼ç”¨äºç¼–è¾‘
                let editValue = currentValue;
                // ç§»é™¤ "s:" å‰ç¼€
                editValue = editValue.replace(/^s:/, '');
                // æå–çº¯æ•°å€¼ï¼ˆç§»é™¤è´§å¸ç¬¦å·ï¼‰
                editValue = editValue.replace(/[â‚¬$]/g, '').trim();
                inputHtml = `<input type="number" value="${editValue}" step="0.01" 
                                     data-original-value="${editValue}">`;
            } else {
                inputHtml = `<input type="text" value="${currentValue}" 
                                     data-original-value="${currentValue}">`;
            }
            
            cell.innerHTML = inputHtml;
            cell.classList.add('editing-cell');
            cell.classList.remove('editable-cell');
            // ä¿æŒ description-cell æˆ– comment-cell çš„æ ·å¼ç±»åœ¨ç¼–è¾‘æ—¶ä¹Ÿé€‚ç”¨
            // è¿™æ ·æ¢è¡Œæ ·å¼åœ¨ç¼–è¾‘æ—¶ä¹Ÿèƒ½ä¿æŒ
            
            // èšç„¦åˆ°æ–°åˆ›å»ºçš„è¾“å…¥æ¡†
            const input = cell.querySelector('input, textarea, select');
            if (input) {
                // å¯¹äºæ—¥æœŸè¾“å…¥æ¡†ï¼Œå•ç‹¬è®¾ç½®valueå±æ€§
                if (dateColumns.includes(columnName)) {
                    input.value = dateValue;
                } else if (columnName === 'shipping_mode' || columnName === 'wfsz_shipping_mode') {
                    // select å…ƒç´ å·²ç»æœ‰ data-original-value å’Œé€‰ä¸­çš„å€¼ï¼Œç›´æ¥èšç„¦
                    // æ— éœ€é¢å¤–å¤„ç†
                } else if (columnName === 'description' || columnName === 'comment') {
                    // textarea å·²ç»è®¾ç½®äº†å€¼ï¼Œè®¾ç½® data-original-value å±æ€§
                    input.setAttribute('data-original-value', currentValue);
                    input.select();
                } else {
                    // å¯¹äºæ–‡æœ¬è¾“å…¥æ¡†ï¼Œé€‰æ‹©æ‰€æœ‰æ–‡æœ¬ä»¥ä¾¿ç¼–è¾‘
                    input.select();
                }
                input.focus();
                
                // ä¸ºè¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†éƒ½æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Escape') {
                        event.preventDefault();
                        event.stopPropagation();
                        // ESCé”®å–æ¶ˆç¼–è¾‘ï¼Œæ¢å¤åŸå§‹å€¼
                        const originalValue = input.getAttribute('data-original-value');
                        cell.textContent = originalValue || '';
                        cell.classList.remove('editing-cell');
                        cell.classList.add('editable-cell');
                        currentEditingCell = null;
                    } else if (event.key === 'Enter' && input.tagName !== 'TEXTAREA' && input.tagName !== 'SELECT') {
                        // Enteré”®ä»…å¯¹étextareaå’Œéselectç”Ÿæ•ˆ
                        event.preventDefault();
                        event.stopPropagation();
                        // Enteré”®è§¦å‘ä¿å­˜é€»è¾‘
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        // æ£€æŸ¥å€¼æ˜¯å¦æœ‰å˜åŒ–
                        if (originalValue !== currentInputValue) {
                            // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                // ç¡®è®¤ä¿å­˜
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            // æ²¡æœ‰ä¿®æ”¹ï¼Œç›´æ¥å…³é—­
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    } else if (event.key === 'Enter' && event.ctrlKey && input.tagName === 'TEXTAREA') {
                        // Ctrl+Enterä¸ºtextareaé¢„ç•™çš„ä¿å­˜é”®
                        event.preventDefault();
                        event.stopPropagation();
                        // Ctrl+Enteré”®è§¦å‘ä¿å­˜é€»è¾‘
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                    } else if (event.key === 'Enter' && input.tagName === 'SELECT') {
                        // Enteré”®ä¸ºselectè§¦å‘ä¿å­˜é€»è¾‘
                        event.preventDefault();
                        event.stopPropagation();
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        // æ£€æŸ¥å€¼æ˜¯å¦æœ‰å˜åŒ–
                        if (originalValue !== currentInputValue) {
                            // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                // ç¡®è®¤ä¿å­˜
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            // æ²¡æœ‰ä¿®æ”¹ï¼Œç›´æ¥å…³é—­
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                    }
                });
                
                // ç›‘å¬è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹äº‹ä»¶ï¼ˆåŒ…æ‹¬selectï¼‰
                input.addEventListener('blur', function(e) {
                    // å¯¹äºselectå…ƒç´ ï¼Œbluræ—¶ç›´æ¥ä¿å­˜
                    if (input.tagName === 'SELECT') {
                        const originalValue = input.getAttribute('data-original-value');
                        const currentInputValue = input.value;
                        
                        if (originalValue !== currentInputValue) {
                            showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                cell.textContent = currentInputValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                updateCellValue(rowIndex, columnName, currentInputValue);
                                currentEditingCell = null;
                            });
                        } else {
                            cell.textContent = originalValue || '';
                            cell.classList.remove('editing-cell');
                            cell.classList.add('editable-cell');
                            currentEditingCell = null;
                        }
                        return;
                    }
                    
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿ä¸ä¼šä¸ç‚¹å‡»äº‹ä»¶å†²çª
                    setTimeout(() => {
                        // æ£€æŸ¥å•å…ƒæ ¼æ˜¯å¦ä»å¤„äºç¼–è¾‘çŠ¶æ€
                        if (cell.classList.contains('editing-cell')) {
                            const originalValue = input.getAttribute('data-original-value');
                            const currentInputValue = input.value;
                            
                            // æ£€æŸ¥å€¼æ˜¯å¦æœ‰å˜åŒ–
                            if (originalValue !== currentInputValue) {
                                // å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
                                showConfirmModal(`Data has been modified. Save changes?<br><strong>Original:</strong> ${originalValue || '(empty)'}<br><strong>New:</strong> ${currentInputValue || '(empty)'}`, function() {
                                    // ç¡®è®¤ä¿å­˜
                                    cell.textContent = currentInputValue || '';
                                    cell.classList.remove('editing-cell');
                                    cell.classList.add('editable-cell');
                                    updateCellValue(rowIndex, columnName, currentInputValue);
                                    currentEditingCell = null;
                                });
                            } else {
                                // æ²¡æœ‰ä¿®æ”¹ï¼Œç›´æ¥å…³é—­
                                cell.textContent = originalValue || '';
                                cell.classList.remove('editing-cell');
                                cell.classList.add('editable-cell');
                                currentEditingCell = null;
                            }
                        }
                    }, 100);
                });
            }
            
            // è®¾ç½®å½“å‰ç¼–è¾‘çš„å•å…ƒæ ¼
            currentEditingCell = cell;
        }
        
        // æ›´æ–°å•å…ƒæ ¼å€¼
        function updateCellValue(rowIndex, columnName, value) {
            // å¤„ç†ç‰¹æ®Šå€¼
            if (value === 'null' || value === 'None' || value === 'nan') {
                tableData[rowIndex][columnName] = null;
            } else {
                // å¯¹äºshipping_costå­—æ®µï¼Œæå–æ•°å€¼éƒ¨åˆ†ï¼ˆå»æ‰s:å‰ç¼€å’Œè´§å¸ç¬¦å·ï¼‰
                if (columnName === 'shipping_cost') {
                    // ç§»é™¤ "s:" å‰ç¼€
                    let cleanValue = value.replace(/^s:/, '');
                    // æå–çº¯æ•°å€¼ï¼ˆç§»é™¤è´§å¸ç¬¦å·ï¼‰
                    cleanValue = cleanValue.replace(/[â‚¬$]/g, '').trim();
                    // å¦‚æœè¿˜æœ‰å†…å®¹ï¼Œä½¿ç”¨æ¸…ç†åçš„å€¼ï¼›å¦åˆ™ä½¿ç”¨åŸå€¼
                    tableData[rowIndex][columnName] = cleanValue || value;
                } else {
                    tableData[rowIndex][columnName] = value;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯qtyæˆ–net_priceåˆ—ï¼Œå¦‚æœæ˜¯åˆ™è‡ªåŠ¨è®¡ç®—total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                const totalPrice = (qty * netPrice).toFixed(2);
                
                // æ›´æ–°total_priceå­—æ®µ
                tableData[rowIndex]['total_price'] = totalPrice;
                
                // æ›´æ–°è¡¨æ ¼ä¸­æ˜¾ç¤ºçš„total_priceå€¼
                const totalCell = document.querySelector(`td[data-column="total_price"][data-row="${rowIndex}"]`);
                if (totalCell) {
                    totalCell.textContent = totalPrice;
                }
            }
            
            // ç¡®å®šä¸»é”®ï¼šå¯¹äºclosedè¡¨ä½¿ç”¨idï¼Œå¯¹äºopenè¡¨ä½¿ç”¨po_line
            const row = tableData[rowIndex];
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = row.id;
            } else if (isOpenTable) {
                primaryKeyValue = row.po_line;
            } else {
                primaryKeyValue = row.pn || row.PN;
            }
            
            if (!primaryKeyValue) {
                showStatus('Cannot save: missing primary key value', 'error');
                return;
            }
            
            // å‡†å¤‡æ›´æ–°æ•°æ®
            const updates = {};
            // å¯¹äºshipping_costå­—æ®µï¼Œæå–çº¯æ•°å€¼è¿›è¡Œæ›´æ–°
            if (columnName === 'shipping_cost') {
                let cleanValue = value.replace(/^s:/, '').replace(/[â‚¬$]/g, '').trim();
                updates[columnName] = (cleanValue && !isNaN(parseFloat(cleanValue))) ? parseFloat(cleanValue) : null;
            } else {
                updates[columnName] = value === 'null' || value === 'None' || value === 'nan' ? null : value;
            }
            
            // å¦‚æœæ˜¯qtyæˆ–net_priceï¼ŒåŒæ—¶å‘é€total_priceæ›´æ–°
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // å¯¹äºåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ / ï¼‰çš„ä¸»é”®ï¼Œä½¿ç”¨æŸ¥è¯¢å‚æ•°ä¼ é€’ä»¥é¿å…è·¯ç”±æ”¹å†™ä¸åŒ¹é…
            updates.key = primaryKeyValue;
            // å‘é€æ›´æ–°è¯·æ±‚
            authenticatedFetch(`/api/tables/${currentTable}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°åŸå§‹æ•°æ®
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // é‡æ–°éªŒè¯è¯¥è¡Œæ•°æ®ï¼ˆä»…å¯¹æ•°å€¼åˆ—ï¼‰
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                    
                    // å¯¹äºshipping_costï¼Œé‡æ–°åŠ è½½è¡¨æ ¼ä»¥æ˜¾ç¤ºæ­£ç¡®çš„æ ¼å¼åŒ–å€¼
                    if (columnName === 'shipping_cost') {
                        setTimeout(() => loadTableData(), 500);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // ä¿å­˜å•å…ƒæ ¼ç¼–è¾‘
        function saveCellEdit(cell) {
            // è§¦å‘è¾“å…¥æ¡†çš„changeäº‹ä»¶æ¥ä¿å­˜å€¼
            const input = cell.querySelector('input');
            if (input) {
                input.dispatchEvent(new Event('change'));
            }
            // æ›´æ–°æ˜¾ç¤ºå€¼
            if (input) {
                cell.textContent = input.value || '';
            }
            cell.classList.remove('editing-cell');
            cell.classList.add('editable-cell');
        }
        
        // ä¿å­˜å•å…ƒæ ¼æ•°æ®ï¼ˆè‡ªåŠ¨ä¿å­˜ï¼‰
        function saveCellData(rowIndex, columnName, value) {
            // æ›´æ–°æ•°æ®æ¨¡å‹
            tableData[rowIndex][columnName] = value;
            
            // å¦‚æœæ˜¯qtyæˆ–net_priceï¼ŒåŒæ—¶æ›´æ–°total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                const qty = parseFloat(tableData[rowIndex]['qty']) || 0;
                const netPrice = parseFloat(tableData[rowIndex]['net_price']) || 0;
                tableData[rowIndex]['total_price'] = (qty * netPrice).toFixed(2);
            }
            
            // ç¡®å®šä¸»é”®ï¼šå¯¹äºclosedè¡¨ä½¿ç”¨idï¼Œå¯¹äºopenè¡¨ä½¿ç”¨po_line
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = row.id;
            } else if (isOpenTable) {
                primaryKeyValue = row.po_line;
            } else {
                primaryKeyValue = row.pn || row.PN;
            }
            
            if (!primaryKeyValue) {
                showStatus('Cannot save: missing primary key value', 'error');
                return;
            }
            
            // å‡†å¤‡æ›´æ–°æ•°æ®
            const updates = {};
            updates[columnName] = value;
            
            // å¦‚æœæ˜¯qtyæˆ–net_priceï¼ŒåŒæ—¶å‘é€total_priceæ›´æ–°
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // å¯¹äºåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ / ï¼‰çš„ä¸»é”®ï¼Œä½¿ç”¨æŸ¥è¯¢å‚æ•°ä¼ é€’ä»¥é¿å…è·¯ç”±æ”¹å†™ä¸åŒ¹é…
            updates.key = primaryKeyValue;
            // å‘é€æ›´æ–°è¯·æ±‚
            authenticatedFetch(`/api/tables/${currentTable}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°åŸå§‹æ•°æ®
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // é‡æ–°éªŒè¯è¯¥è¡Œæ•°æ®ï¼ˆä»…å¯¹æ•°å€¼åˆ—ï¼‰
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }
        
        // å®æ—¶ä¿å­˜å•å…ƒæ ¼å€¼åˆ°æ•°æ®åº“
        function saveCellValueToDatabase(rowIndex, columnName, value) {
            // è·å–è¦æ›´æ–°çš„æ•°æ®
            const rowData = tableData[rowIndex];
            const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            let primaryKeyValue;
            if (isClosedTable) {
                primaryKeyValue = rowData.id;
            } else if (isOpenTable) {
                primaryKeyValue = rowData.po_line;
            } else {
                primaryKeyValue = rowData.pn;
            }
            
            // æ„é€ æ›´æ–°æ•°æ®
            const updates = {};
            updates[columnName] = value;
            
            // å¦‚æœæ˜¯qtyæˆ–net_priceï¼ŒåŒæ—¶æ›´æ–°total_price
            if (columnName === 'qty' || columnName === 'net_price') {
                updates['total_price'] = tableData[rowIndex]['total_price'];
            }
            
            // å¯¹äºåŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ / ï¼‰çš„ä¸»é”®ï¼Œä½¿ç”¨æŸ¥è¯¢å‚æ•°ä¼ é€’ä»¥é¿å…è·¯ç”±æ”¹å†™ä¸åŒ¹é…
            updates.key = primaryKeyValue;
            // å‘é€æ›´æ–°è¯·æ±‚
            authenticatedFetch(`/api/tables/${currentTable}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updates)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ›´æ–°åŸå§‹æ•°æ®
                    originalData[rowIndex] = JSON.parse(JSON.stringify(tableData[rowIndex]));
                    showStatus(`Data saved: ${columnName}`, 'success');
                    setTimeout(hideStatus, 2000);
                    
                    // é‡æ–°éªŒè¯è¯¥è¡Œæ•°æ®ï¼ˆä»…å¯¹æ•°å€¼åˆ—ï¼‰
                    if (columnName === 'qty' || columnName === 'net_price' || columnName === 'total_price') {
                        validateRow(rowIndex);
                    }
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                    setTimeout(hideStatus, 3000);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
                showStatus(`Save failed: ${error.message}`, 'error');
                setTimeout(hideStatus, 3000);
            });
        }

        // éªŒè¯è¡Œæ•°æ®
        function validateRow(rowIndex) {
            const row = tableData[rowIndex];
            // ç¡®ä¿å¿…è¦çš„åˆ—å­˜åœ¨
            if (!row.hasOwnProperty('qty') || !row.hasOwnProperty('net_price') || !row.hasOwnProperty('total_price')) {
                return;
            }
            
            const qty = parseFloat(row.qty) || 0;
            const netPrice = parseFloat(row.net_price) || 0;
            const totalPrice = parseFloat(row.total_price) || 0;
            const calculatedTotal = qty * netPrice;
            
            // æ£€æŸ¥è®¡ç®—å€¼æ˜¯å¦ä¸æ€»ä»·åŒ¹é…ï¼ˆè€ƒè™‘æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜ï¼‰
            const isInvalidRow = qty > 0 && netPrice > 0 && Math.abs(calculatedTotal - totalPrice) > 0.01;
            
            const rowElement = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
            if (rowElement) {
                if (isInvalidRow) {
                    rowElement.classList.add('invalid-row');
                    rowElement.title = `æ•°æ®ä¸ä¸€è‡´: qty(${qty}) * net_price(${netPrice}) = ${calculatedTotal.toFixed(2)} â‰  total_price(${totalPrice})`;
                } else {
                    rowElement.classList.remove('invalid-row');
                    rowElement.title = '';
                }
            }
        }
        
        // ä¿å­˜è¡Œæ•°æ®
        function saveRow(rowIndex) {
            const row = tableData[rowIndex];
            const originalRow = originalData[rowIndex];
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
            let hasChanges = false;
            for (let key in row) {
                if (row[key] !== originalRow[key]) {
                    hasChanges = true;
                    break;
                }
            }
            
            if (!hasChanges) {
                showStatus('No changes to save', 'info');
                return;
            }
            
            // è·å–ä¸»é”®å€¼ï¼ˆå‡è®¾ä¸ºpnå­—æ®µï¼‰
            const pn = row.pn || row.PN;
            if (!pn) {
                showStatus('Cannot save: missing primary key value(pn)', 'error');
                return;
            }
            
            showStatus('Saving data...', 'loading');
            
            // åœ¨è¯·æ±‚ä½“ä¸­åŠ å…¥ä¸»é”®å€¼
            row.key = pn;
            authenticatedFetch(`/api/tables/${currentTable}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(row)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('Data saved successfully', 'success');
                    // æ›´æ–°åŸå§‹æ•°æ®å‰¯æœ¬
                    originalData[rowIndex] = JSON.parse(JSON.stringify(row));
                } else {
                    showStatus(`Save failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`Save failed: ${error}`, 'error');
            });
        }
        
        // æ’å…¥æ–°è®°å½•
        function insertRecord() {
            try {
                const formData = {};
                const formFields = document.querySelectorAll('#insertFormFields input, #insertFormFields select');
                
                // æ”¶é›†è¡¨å•æ•°æ®
                formFields.forEach(field => {
                    let value = field.value;
                    
                    // å¤„ç†ç‰¹æ®Šå€¼
                    if (value === 'null' || value === 'None' || value === '') {
                        value = null;
                    }
                    
                    formData[field.name] = value;
                });
                
                // å‘é€æ’å…¥è¯·æ±‚
                authenticatedFetch(`/api/tables/${currentTable}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record inserted successfully', 'success');
                        hideInsertForm();
                        loadTableData(); // é‡æ–°åŠ è½½æ•°æ®
                    } else {
                        showStatus(`Insert failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Insert failed: ${error}`, 'error');
                });
            } catch (error) {
                console.error("insertRecordå‡½æ•°æ‰§è¡Œå‡ºé”™:", error);
                showStatus(`Error inserting record: ${error.message}`, 'error');
            }
        }
        

        
        // æ˜¾ç¤ºæ’å…¥è¡¨å•
        function showInsertForm() {
            try {
                console.log("showInsertFormå‡½æ•°è¢«è°ƒç”¨");
                
                const insertForm = document.getElementById('insertFormContainer');
                
                if (!insertForm) {
                    console.error("æœªæ‰¾åˆ°idä¸º'insertFormContainer'çš„å…ƒç´ ");
                    return;
                }
                
                // å¦‚æœè¡¨å•å·²ç»å±•å¼€ï¼Œåˆ™éšè—ï¼ˆä½œä¸ºå–æ¶ˆï¼‰
                if (insertForm.style.display === 'block') {
                    hideInsertForm();
                    return;
                }
                
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertFormFields) {
                    console.error("æœªæ‰¾åˆ°idä¸º'insertFormFields'çš„å…ƒç´ ");
                    return;
                }
                
                const columns = getColumnNames(currentTable);
                console.log("å½“å‰è¡¨çš„åˆ—å:", columns);
                
                let formHtml = '';
                columns.forEach(column => {
                    if (column === 'total_price') return;
                    formHtml += `<div class="col-md-3 mb-2"><input type="text" class="form-control form-control-sm" name="${column}" placeholder="${column}"></div>`;
                });
                
                insertFormFields.innerHTML = formHtml;
                
                insertForm.style.display = 'block';
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'none';
                }
                
                console.log("æ’å…¥è¡¨å•å·²æ˜¾ç¤º");
            } catch (error) {
                console.error("showInsertFormå‡½æ•°æ‰§è¡Œå‡ºé”™:", error);
                alert("æ˜¾ç¤ºæ’å…¥è¡¨å•æ—¶å‡ºé”™: " + error.message);
            }
        }
        
        // éšè—æ’å…¥è¡¨å•
        function hideInsertForm() {
            try {
                console.log("hideInsertFormå‡½æ•°è¢«è°ƒç”¨");
                
                // æ£€æŸ¥å¿…è¦çš„DOMå…ƒç´ æ˜¯å¦å­˜åœ¨
                const insertForm = document.getElementById('insertFormContainer');
                const insertFormFields = document.getElementById('insertFormFields');
                
                if (!insertForm) {
                    console.error("æœªæ‰¾åˆ°idä¸º'insertFormContainer'çš„å…ƒç´ ");
                    return;
                }
                
                if (!insertFormFields) {
                    console.error("æœªæ‰¾åˆ°idä¸º'insertFormFields'çš„å…ƒç´ ");
                    return;
                }
                
                // éšè—æ’å…¥è¡¨å•ï¼Œæ˜¾ç¤ºæ•°æ®è¡¨æ ¼
                insertForm.style.display = 'none';
                // æ˜¾ç¤ºæœ€åä¸€ä¸ªå®¹å™¨ï¼ˆæ•°æ®è¡¨æ ¼ï¼‰
                const tableContainers = document.querySelectorAll('.table-container');
                if (tableContainers.length > 0) {
                    tableContainers[tableContainers.length - 1].style.display = 'block';
                }
                
                // æ¸…ç©ºè¡¨å•å­—æ®µ
                insertFormFields.innerHTML = '';
                
                console.log("æ’å…¥è¡¨å•å·²éšè—");
            } catch (error) {
                console.error("hideInsertFormå‡½æ•°æ‰§è¡Œå‡ºé”™:", error);
                console.log("éšè—æ’å…¥è¡¨å•æ—¶å‡ºé”™: " + error.message);
            }
        }
        

        
        // ============ å…¨å±€å‘è´§ç›¸å…³å‡½æ•° ============
        
        // æ›´æ–°å‘è´§æŒ‰é’®åŒºåŸŸæ˜¾ç¤º
        function updateShipmentButtonArea() {
            const buttonArea = document.getElementById('shipmentButtonArea');
            const globalShipmentBtn = document.getElementById('globalShipmentBtn');
            const batchUpdateBtn = document.getElementById('batchUpdateBtn');
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºopenè¡¨
            const isOpenTable = (currentTable === 'wf_open' || currentTable === 'non_wf_open');
            
            if (isOpenTable) {
                // openè¡¨ï¼šæ˜¾ç¤ºå‘è´§æŒ‰é’®å’Œæ‰¹é‡ä¿®æ”¹æŒ‰é’®
                buttonArea.style.display = 'flex';
                globalShipmentBtn.style.display = 'block';
                batchUpdateBtn.style.display = 'block';
            } else {
                // closedè¡¨ï¼šéšè—å‘è´§æŒ‰é’®ï¼Œä½†æ˜¾ç¤ºæ‰¹é‡ä¿®æ”¹æŒ‰é’®
                buttonArea.style.display = 'flex';
                globalShipmentBtn.style.display = 'none';
                batchUpdateBtn.style.display = 'block';
            }
            
            updateSelectedItemsDisplay();
        }
        
        // æ›´æ–°å·²é€‰é¡¹ç›®æ˜¾ç¤º
        function updateSelectedItemsDisplay() {
            const displayArea = document.getElementById('selectedItemsDisplay');
            displayArea.innerHTML = '';
            
            if (selectedItemsForShipment.size === 0) {
                displayArea.innerHTML = '<span style="color: #a0aec0; font-size: 0.9rem;">No materials selected</span>';
            } else {
                selectedItemsForShipment.forEach((item, poLine) => {
                    const tabHtml = `<div class="selected-tab">
                        <span>${poLine}</span>
                        <button type="button" class="remove-btn" onclick="removeFromShipmentSelection('${poLine}')">Ã—</button>
                    </div>`;
                    displayArea.innerHTML += tabHtml;
                });
            }
        }
        
        // å¤„ç†å‘è´§å¤‡é€‰æ¡†å˜åŒ–
        function handleShipmentCheckboxChange() {
            const checkboxes = document.querySelectorAll('.shipment-checkbox');
            
            checkboxes.forEach(checkbox => {
                const poLine = checkbox.getAttribute('data-po-line');
                const po = checkbox.getAttribute('data-po');
                const pn = checkbox.getAttribute('data-pn');
                const qty = parseFloat(checkbox.getAttribute('data-qty')) || 0;
                const rowIndex = parseInt(checkbox.getAttribute('data-row-index'));
                
                if (checkbox.checked) {
                    // å¦‚æœcheckboxè¢«checkedï¼Œæ·»åŠ åˆ°Map
                    if (!selectedItemsForShipment.has(poLine)) {
                        // ä»æ•´ä¸ªæ•°æ®ä¸­æ‰¾åˆ°åŸå§‹è®°å½•
                        const originalRow = tableData[rowIndex] || filteredData.find(r => r.po_line === poLine);
                        
                        selectedItemsForShipment.set(poLine, {
                            po: po,
                            pn: pn,
                            po_line: poLine,
                            id: originalRow ? (originalRow.id || '') : '',
                            qty: qty,
                            description: originalRow ? (originalRow.description || '') : '',
                            row_index: rowIndex,
                            original_row: originalRow
                        });
                    }
                } else {
                    // å¦‚æœcheckboxè¢«uncheckedï¼Œä»Mapä¸­ç§»é™¤
                    selectedItemsForShipment.delete(poLine);
                }
            });
            
            updateSelectedItemsDisplay();
        }
        
        // ä»é€‰æ‹©ä¸­ç§»é™¤ä¸€é¡¹
        function removeFromShipmentSelection(poLine) {
            selectedItemsForShipment.delete(poLine);
            
            // æ›´æ–°checkboxçŠ¶æ€
            const checkbox = document.querySelector(`.shipment-checkbox[data-po-line="${poLine}"]`);
            if (checkbox) {
                checkbox.checked = false;
            }
            
            updateSelectedItemsDisplay();
        }
        
        // æ‰“å¼€å…¨å±€å‘è´§æ¨¡æ€æ¡†
        function openGlobalShipmentModal() {
            if (selectedItemsForShipment.size === 0) {
                showStatus('Please select materials to ship', 'warning');
                return;
            }
            
            // æ¸…ç©ºæ¨¡æ€æ¡†å†…å®¹
            document.getElementById('globalTrackingNo').value = '';
            document.getElementById('globalShippingMode').value = '';
            document.getElementById('globalShippingCost').value = '';
            
            // ç”Ÿæˆç‰©æ–™å‘è´§é¡¹ç›®
            renderShipmentItems();
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modalElement = document.getElementById('globalShipmentModal');
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
        
        // æ¸²æŸ“ç‰©æ–™å‘è´§é¡¹ç›®
        function renderShipmentItems() {
            const container = document.getElementById('shipmentItemsContainer');
            container.innerHTML = '';
            
            selectedItemsForShipment.forEach((item, poLine) => {
                const description = item.description || 'æœªæä¾›';
                const description_preview = description.length > 100 ? description.substring(0, 100) + '...' : description;
                const maxQty = item.qty || 0;
                
                const itemHtml = `
                    <div class="card mb-2" style="border: 1px solid #e2e8f0;">
                        <div class="card-body" style="padding: 12px;">
                            <div class="row align-items-center" style="display: flex; flex-wrap: nowrap; gap: 5px;">
                                <div style="flex: 0 0 100px;">
                                    <label class="form-label" style="font-weight: 600; margin-bottom: 3px; font-size: 0.8rem;">PO/Line</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-weight: 500; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${poLine}</div>
                                </div>
                                <div style="flex: 1 1 auto; min-width: 250px;">
                                    <label class="form-label" style="font-weight: 600; margin-bottom: 3px; font-size: 0.8rem;">Description</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${description}">${description}</div>
                                </div>
                                <div style="flex: 0 0 100px;">
                                    <label class="form-label" style="font-size: 0.8rem; margin-bottom: 3px;">Max Qty</label>
                                    <div style="padding: 4px 5px; background: #f7fafc; border-radius: 3px; font-weight: 500; font-size: 0.8rem; text-align: right;">${maxQty}</div>
                                </div>
                                <div style="flex: 0 0 110px;">
                                    <label class="form-label" style="font-size: 0.8rem; margin-bottom: 3px; display: inline;">Shipment Qty</label><span class="text-danger" style="font-size: 0.8rem;">*</span>
                                    <input type="number" class="form-control form-control-sm shipment-qty-input" data-po-line="${poLine}" data-max-qty="${maxQty}" placeholder="0" step="0.01" min="0" value="${maxQty}" style="padding: 3px 5px; font-size: 0.8rem; height: 28px; margin-top: 2px;">
                                </div>
                                <div style="flex: 0 0 30px; display: flex; align-items: center; justify-content: center; height: 55px;">
                                    <button type="button" class="btn btn-sm" style="background: none; border: none; color: #f56565; cursor: pointer; font-size: 1.2rem; padding: 0; line-height: 1;" onclick="removeFromShipmentSelection('${poLine}')" title="Remove">âœ•</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += itemHtml;
            });
        }
        
        // ç¡®è®¤å…¨å±€å‘è´§
        function confirmGlobalShipment() {
            // éªŒè¯å¸¸è§„ä¿¡æ¯
            const trackingNo = document.getElementById('globalTrackingNo').value.trim();
            const shippingMode = document.getElementById('globalShippingMode').value.trim();
            const shippingCostStr = document.getElementById('globalShippingCost').value.trim();
            
            if (!trackingNo) {
                showStatus('Please enter tracking number', 'error');
                return;
            }
            
            if (!shippingMode) {
                showStatus('Please select shipping method', 'error');
                return;
            }
            
            if (!shippingCostStr || parseFloat(shippingCostStr) < 0) {
                showStatus('Please enter valid shipping cost', 'error');
                return;
            }
            
            // éªŒè¯å‘è´§æ•°é‡
            const qtyInputs = document.querySelectorAll('.shipment-qty-input');
            const shipmentData = [];
            let isValid = true;
            
            qtyInputs.forEach(input => {
                const poLine = input.getAttribute('data-po-line');
                const maxQty = parseFloat(input.getAttribute('data-max-qty'));
                const shipmentQty = parseFloat(input.value) || 0;
                
                if (shipmentQty <= 0) {
                    showStatus(`PO/Line ${poLine}: Please enter valid shipment quantity`, 'error');
                    isValid = false;
                    return;
                }
                
                if (shipmentQty > maxQty) {
                    showStatus(`PO/Line ${poLine}: Shipment quantity cannot exceed ${maxQty}`, 'error');
                    isValid = false;
                    return;
                }
                
                shipmentData.push({
                    po_line: poLine,
                    shipment_qty: shipmentQty
                });
            });
            
            if (!isValid || shipmentData.length === 0) {
                return;
            }
            
            // è§£æè¿è´¹æ•°å€¼ï¼ˆå»æ‰possibleçš„"shared:"å‰ç¼€ç”¨äºæ˜¾ç¤ºï¼Œä½†å®é™…å‘é€ç»™åç«¯æ—¶åˆ†ç¦»ï¼‰
            const shippingCostValue = parseFloat(shippingCostStr);
            const itemCount = selectedItemsForShipment.size;
            
            // ä¸ºè¿™ä¸€æ‰¹å‘è´§çš„æ‰€æœ‰ç‰©æ–™ç”Ÿæˆç»Ÿä¸€çš„batch_noï¼Œç¡®ä¿åŒä¸€æ‰¹å‘è´§çš„ç‰©æ–™æœ‰ç›¸åŒçš„shipment_batch_no
            const shipmentBatchNo = `SHIP-${new Date().toISOString().split('T')[0].replace(/-/g, '')}-${Math.random().toString(36).substring(2, 10).toUpperCase()}`;
            
            // å‘é€ä¸€ä¸ªä¸€ä¸ªçš„å‘è´§è¯·æ±‚
            showStatus('Processing shipment...', 'loading');
            
            const shipmentRequests = shipmentData.map(data => {
                const item = selectedItemsForShipment.get(data.po_line);
                return authenticatedFetch('/api/shipment/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        source_table: currentTable,
                        po: item.po,
                        pn: item.pn,
                        po_line: item.po_line,
                        shipment_qty: data.shipment_qty,
                        max_qty: item.qty,
                        tracking_no: trackingNo,
                        shipping_mode: shippingMode,
                        shipping_cost: shippingCostValue,
                        is_shared: itemCount > 1,
                        shipment_batch_no: shipmentBatchNo
                    })
                });
            });
            
            // æ‰§è¡Œæ‰€æœ‰è¯·æ±‚
            Promise.all(shipmentRequests)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å¤±è´¥
                    const hasError = results.some(r => !r.success);
                    
                    if (hasError) {
                        const errors = results.filter(r => !r.success).map(r => r.message).join('; ');
                        showStatus(`Shipment partially failed: ${errors}`, 'error');
                    } else {
                        showStatus('All materials have been shipped!', 'success');
                        
                        // å…³é—­modal
                        const modalElement = document.getElementById('globalShipmentModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                        
                        // é‡æ–°åŠ è½½è¡¨æ•°æ®
                        setTimeout(() => loadTableData(), 800);
                    }
                })
                .catch(error => {
                    showStatus(`Shipment failed: ${error}`, 'error');
                });
        }
        
        // è®¾ç½®å‘è´§ç¡®è®¤æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            const confirmGlobalShipmentBtn = document.getElementById('confirmGlobalShipmentBtn');
            if (confirmGlobalShipmentBtn) {
                confirmGlobalShipmentBtn.addEventListener('click', confirmGlobalShipment);
            }
        });

        // ä»è¡Œæ“ä½œä¸­åˆ é™¤è®°å½•
        function deleteRowRecord(key, tableName) {
            if (!key) {
                showStatus('Unable to get critical fields for record', 'error');
                return;
            }
            
            // æ ¹æ®è¡¨ç±»å‹ç¡®å®šè¦åˆ é™¤çš„å­—æ®µå
            const isOpenTable = (tableName === 'wf_open' || tableName === 'non_wf_open');
            const fieldName = isOpenTable ? 'po_line' : 'id';
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            showConfirmModal(`Are you sure you want to delete this record? This action cannot be undone.`, function() {
                showStatus('Deleting record...', 'loading');
                
                // ä½¿ç”¨ POST è¯·æ±‚ï¼Œä¼ é€’ key å’Œ key_field åœ¨è¯·æ±‚ä½“ä¸­
                authenticatedFetch(`/api/tables/${tableName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: key,
                        key_field: fieldName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record deleted successfully', 'success');
                        loadTableData(); // é‡æ–°åŠ è½½æ•°æ®
                    } else {
                        showStatus(`Delete failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Delete failed: ${error}`, 'error');
                });
            });
        }
        
        // åˆ é™¤è®°å½•
        function deleteRecord() {
            const pn = document.getElementById('deletePN').value.trim();
            
            if (!pn) {
                showStatus('è¯·è¾“å…¥è¦åˆ é™¤è®°å½•çš„PNå·', 'error');
                return;
            }
            
            // éªŒè¯PNå·æ ¼å¼ï¼ˆåº”è¯¥åŒ…å«è¿å­—ç¬¦ï¼‰
            if (!pn.includes('-')) {
                showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„PNå·æ ¼å¼ï¼ˆå¦‚ï¼š8942-9106-1100ï¼‰', 'error');
                return;
            }
            
            // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
            showConfirmModal(`Are you sure you want to delete the record with PN number ${pn}? This action cannot be undone.`, function() {
                showStatus('Deleting record...', 'loading');
                
                authenticatedFetch(`/api/tables/${currentTable}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: pn,
                        key_field: 'pn'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showStatus('Record deleted successfully', 'success');
                        document.getElementById('deletePN').value = '';
                        loadTableData(); // é‡æ–°åŠ è½½æ•°æ®
                    } else {
                        showStatus(`Delete failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    showStatus(`Delete failed: ${error}`, 'error');
                });
            });
        }
        
        // æ‰“å¼€é€€è´§Modal
        function openReturnShipmentModal(poLine, description, shipmentQty, closedTable, recordId) {
            try {
                // è½¬æ¢recordIdä¸ºæ•°å­—ï¼Œä»¥æ­£ç¡®åŒ¹é…æ•°æ®åº“ä¸­id
                const recordIdNum = parseInt(recordId);
                
                console.log('[DEBUG] openReturnShipmentModal called with recordId:', recordId, 'parsed:', recordIdNum);
                
                const currentRow = tableData.find(row => row.id === recordIdNum);
                if (!currentRow) {
                    console.error('[ERROR] Unable to find record with id:', recordIdNum);
                    console.log('[DEBUG] tableData length:', tableData.length, 'first few ids:', tableData.slice(0, 5).map(r => r.id));
                    showStatus('Unable to get record information', 'error');
                    return;
                }
                
                // è®¾ç½®é€€è´§Modalçš„å€¼
                document.getElementById('returnPoLine').value = poLine;
                document.getElementById('returnDescription').value = description;
                document.getElementById('returnQty').value = shipmentQty;  // é»˜è®¤å¡«å…¥æœ€å¤§æ•°é‡
                document.getElementById('returnMaxQty').value = shipmentQty;
                document.getElementById('newBatchShippingCost').value = currentRow.shipping_cost || '';
                document.getElementById('updateBatchShippingCost').checked = false;
                document.getElementById('updateShippingCostContainer').style.display = 'none';
                
                // ä¸ºModalä¸åæ”¹å˜é‡ï¼Œä¾›é€€è´§ä½¿ç”¨
                document.getElementById('returnShipmentModal').dataset.closedTable = closedTable;
                document.getElementById('returnShipmentModal').dataset.recordId = recordId;
                document.getElementById('returnShipmentModal').dataset.shipmentBatchNo = currentRow.shipment_batch_no || '';
                
                console.log('[DEBUG] Set modal dataset:', {
                    closedTable: closedTable,
                    recordId: recordId,
                    shipmentBatchNo: currentRow.shipment_batch_no
                });
                
                // è‡ªåŠ¨åŠ è½½åŒä¸€æ‰¹å‘è´§å·çš„å…¶ä»–ç‰©æ–™
                const shipmentBatchNo = currentRow.shipment_batch_no;
                if (shipmentBatchNo) {
                    const batchItems = tableData.filter(row => row.shipment_batch_no === shipmentBatchNo && row.id !== recordId);
                    let infoText = `Shipping Cost: $${currentRow.shipping_cost || 'N/A'}`;
                    if (batchItems.length > 0) {
                        infoText += `<br><br><strong>Other materials in this batch:</strong><ul>`;
                        batchItems.forEach(item => {
                            infoText += `<li>${item.po_line}: ${item.description} (Qty: ${item.qty}, Cost: $${item.shipping_cost})</li>`;
                        });
                        infoText += `</ul>`;
                    }
                    document.getElementById('batchShippingCostInfo').innerHTML = infoText;
                } else {
                    document.getElementById('batchShippingCostInfo').innerHTML = `Shipping Cost: $${currentRow.shipping_cost || 'N/A'}`;
                }
                
                // æ˜¾ç¤º Modal
                const modalElement = document.getElementById('returnShipmentModal');
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            } catch (error) {
                console.error('[ERROR] Exception in openReturnShipmentModal:', error);
                showStatus('Error opening return modal: ' + error.message, 'error');
            }
        }
        
        // ç¡®è®¤é€€è´§
        function confirmReturnShipment() {
            const returnQtyStr = document.getElementById('returnQty').value.trim();
            const maxQty = parseFloat(document.getElementById('returnMaxQty').value) || 0;
            const closedTable = document.getElementById('returnShipmentModal').dataset.closedTable;
            const recordId = document.getElementById('returnShipmentModal').dataset.recordId; // ä¼šä»¥ä¸€ä¸ªå­—ç¬¦ä¸²çš„å½¢å¼return
            const shipmentBatchNo = document.getElementById('returnShipmentModal').dataset.shipmentBatchNo;
            const shouldUpdateBatchShippingCost = document.getElementById('updateBatchShippingCost').checked;
            
            console.log('[DEBUG] confirmReturnShipment called with:', {
                closedTable: closedTable,
                recordId: recordId,
                shipmentBatchNo: shipmentBatchNo,
                shouldUpdateBatchShippingCost: shouldUpdateBatchShippingCost
            });
            
            // éªŒè¯é€€è´§æ•°é‡
            if (!returnQtyStr || returnQtyStr === '') {
                showStatus('Please enter return quantity', 'error');
                return;
            }
            
            const returnQty = parseFloat(returnQtyStr);
            if (isNaN(returnQty) || returnQty <= 0) {
                showStatus('Return quantity must be greater than 0', 'error');
                return;
            }
            
            if (returnQty > maxQty) {
                showStatus(`Return quantity cannot exceed available quantity (${maxQty})`, 'error');
                return;
            }
            
            let newShippingCost = null;
            if (shouldUpdateBatchShippingCost) {
                const newShippingCostStr = document.getElementById('newBatchShippingCost').value.trim();
                if (!newShippingCostStr) {
                    showStatus('Please enter new shipping cost for batch', 'error');
                    return;
                }
                newShippingCost = parseFloat(newShippingCostStr);
                if (isNaN(newShippingCost) || newShippingCost < 0) {
                    showStatus('Shipping cost must be a valid number >= 0', 'error');
                    return;
                }
            }
            
            // å‘é€é€€è´§è¯·æ±‚
            showStatus('Processing return shipment...', 'loading');
            
            const userEmail = localStorage.getItem('userEmail') || 'unknown@example.com';
            
            const requestData = {
                closed_table: closedTable,
                record_id: recordId,
                return_qty: returnQty,
                new_shipping_cost: newShippingCost,
                shipment_batch_no: shipmentBatchNo
            };
            
            console.log('[DEBUG] Sending return shipment request:', requestData);
            
            authenticatedFetch('/api/shipment/return', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-User-Email': userEmail
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showStatus('Return shipment processed successfully!', 'success');
                    
                    // å…³é—­Modal
                    const modalElement = document.getElementById('returnShipmentModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // é‡æ–°åŠ è½½è¡¨æ•°æ®
                    setTimeout(() => loadTableData(), 800);
                } else {
                    showStatus(`Return failed: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showStatus(`Return failed: ${error}`, 'error');
            });
        }
        
        // é€€è´§æ¨¡æ€æ¡†ä¸­æ›´æ–°è¿è´¹Checkboxçš„äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const updateBatchShippingCostCheckbox = document.getElementById('updateBatchShippingCost');
            if (updateBatchShippingCostCheckbox) {
                updateBatchShippingCostCheckbox.addEventListener('change', function() {
                    const container = document.getElementById('updateShippingCostContainer');
                    container.style.display = this.checked ? 'block' : 'none';
                });
            }
            
            const confirmReturnBtn = document.getElementById('confirmReturnBtn');
            if (confirmReturnBtn) {
                confirmReturnBtn.addEventListener('click', confirmReturnShipment);
            }
        });
        
        function updateRecordCount() {
            const countElement = document.getElementById('recordCount');
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, filteredData.length);
            countElement.textContent = `Showing records ${startIndex}-${endIndex}, Total: ${filteredData.length}`;
        }
        
        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            
            // Hide pagination if only one page or no data
            if (totalPages <= 1) {
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }
            
            let paginationHtml = `
                <nav aria-label="Pagination Navigation">
                    <ul class="pagination justify-content-center">
            `;
            
            // Previous page button
            if (currentPage > 1) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">Previous</span>
                    </li>
                `;
            }
            
            // Page number buttons
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, currentPage + 2);
            
            // Ensure always showing 5 page buttons (if possible)
            if (endPage - startPage < 4) {
                if (startPage === 1) {
                    endPage = Math.min(totalPages, startPage + 4);
                } else {
                    startPage = Math.max(1, endPage - 4);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                if (i === currentPage) {
                    paginationHtml += `
                        <li class="page-item active">
                            <span class="page-link">${i}</span>
                        </li>
                    `;
                } else {
                    paginationHtml += `
                        <li class="page-item">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `;
                }
            }
            
            // Next page button
            if (currentPage < totalPages) {
                paginationHtml += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>
                    </li>
                `;
            } else {
                paginationHtml += `
                    <li class="page-item disabled">
                        <span class="page-link">Next</span>
                    </li>
                `;
            }
            
            paginationHtml += `
                    </ul>
                </nav>
            `;
            
            document.getElementById('paginationContainer').innerHTML = paginationHtml;
        }
        
        // åˆ‡æ¢é¡µé¢
        function changePage(pageNumber) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            if (pageNumber >= 1 && pageNumber <= totalPages) {
                currentPage = pageNumber;
                renderTableBody();
                updateRecordCount();
                renderPagination();
            }
        }
        
        // Update table title
        function updateTableTitle() {
            const titleMap = {
                'wf_open': 'WF Open',
                'wf_closed': 'WF Closed',
                'non_wf_open': 'Non-WF Open',
                'non_wf_closed': 'Non-WF Closed'
            };
            
            const titleElement = document.getElementById('tableTitle');
            titleElement.textContent = `${titleMap[currentTable] || currentTable} Table Data`;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message ${type}`;
            statusElement.style.display = 'block';
        }
        
        // éšè—çŠ¶æ€æ¶ˆæ¯
        function hideStatus() {
            const statusElement = document.getElementById('statusMessage');
            statusElement.style.display = 'none';
        }
        
        // æ‰¹é‡ä¿®æ”¹ç›¸å…³å˜é‡
        let selectedRowsForBatchUpdate = new Set();
        
        // æ‰“å¼€æ‰¹é‡ä¿®æ”¹æ¨¡æ€æ¡†
        function openBatchUpdateModal() {
            // è·å–å·²é€‰æ‹©çš„æ•´è¡Œ
            const selectedRows = Array.from(selectedItemsForShipment.values());
            
            if (selectedRows.length === 0) {
                showStatus('è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„è®°å½•', 'warning');
                return;
            }
            
            selectedRowsForBatchUpdate = new Set(selectedRows.map(r => r.po_line));
            document.getElementById('batchUpdateCount').textContent = selectedRows.length;
            
            // æ ¹æ®è¡¨åæä¾›å¹¸å­—æ®µ
            const fieldsContainer = document.getElementById('batchUpdateFields');
            fieldsContainer.innerHTML = '';
            
            let batchUpdateFields = [];
            
            if (currentTable === 'wf_open' || currentTable === 'wf_closed') {
                batchUpdateFields = ['eta_wfsz', 'record_no', 'wfsz_shipping_mode', 'shipping_cost', 'tracking_no'];
            } else if (currentTable === 'non_wf_open' || currentTable === 'non_wf_closed') {
                batchUpdateFields = ['eta_wfsz', 'record_no', 'shipping_mode', 'shipping_cost', 'tracking_no'];
            }
            
            // ç”Ÿæˆè¾“å…¥å­—æ®µ
            batchUpdateFields.forEach(field => {
                const fieldLabel = getColumnDisplayName(field);
                const colDiv = document.createElement('div');
                colDiv.className = 'col-md-6';
                
                if (field === 'eta_wfsz') {
                    // æ—¥å†é€‰æ‹©å™¨
                    colDiv.innerHTML = `
                        <label class="form-label">${fieldLabel}</label>
                        <input type="date" class="form-control" id="batch_${field}" data-field="${field}">
                    `;
                } else if (field === 'wfsz_shipping_mode' || field === 'shipping_mode') {
                    // ä¸‹æ‹‰é€‰æ‹©å™¨
                    colDiv.innerHTML = `
                        <label class="form-label">${fieldLabel}</label>
                        <select class="form-select" id="batch_${field}" data-field="${field}">
                            <option value="">-- No Change --</option>
                            <option value="sea">Sea</option>
                            <option value="air">Air</option>
                            <option value="train">Train</option>
                            <option value="truck">Truck</option>
                        </select>
                    `;
                } else {
                    // æ–‡æœ¬æˆ–æ•°å­—è¾“å…¥
                    const inputType = field === 'shipping_cost' ? 'number' : 'text';
                    const step = field === 'shipping_cost' ? 'step="0.01"' : '';
                    colDiv.innerHTML = `
                        <label class="form-label">${fieldLabel}</label>
                        <input type="${inputType}" class="form-control" id="batch_${field}" data-field="${field}" ${step}>
                    `;
                }
                
                fieldsContainer.appendChild(colDiv);
            });
            
            // æ‰“å¼€Modal
            const modal = new bootstrap.Modal(document.getElementById('batchUpdateModal'));
            modal.show();
        }
        
        // ç¡®è®¤æ‰¹é‡ä¿®æ”¹
        document.getElementById('confirmBatchUpdateBtn')?.addEventListener('click', function() {
            const updates = {};
            let hasChanges = false;
            
            // æ”¶é›†ä¸€ä¸ªæ¯ä¸€è¾“å…¥å­—æ®µçš„å€¼
            const inputFields = document.querySelectorAll('#batchUpdateFields [data-field]');
            inputFields.forEach(field => {
                const fieldName = field.getAttribute('data-field');
                const value = field.value;
                
                if (value !== '' && value !== null) {
                    updates[fieldName] = value;
                    hasChanges = true;
                }
            });
            
            if (!hasChanges) {
                showStatus('è¯·è‡³å°‘è¾“å…¥ä¸€ä¸ªä¿®æ”¹å€¼', 'warning');
                return;
            }
            
            // æ‰¹é‡ä¿®æ”¹æ•´è¡Œ
            const selectedRows = Array.from(selectedItemsForShipment.values());
            const updatePromises = selectedRows.map(row => {
                // æ ¹æ®è¡¨ç±»å‹é‡‡ç”¨ä¸åŒçš„ä¸»é”®: closedè¡¨ä½¿ç”¨idï¼Œopenè¡¨ä½¿ç”¨po_line
                const isClosedTable = (currentTable === 'wf_closed' || currentTable === 'non_wf_closed');
                const keyValue = isClosedTable ? row.id : row.po_line;
                            
                return authenticatedFetch(`/api/tables/${currentTable}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        key: keyValue,
                        ...updates
                    })
                }).then(response => response.json());
            });
            
            showStatus('æ­£åœ¨ä¿®æ”¹...', 'loading');
            
            Promise.all(updatePromises)
                .then(results => {
                    const hasError = results.some(r => !r.success);
                    
                    if (hasError) {
                        const errors = results.filter(r => !r.success).map(r => r.message).join('; ');
                        showStatus(`éƒ¨åˆ†ä¿®æ”¹å¤±è´¥: ${errors}`, 'error');
                    } else {
                        showStatus('å…¨éƒ¨è®°å½•äº‹æ”¹æˆåŠŸï¼', 'success');
                        
                        // å…³é—­Modal
                        const modalElement = document.getElementById('batchUpdateModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                        
                        // é‡æ–°åŠ è½½è¡¨æ•°æ®
                        setTimeout(() => loadTableData(), 800);
                    }
                })
                .catch(error => {
                    showStatus(`ä¿®æ”¹å¤±è´¥: ${error}`, 'error');
                });
        });
    </script>
</body>
</html>

